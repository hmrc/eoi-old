
Option Compare Database   'Use database order for string comparisons

            '''''''''''''''''''''''''''''''''''''''''
            ' AUTHOR : JASON CORDEY - I.T.S.A. 1995 '
            '''''''''''''''''''''''''''''''''''''''''

Option Explicit
Global Earnings As Double
Global AdjustedMinimumFlag As Integer

Private Const cstrAll_RECORDS_PROCESSED = "All the records processed"

Public Function bRepeatButton(Taxyear As Integer) As Integer
            '''''''''''''''''''''''''''''''''''''''''
            ' AUTHOR : JASON CORDEY - I.T.S.A. 1995 '
            '''''''''''''''''''''''''''''''''''''''''
' Modified History  :
' Author            : Mustaq Hussain
' Date              : 9 January 1996
' Reason            : RFC 269 : 4 Weekly period
' Author            : Mustaq Hussain
' Date              : 13 February 1996
' Reason            : RFC 269 : 4 Weekly period, limit to 13 and as a function returning true or false and extra validation of periods
' Author            : Christopher Schuler
' Date              : 14 November 2000
' Reason            : Option added for 2001

On Error GoTo Err_bRepeatButton

Dim DB As Database
Dim DataTable As DAO.Recordset
Dim DataTableClone As DAO.Recordset
Dim PrevControl As Control
Dim test_number As Integer
Dim i As Integer

Set PrevControl = Screen.PreviousControl

DoCmd.Hourglass True


'Assume corect
bRepeatButton = True

Set DB = CurrentDb()

If Taxyear = 2000 Then
    Set DataTable = DB.OpenRecordset("tblContributions2000")
ElseIf Taxyear > 2015 Then
    Set DataTable = DB.OpenRecordset("tblContributions2016")
ElseIf Taxyear > 2008 Then 'And taxyear < 2015 Then
    Set DataTable = DB.OpenRecordset("tblContributions2009")
Else
    Set DataTable = DB.OpenRecordset("tblContributions2001")
End If
i = 1
Do Until DataTable.EOF
    DataTable.Edit
    DataTable![Period Number] = i
    i = i + 1
    DataTable.Update
    DataTable.MoveNext
Loop
    
Set DataTableClone = DataTable.Clone()

' If no records at all, then quit.
If DataTable.BOF And DataTable.EOF Then
    MsgBox "No last record to copy.", 48, "Information"
    PrevControl.SetFocus
    
    bRepeatButton = False
    GoTo Exit_bRepeatButton

Else
    DataTable.MoveLast
    
    
    If ((DataTable![Period] = "M") And (DataTable![Period Number] >= 12)) Or _
       ((DataTable![Period] = "M") And (DataTable.Recordcount > 12)) Or _
       ((DataTable![Period] = "W") And (DataTable![Period Number] >= 53)) Or _
       ((DataTable![Period] = "W") And (DataTable.Recordcount > 53)) Or _
       ((DataTable![Period] = "4W") And (DataTable![Period Number] >= 13)) Or _
       ((DataTable![Period] = "4W") And (DataTable.Recordcount > 13)) Then
        
        MsgBox IIf(DataTable![Period] = "M", "Month", IIf(DataTable![Period] = "4W", "4 Weekly", "Week")) & _
               " number out of range", 48, "Information"
        DoCmd.Hourglass False
        bRepeatButton = False
        GoTo Exit_bRepeatButton
    Else
        DataTableClone.MoveLast
        With DataTableClone
            .AddNew
            ![Period] = DataTable![Period]
            ![Period Number] = DataTable![Period Number] + 1
            ![Category] = DataTable![Category]
            ![Gross Pay] = DataTable![Gross Pay]
            ![Tables Used] = DataTable![Tables Used]
            .Update
        
            ' Close both references.
            DataTableClone.Close
        End With
        DataTable.Close
        DB.Close

    End If

End If

Exit_bRepeatButton:
    DoCmd.Hourglass False
    PrevControl.SetFocus
    Exit Function

Err_bRepeatButton:
    MsgBox Error$
    Resume Exit_bRepeatButton

End Function

Public Function b2001NICalc(Taxyear As Integer, Category)
' Author            : Christopher Schuler
' Date              : 14 November 2000
' Purpose           : To calculate NI contributions from 2001
' Author            : Christopher Schuler
' Date              : 17 December 2002
' Purpose           : Amend for 2003 (net conts calculated)
' Author            : Christopher Sneddon
' Date              : 12 December 2014
' Purpose           : CCA10930

    On Error GoTo Err_b2001NICalc
    DoCmd.Hourglass True
    
    Dim PrevControl As Control
    Set PrevControl = Screen.PreviousControl
    
    Dim DB As Database
    Dim DataTable As DAO.Recordset
    Dim DataTableClone As DAO.Recordset

    Dim LEL
    Dim ST
    Dim ET_PT
    Dim UAP
    Dim AUST
    Dim UST 'CCA10930
    Dim UEL
    Dim Balance     ' Difference between EEconts and EENIRebate when primary conts are less than primary rebate
    Dim wkResult
    Dim status
    
    ' Assume the calc when O.K.
    b2001NICalc = True
    
    Set DB = CurrentDb()
    
    If Taxyear > 2015 Then
        Set DataTable = DB.OpenRecordset("tblContributions2016")
    ElseIf Taxyear > 2008 Then
        Set DataTable = DB.OpenRecordset("tblContributions2009")
    'ElseIf taxyear > 2014 Then
    '    Set DataTable = DB.OpenRecordset("tblContributions2015")
    Else
        Set DataTable = DB.OpenRecordset("tblContributions2001")
    End If
   
    Set DataTableClone = DataTable.Clone()

    ' If no records at all, then quit.
    ' Carry out the calculations
    If DataTable.BOF And DataTable.EOF Then
        MsgBox "No entries in table.", 48, "Information"
        ' Close both references.
        DataTableClone.Close
        DataTable.Close
        DB.Close

        b2001NICalc = False
        GoTo Exit_b2001NICalc
    End If
    
    ' Validate entries in row
    DataTable.MoveFirst
    Do Until DataTable.EOF
        If ((DataTable![Period] = "M") And (DataTable![Period Number] > 12)) Or _
           ((DataTable![Period] = "W") And (DataTable![Period Number] > 53)) Or _
           ((DataTable![Period] = "4W") And (DataTable![Period Number] > 13)) Then
           
            MsgBox IIf(DataTable![Period] = "M", "Month", IIf(DataTable![Period] = "4W", "4 Weekly", "Week")) & _
                   " number out of range", 48, "Information"
            DataTableClone.Close
            DataTable.Close
            DB.Close

            b2001NICalc = False
            GoTo Exit_b2001NICalc
        End If
        
        If IsNull(DataTable![Category]) Or DataTable![Category] = "" Then
            MsgBox "Category not set", 48, "Information"
            DataTableClone.Close
            DataTable.Close
            DB.Close

            b2001NICalc = False
            GoTo Exit_b2001NICalc
        End If
        DataTable.MoveNext
    Loop


    ' Get the appropriate threshold values for the selected period type
    DataTable.MoveLast
    Do Until DataTable.EOF Or DataTable.BOF

        ' Use the index to locate the year.
        NIRateBandTable.Index = "PrimaryKey"
        NIRateBandTable.Seek "=", Taxyear
        
        ' If the year is not found.
        If NIRateBandTable.NoMatch Then
            Exit Function
        Else
            Select Case UCase$(DataTable![Period])
            Case "W"
                ' Set the global bands.
                If Taxyear > 2010 Then
                    ET_PT = NIRateBandTable![WkPT]
                    ST = NIRateBandTable![WkST]
                Else
                    ET_PT = NIRateBandTable![WkER_ET]
                End If
                
                If Taxyear > 2008 Then
                    UAP = NIRateBandTable![wkUAP]
                End If
                
                LEL = NIRateBandTable![WkLEL]
                If Taxyear > 2014 Then
                    UST = NIRateBandTable![wkUST]
                End If
                UEL = NIRateBandTable![WkUEL]
                            
            Case "M"
                ' Set the global bands.
                If Taxyear > 2010 Then
                    ET_PT = NIRateBandTable![MnthPT]
                    ST = NIRateBandTable![MnthST]
                Else
                    ET_PT = NIRateBandTable![MnthER_ET]
                End If
                
                If Taxyear > 2008 Then
                   UAP = NIRateBandTable![MnthUAP]
                End If
                
                LEL = NIRateBandTable![MnthLEL]
                If Taxyear > 2014 Then
                    UST = NIRateBandTable![MnthUST]
                End If
                If Taxyear > 2015 Then
                    AUST = NIRateBandTable![MnthAUST]
                End If
                UEL = NIRateBandTable![MnthUEL]
                 
            Case "4W"
                ' Set the global bands.
                If DataTable![Tables Used] = "no" Then
                    If Taxyear > 2010 Then
                        ET_PT = NIRateBandTable![AnnPT] / 13
                        ST = NIRateBandTable![AnnST] / 13
                        
                        ' Round up ST
                        If ST > Int(ST) Then
                            ST = Int(ST) + 1
                        End If
                    Else
                        ET_PT = NIRateBandTable![AnnER_ET] / 13
                    End If
                    
                    If Taxyear > 2008 Then
                        UAP = NIRateBandTable![AnnUAP] / 13
                    End If
                    
                    LEL = NIRateBandTable![AnnLEL] / 13
                    If Taxyear > 2014 Then
                        UST = NIRateBandTable![AnnUST] / 13
                    End If
                    UEL = NIRateBandTable![AnnUEL] / 13
    
                    'No stepincrement as weekly rate is used in "tables" method
                    'Round up ET_PT
                    If ET_PT > Int(ET_PT) Then
                       ET_PT = Int(ET_PT) + 1
                    End If
                    If UEL > Int(UEL) Then
                       UEL = Int(UEL) + 1
                    End If
                Else
                    If Taxyear > 2010 Then
                        ET_PT = NIRateBandTable![WkPT]
                        ST = NIRateBandTable![WkST]
                        
                        ' Round up threshold values
                        If ST > Int(ST) Then
                            ST = Int(ST) + 1
                        End If
                        
                        If ET_PT > Int(ET_PT) Then
                            ET_PT = Int(ET_PT) + 1
                        End If
                    Else
                        ET_PT = NIRateBandTable![WkER_ET]
                    End If
                    
                    If Taxyear > 2008 Then
                        UAP = NIRateBandTable![wkUAP]
                    End If
                    
                    LEL = NIRateBandTable![WkLEL]
                    If Taxyear > 2014 Then
                        UST = NIRateBandTable![wkUST]
                    End If
                    UEL = NIRateBandTable![WkUEL]
                End If
        
            Case Else
                Exit Function
                
            End Select
        End If
        
        
        ' Dealing with ST-PT changes - CSNE
        If Taxyear > 2010 Then
            'do nowt
        
        ElseIf Taxyear > 2008 And Taxyear < 2011 Then
            'set values to 0
            ST = 0
        
        ElseIf Taxyear < 2009 Then
            ST = 0
            UAP = 0
            UST = 0
        
        End If
        ' If the period is 4weeks then process as 4 seperate week calcs
        ' and use the Table method.
        If (DataTable![Period] = "4W") And (DataTable![Tables Used] = "Yes") Then
            status = FourWeekTableCalc(DataTable, _
                                       DataTableClone, _
                                       LEL, _
                                       ST, _
                                       ET_PT, _
                                       UAP, _
                                       UST, _
                                       UEL, _
                                       Taxyear)
            
            If status = False Then
                GoTo Err_b2001NICalc
            End If
        Else
            ' Else if Period is not 4Weeks and we are not using the table method
            ' Update table entries
            status = WeekOrMonthCalc(DataTable, _
                                     DataTableClone, _
                                     LEL, _
                                     ST, _
                                     ET_PT, _
                                     UAP, _
                                     UST, _
                                     UEL, _
                                     Category, _
                                     Taxyear)
            
            If status = False Then
                GoTo Err_b2001NICalc
            End If
        End If
        
    Loop ' Do until Table.EOF/BOF

    ' Put back records in correct order
    DataTable.MoveLast
    Do Until DataTable.BOF
        With DataTableClone
            .AddNew
            
            ![Period] = DataTable![Period]
            ![Period Number] = DataTable![Period Number]
            ![Category] = DataTable![Category]
            ![Gross Pay] = DataTable![Gross Pay]
            ![Tables Used] = DataTable![Tables Used]
            
            ![UpToLEL] = DataTable![UpToLEL]
            ![LELtoET] = DataTable![LELtoET]
            
            If Taxyear > 2008 Then ' CSNE 23/02/2009
                'If ST > ET_PT Then
                '![ETtoUAP] = DataTable![STToUAP]
                'Else
                ![ETtoUAP] = DataTable![ETtoUAP]
                'End If

                ![UAPToUEL] = DataTable![UAPToUEL]
            Else
                ![ETtoUEL] = DataTable![ETtoUEL]
            End If
                
            ![EEConts] = DataTable![EEConts]
            ![ERConts] = DataTable![ERConts]
            ![TotalConts] = DataTable![TotalConts]
            ![EENIRebate] = DataTable![EENIRebate]
            ![ERNIRebate] = DataTable![ERNIRebate]
            
            If Taxyear > 2002 And Taxyear < 2009 Then
                
                ![EEConts2003] = DataTable![EEConts2003]
                ![ERConts2003] = DataTable![ERConts2003]
                ![TotalConts2003] = DataTable![TotalConts2003]
                ![Refund] = DataTable![Refund]
                
            ElseIf Taxyear > 2008 Then 'csne
                ![EEConts2009] = DataTable![EEConts2009]
                ![ERConts2009] = DataTable![ERConts2009]
                ![TotalConts2009] = DataTable![TotalConts2009]
                ![Refund] = DataTable![Refund]
            End If
            
            .Update
        End With
        DataTable.Delete
        DataTable.MovePrevious
    Loop

    ' Close both references.
    DataTableClone.Close
    DataTable.Close
    DB.Close
    
 
Exit_b2001NICalc:
    DoCmd.Hourglass False
    PrevControl.SetFocus
    Exit Function

Err_b2001NICalc:
    
    MsgBox Error$ & " in b2001NICalc"
    Resume Exit_b2001NICalc

End Function

Public Function b2016NICalc(Taxyear As Integer, Category)
' Author            : Christopher Sneddon
' Date              : 13 October 2015
' Purpose           : To calculate NI contributions from 2016


    On Error GoTo Err_b2016NICalc
    DoCmd.Hourglass True
    
    Dim PrevControl As Control
    Set PrevControl = Screen.PreviousControl
    
    Dim DB As Database
    Dim DataTable As DAO.Recordset
    Dim DataTableClone As DAO.Recordset

    Dim LEL
    Dim ST
    Dim ET_PT
    Dim AUST
    Dim UST 'CCA10930
    Dim UEL
    Dim Balance     ' Difference between EEconts and EENIRebate when primary conts are less than primary rebate
    Dim wkResult
    Dim status
    
    ' Assume the calc when O.K.
    b2016NICalc = True
    
    Set DB = CurrentDb()
    Set DataTable = DB.OpenRecordset("tblContributions2016")
    Set DataTableClone = DataTable.Clone()

    ' If no records at all, then quit.
    ' Carry out the calculations
    If DataTable.BOF And DataTable.EOF Then
        MsgBox "No entries in table.", 48, "Information"
        ' Close both references.
        DataTableClone.Close
        DataTable.Close
        DB.Close

        b2016NICalc = False
        GoTo Exit_b2016NICalc
    End If
    
    ' Validate entries in row
    DataTable.MoveFirst
    Do Until DataTable.EOF
        If ((DataTable![Period] = "M") And (DataTable![Period Number] > 12)) Or _
           ((DataTable![Period] = "W") And (DataTable![Period Number] > 53)) Or _
           ((DataTable![Period] = "4W") And (DataTable![Period Number] > 13)) Then
           
            MsgBox IIf(DataTable![Period] = "M", "Month", IIf(DataTable![Period] = "4W", "4 Weekly", "Week")) & _
                   " number out of range", 48, "Information"
            DataTableClone.Close
            DataTable.Close
            DB.Close

            b2016NICalc = False
            GoTo Exit_b2016NICalc
        End If
        
        If IsNull(DataTable![Category]) Or DataTable![Category] = "" Then
            MsgBox "Category not set", 48, "Information"
            DataTableClone.Close
            DataTable.Close
            DB.Close

            b2016NICalc = False
            GoTo Exit_b2016NICalc
        End If
        DataTable.MoveNext
    Loop


    ' Get the appropriate threshold values for the selected period type
    DataTable.MoveLast
    Do Until DataTable.EOF Or DataTable.BOF

        ' Use the index to locate the year.
        NIRateBandTable.Index = "PrimaryKey"
        NIRateBandTable.Seek "=", Taxyear
        
        ' If the year is not found.
        If NIRateBandTable.NoMatch Then
            Exit Function
        Else
            Select Case UCase$(DataTable![Period])
            Case "W"
                ' Set the global bands.
                    ET_PT = NIRateBandTable![WkPT]
                    ST = NIRateBandTable![WkST]
                    LEL = NIRateBandTable![WkLEL]
                    UST = NIRateBandTable![wkUST]
                    AUST = NIRateBandTable![wkAUST]
                    UEL = NIRateBandTable![WkUEL]
                            
            Case "M"
                ' Set the global bands.
                    ET_PT = NIRateBandTable![MnthPT]
                    ST = NIRateBandTable![MnthST]
                    LEL = NIRateBandTable![MnthLEL]
                    UST = NIRateBandTable![MnthUST]
                    AUST = NIRateBandTable![MnthAUST]
                    UEL = NIRateBandTable![MnthUEL]
                 
            Case "4W"
                ' Set the global bands.
                If DataTable![Tables Used] = "no" Then
                        ET_PT = NIRateBandTable![AnnPT] / 13
                        ST = NIRateBandTable![AnnST] / 13
                            ' Round up ST
                            If ST > Int(ST) Then
                                ST = Int(ST) + 1
                            End If
                        LEL = NIRateBandTable![AnnLEL] / 13
                        UST = NIRateBandTable![AnnUST] / 13
                        AUST = NIRateBandTable![AnnAUST] / 13
                        UEL = NIRateBandTable![AnnUEL] / 13
    
                            'No stepincrement as weekly rate is used in "tables" method
                            'Round up ET_PT
                            If ET_PT > Int(ET_PT) Then
                                ET_PT = Int(ET_PT) + 1
                            End If
                            
                            If UEL > Int(UEL) Then
                                UEL = Int(UEL) + 1
                            End If
                Else
                        ET_PT = NIRateBandTable![WkPT]
                        ST = NIRateBandTable![WkST]
                        
                            ' Round up threshold values
                            If ST > Int(ST) Then
                                ST = Int(ST) + 1
                            End If
                        
                            If ET_PT > Int(ET_PT) Then
                                ET_PT = Int(ET_PT) + 1
                            End If
                    
                        LEL = NIRateBandTable![WkLEL]
                        UST = NIRateBandTable![wkUST]
                        AUST = NIRateBandTable![wkAUST]
                        UEL = NIRateBandTable![WkUEL]
                End If
        
            Case Else
                Exit Function
                
            End Select
        End If
        
        ' If the period is 4weeks then process as 4 seperate week calcs
        ' and use the Table method.
        If (DataTable![Period] = "4W") And (DataTable![Tables Used] = "Yes") Then
            status = FourWeekTableCalc16(DataTable, _
                                       DataTableClone, _
                                       LEL, _
                                       ST, _
                                       ET_PT, _
                                       AUST, _
                                       UST, _
                                       UEL, _
                                       Taxyear)
            
            If status = False Then
                GoTo Err_b2016NICalc
            End If
        Else
            ' Else if Period is not 4Weeks and we are not using the table method
            ' Update table entries
            status = WeekOrMonthCalc16(DataTable, _
                                     DataTableClone, _
                                     LEL, _
                                     ST, _
                                     ET_PT, _
                                     AUST, _
                                     UST, _
                                     UEL, _
                                     Category, _
                                     Taxyear)
            
            If status = False Then
                GoTo Err_b2016NICalc
            End If
        End If
        
    Loop ' Do until Table.EOF/BOF

    ' Put back records in correct order
    DataTable.MoveLast
    Do Until DataTable.BOF
        With DataTableClone
            .AddNew
            
            ![Period] = DataTable![Period]
            ![Period Number] = DataTable![Period Number]
            ![Category] = DataTable![Category]
            ![Gross Pay] = DataTable![Gross Pay]
            ![Tables Used] = DataTable![Tables Used]
            
            ![UpToLEL] = DataTable![UpToLEL]
            ![LELtoET] = DataTable![LELtoET]
            ![ETtoUEL] = DataTable![ETtoUEL]
            ![ETtoUEL] = DataTable![ETToUST]
            ![ETtoUEL] = DataTable![ETToAUST]
            ![EEConts] = DataTable![EEConts]
            ![ERConts] = DataTable![ERConts]
            ![TotalConts] = DataTable![TotalConts]
            ![EENIRebate] = DataTable![EENIRebate]
            ![ERNIRebate] = DataTable![ERNIRebate]
            ![EEConts2009] = DataTable![EEConts2009]
            ![ERConts2009] = DataTable![ERConts2009]
            ![TotalConts2009] = DataTable![TotalConts2009]

            
            .Update
        End With
        DataTable.Delete
        DataTable.MovePrevious
    Loop

    ' Close both references.
    DataTableClone.Close
    DataTable.Close
    DB.Close
    
 
Exit_b2016NICalc:
    DoCmd.Hourglass False
    PrevControl.SetFocus
    Exit Function

Err_b2016NICalc:
    
    MsgBox Error$ & " in b2016NICalc"
    Resume Exit_b2016NICalc

End Function

Private Function WeekOrMonthCalc(ByRef DataTable, _
                                 ByRef DataTableClone, _
                                 ByRef LEL, _
                                 ByRef ST, _
                                 ByRef ET_PT, _
                                 ByRef UAP, _
                                 ByRef UST, _
                                 ByRef UEL, _
                                 ByRef Category, _
                                 ByRef Taxyear As Integer)

'   Author  :   Ben Stephenson
'   Date    :   15/06/2011
'   Project :   CCA10512
'   Desc    :   Single week or month calculation
'               Decoupled from b2001NICalc

    Dim Balance
    Dim lowerST
    Dim upperST
    Dim valuetest
   
    
    ' Assume calc went O.K.
    WeekOrMonthCalc = True

    With DataTable
        .Edit
        
        ![UpToLEL] = GetUpToLEL([Taxyear], ![Tables Used], ![Period], _
                                ![Category], ![Gross Pay], LEL)
                                
        ' Get the LELtoST and the STtoPT17650430
        If Taxyear > 2010 Then
            ' CCA10970
            
            ![LELtoET] = GetEarningsBetweenThresholds([Taxyear], ![Tables Used], ![Period], _
                                                     ![Gross Pay], LEL, ET_PT)

        Else
            ![LELtoET] = GetEarningsBetweenThresholds([Taxyear], ![Tables Used], ![Period], _
                                                      ![Gross Pay], LEL, ET_PT)
        End If

        If Taxyear > 2008 Then
            'If ET_PT >= ST Then 'CCA10970
            ![ETtoUAP] = GetEarningsBetweenThresholds([Taxyear], ![Tables Used], ![Period], _
                                      ![Gross Pay], ET_PT, UAP)
            ![STToUAP] = GetEarningsBetweenThresholds([Taxyear], ![Tables Used], ![Period], _
                                      ![Gross Pay], ET_PT, UAP)
 
            ![UAPToUEL] = GetEarningsBetweenThresholds([Taxyear], ![Tables Used], ![Period], _
                                        ![Gross Pay], UAP, UEL)
            If Taxyear > 2014 And InStr("MIKZ", Category) Then
            
            ![UAPToUST] = GetEarningsBetweenThresholds([Taxyear], ![Tables Used], ![Period], _
                                        ![Gross Pay], UAP, UST)
            End If
                                        
        Else
            ![ETtoUEL] = GetEarningsBetweenThresholds([Taxyear], ![Tables Used], ![Period], _
                                                     ![Gross Pay], ET_PT, UEL)
        End If
               
        ' Get the employee's contributions
        ' Altered for CCA10970 previously ST was set to Z
        ![EEConts] = GetConts([Taxyear], DataTable, ![Tables Used], ![Category], _
                              ![Period], ST, ET_PT, UAP, UST, UEL, ![Gross Pay], cEmployee)
                              
        ' Get the employer's contributions and rebate
      
        If Taxyear > 2014 Then
        
            ![ERConts] = GetConts([Taxyear], DataTable, ![Tables Used], ![Category], _
                                  ![Period], ST, ET_PT, UAP, UST, UEL, ![Gross Pay], cEmployer)
                                          
            If Category = "I" Or Category = "K" Then ' CCA10970
               lowerST = GetNIRebate11([Taxyear], ![Tables Used], ![Period], _
                                          ![Category], ![Gross Pay], LEL, ST, cEmployer)
                                          
               upperST = GetNIRebate11([Taxyear], ![Tables Used], ![Period], _
                                          ![Category], ![Gross Pay], ST, UAP, cEmployer)
                                          
                ![ERNIRebate] = lowerST + upperST
            Else
               ![ERNIRebate] = GetNIRebate11([Taxyear], ![Tables Used], ![Period], _
                                          ![Category], ![Gross Pay], LEL, ST, cEmployer)
            End If
        ElseIf Taxyear > 2010 Then
            'temporary removal for EARS fix
            '![ERConts] = GetConts([Taxyear], DataTable, ![Tables Used], ![Category], _
                                  ![Period], ST, 0, UAP, UST, UEL, ![Gross Pay], cEmployer)
                                  
            ![ERConts] = GetConts([Taxyear], DataTable, ![Tables Used], ![Category], _
                                  ![Period], ST, ET_PT, UAP, UST, UEL, ![Gross Pay], cEmployer)
                                          
            ![ERNIRebate] = GetNIRebate11([Taxyear], ![Tables Used], ![Period], _
                                         ![Category], ![Gross Pay], LEL, ST, cEmployer)
        Else
            

            ![ERConts] = GetConts([Taxyear], DataTable, ![Tables Used], ![Category], _
                                  ![Period], 0, ET_PT, UAP, UST, UEL, ![Gross Pay], cEmployer)
                                  
            ![ERNIRebate] = GetNIRebate11([Taxyear], ![Tables Used], ![Period], _
                                          ![Category], ![Gross Pay], LEL, ET_PT, cEmployer)
        End If
        
        ' Get the employee's rebate
        ![EENIRebate] = GetNIRebate11([Taxyear], ![Tables Used], ![Period], _
                                      ![Category], ![Gross Pay], LEL, ET_PT, cEmployee)
                                            
        ' Total everything up...
        ![TotalConts] = IIf(IsNull(![ERConts]), 0, CCur(![ERConts])) + _
                        IIf(IsNull(![EEConts]), 0, CCur(![EEConts]))

        If ![EEConts] < ![EENIRebate] Then
            Balance = ![EENIRebate] - ![EEConts]
            ![EENIRebate] = ![EENIRebate] - Balance
            ![ERNIRebate] = ![ERNIRebate] + Balance
        End If
        
        If Taxyear > 2002 And Taxyear < 2009 Then
            ![EEConts2003] = ![EEConts] - ![EENIRebate]
            ![ERConts2003] = ![ERConts] - ![ERNIRebate]
            ![TotalConts2003] = IIf(IsNull(![ERConts2003]), 0, CCur(![ERConts2003])) + _
                                IIf(IsNull(![EEConts2003]), 0, CCur(![EEConts2003]))
        
        ElseIf Taxyear > 2008 Then
            ![EEConts2009] = ![EEConts] - ![EENIRebate]
            ![ERConts2009] = ![ERConts] - ![ERNIRebate]
            ![TotalConts2009] = IIf(IsNull(![ERConts2009]), 0, CCur(![ERConts2009])) + _
                                IIf(IsNull(![EEConts2009]), 0, CCur(![EEConts2009]))
        End If

        .Update
    End With
    ' Copy to record at the bottom of the table
    With DataTableClone
        .AddNew
        
        ![Period] = DataTable![Period]
        ![Period Number] = DataTable![Period Number]
        ![Category] = DataTable![Category]
        ![Gross Pay] = DataTable![Gross Pay]
        ![Tables Used] = DataTable![Tables Used]
        
        ![UpToLEL] = DataTable![UpToLEL]
        ![LELtoET] = DataTable![LELtoET]
        
        If Taxyear > 2008 Then ' CSNE 23/02/2009
            'If ET_PT >= ST Then
            ![ETtoUAP] = DataTable![ETtoUAP]
            ![UAPToUEL] = DataTable![UAPToUEL]
           ' Else
           ' ![STToUAP] = DataTable![STToUAP]
           ' ![UAPToUEL] = DataTable![UAPToUEL]
           ' End If
        Else
            ![ETtoUEL] = DataTable![ETtoUEL]
        End If
        
        ![EEConts] = DataTable![EEConts]
        ![ERConts] = DataTable![ERConts]
        ![TotalConts] = DataTable![TotalConts]
        ![EENIRebate] = DataTable![EENIRebate]
        ![ERNIRebate] = DataTable![ERNIRebate]
        If Taxyear > 2002 And Taxyear < 2009 Then ' csne
            ![EEConts2003] = ![EEConts2003] + DataTable![EEConts2003]
            ![ERConts2003] = ![ERConts2003] + DataTable![ERConts2003]
            ![TotalConts2003] = ![TotalConts2003] + DataTable![TotalConts2003]
            If ![TotalConts2003] < 0 Then
                ![Refund] = "R"
            End If
        ElseIf Taxyear > 2008 Then
            ![EEConts2009] = ![EEConts2009] + DataTable![EEConts2009]
            ![ERConts2009] = ![ERConts2009] + DataTable![ERConts2009]
            ![TotalConts2009] = ![TotalConts2009] + DataTable![TotalConts2009]
            If ![TotalConts2009] < 0 Then
                ![Refund] = "R"
            End If
        End If
        .Update
    End With
    ' Remove the original record W or M
    DataTable.Delete
    DataTable.MovePrevious

Exit_WeekOrMonthCalc:
    DoCmd.Hourglass False
    Exit Function

Err_WeekOrMonthCalc:
    
    MsgBox Error$ & " in function WeekOrMonthCalc"
    Resume Exit_WeekOrMonthCalc

End Function

Private Function WeekOrMonthCalc16(ByRef DataTable, _
                                 ByRef DataTableClone, _
                                 ByRef LEL, _
                                 ByRef ST, _
                                 ByRef ET_PT, _
                                 ByRef AUST, _
                                 ByRef UST, _
                                 ByRef UEL, _
                                 ByRef Category, _
                                 ByRef Taxyear As Integer)

'   Author  :   Chris Sneddon
'   Date    :   12/10/2015
'   Desc    :   2016 updates

    Dim Balance
    Dim lowerST
    Dim upperST
    Dim valuetest
   
    
    ' Assume calc went O.K.
    WeekOrMonthCalc16 = True

    With DataTable
        .Edit
        
        ![UpToLEL] = GetUpToLEL([Taxyear], ![Tables Used], ![Period], ![Category], ![Gross Pay], LEL)
        ![LELtoET] = GetEarningsBetweenThresholds([Taxyear], ![Tables Used], ![Period], ![Gross Pay], LEL, ET_PT)
        ![ETtoUEL] = GetEarningsBetweenThresholds([Taxyear], ![Tables Used], ![Period], ![Gross Pay], ET_PT, UEL)
        ![ETToUST] = GetEarningsBetweenThresholds([Taxyear], ![Tables Used], ![Period], ![Gross Pay], ET_PT, UST)
        ![ETToAUST] = GetEarningsBetweenThresholds([Taxyear], ![Tables Used], ![Period], ![Gross Pay], ET_PT, AUST)

               
        ' Get the employee's contributions
        ![EEConts] = GetConts16([Taxyear], DataTable, ![Tables Used], ![Category], ![Period], 0, ET_PT, 0, 0, UEL, ![Gross Pay], cEmployee)
                              
        ' Get the employer's contributions and rebate
        ![ERConts] = GetConts16([Taxyear], DataTable, ![Tables Used], ![Category], ![Period], ST, 0, AUST, UST, UEL, ![Gross Pay], cEmployer)
                                          
        ' Get the Employer's rebate
        ![ERNIRebate] = GetNIRebate11([Taxyear], ![Tables Used], ![Period], ![Category], ![Gross Pay], LEL, ST, cEmployer)
        ' Get the employee's rebate
        ![EENIRebate] = GetNIRebate11([Taxyear], ![Tables Used], ![Period], ![Category], ![Gross Pay], LEL, ET_PT, cEmployee)
                                            
        ' Total everything up...
        ![TotalConts] = IIf(IsNull(![ERConts]), 0, CCur(![ERConts])) + IIf(IsNull(![EEConts]), 0, CCur(![EEConts]))

        If ![EEConts] < ![EENIRebate] Then
            Balance = ![EENIRebate] - ![EEConts]
            ![EENIRebate] = ![EENIRebate] - Balance
            ![ERNIRebate] = ![ERNIRebate] + Balance
        End If
         
            ![EEConts2009] = ![EEConts] - ![EENIRebate]
            ![ERConts2009] = ![ERConts] - ![ERNIRebate]
            ![TotalConts2009] = IIf(IsNull(![ERConts2009]), 0, CCur(![ERConts2009])) + _
                                IIf(IsNull(![EEConts2009]), 0, CCur(![EEConts2009]))

        .Update
    End With
    ' Copy to record at the bottom of the table
    With DataTableClone
        .AddNew
        
        ![Period] = DataTable![Period]
        ![Period Number] = DataTable![Period Number]
        ![Category] = DataTable![Category]
        ![Gross Pay] = DataTable![Gross Pay]
        ![Tables Used] = DataTable![Tables Used]
        
        ![UpToLEL] = DataTable![UpToLEL]
        ![LELtoET] = DataTable![LELtoET]
        ![ETtoUEL] = DataTable![ETtoUEL]
        ![ETToUST] = DataTable![ETToUST]
        ![ETToAUST] = DataTable![ETToAUST]
        ![EEConts] = DataTable![EEConts]
        ![ERConts] = DataTable![ERConts]
        ![TotalConts] = DataTable![TotalConts]
        ![EENIRebate] = DataTable![EENIRebate]
        ![ERNIRebate] = DataTable![ERNIRebate]
        ![EEConts2009] = ![EEConts2009] + DataTable![EEConts2009]
        ![ERConts2009] = ![ERConts2009] + DataTable![ERConts2009]
        ![TotalConts2009] = ![TotalConts2009] + DataTable![TotalConts2009]

        .Update
    End With
    ' Remove the original record W or M
    DataTable.Delete
    DataTable.MovePrevious

Exit_WeekOrMonthCalc16:
    DoCmd.Hourglass False
    Exit Function

Err_WeekOrMonthCalc16:
    
    MsgBox Error$ & " in function WeekOrMonthCalc16"
    Resume Exit_WeekOrMonthCalc16

End Function

Private Function FourWeekTableCalc(ByRef DataTable, _
                                   ByRef DataTableClone, _
                                   ByRef LEL, _
                                   ByRef ST, _
                                   ByRef ET_PT, _
                                   ByRef UAP, _
                                   ByRef UST, _
                                   ByRef UEL, _
                                   ByRef Taxyear As Integer)
                                   
'  Author   :   Ben Stephenson
'  Date     :   15/06/2011
'  Project  :   CCA10512
'  Desc     :   Calculation for a 4 week period using the table method
'               Decoupled from b2001NICalc

    Dim strNextRecord As String
    Dim wkResult
    Dim lowerST
    Dim upperST
    Dim valuetest
    Dim Category
    Dim Balance     ' Difference between EEconts and EENIRebate when primary conts are less than primary rebate

    ' Assume calc went O.K.
    FourWeekTableCalc = True

    ' Insert duplicate Ws ( 4xNo4Ws ), at bottom of the table
    With DataTableClone
        .AddNew
        ![Period] = "W"
        ![Period Number] = (DataTable![Period Number] - 1) * 4 + 1
        ![Gross Pay] = Int(DataTable![Gross Pay] * 100 / 4) / 100
        ![Category] = DataTable![Category]
        ![Tables Used] = DataTable![Tables Used]
        .Update
    End With
    ' Add another 3 W rows at the bottom of the table
    Dim i  As Integer
    For i = 1 To 3
        If bRepeatButton(Taxyear) = False Then
            ' Unable to add, so delete inserted 4W
            FourWeekTableCalc = False
            DataTableClone.MoveLast
            DataTableClone.Delete
            Forms!frmClass1_01.Recalc
            GoTo Exit_FourWeekTableCalc
        End If
    Next
    
    DoCmd.Hourglass True
    ' delete the original '4W' and go up to previous W record
    DataTable.Delete
    DataTable.MovePrevious
    
    ' Set a bookmark to this new current record
    If Not DataTable.BOF Then
        strNextRecord = DataTable.Bookmark
    Else
        ' Bookmark cannot be set, as has reached the BOF
        strNextRecord = cstrAll_RECORDS_PROCESSED
    End If
    
    ' Update the 4 newly created 'W's, which will be at the bottom of the table
    With DataTable
        .MoveLast
    
        For i = 1 To 4
            .Edit
        ![UpToLEL] = GetUpToLEL([Taxyear], ![Tables Used], ![Period], _
                                ![Category], ![Gross Pay], LEL)
                                
        ' Get the LELtoST and the STtoPT
        If Taxyear > 2010 Then

            ![LELtoET] = GetEarningsBetweenThresholds([Taxyear], ![Tables Used], ![Period], _
                                                      ![Gross Pay], LEL, ET_PT)
        End If

        If Taxyear > 2008 Then

            ![ETtoUAP] = GetEarningsBetweenThresholds([Taxyear], ![Tables Used], ![Period], _
                                      ![Gross Pay], ET_PT, UAP)

            ![UAPToUEL] = GetEarningsBetweenThresholds([Taxyear], ![Tables Used], ![Period], _
                                        ![Gross Pay], UAP, UEL)
            If Taxyear > 2014 And InStr("MIKZ", Category) Then
            
            ![UAPToUST] = GetEarningsBetweenThresholds([Taxyear], ![Tables Used], ![Period], _
                                        ![Gross Pay], UAP, UST)
            End If
                                        
        Else
            ![ETtoUEL] = GetEarningsBetweenThresholds([Taxyear], ![Tables Used], ![Period], _
                                                     ![Gross Pay], ET_PT, UEL)
        End If
        
        ' Get the employee's contributions
        ![EEConts] = GetConts([Taxyear], DataTable, ![Tables Used], ![Category], _
                              ![Period], 0, ET_PT, UAP, UST, UEL, ![Gross Pay], cEmployee)
        
        ' Get the employer's contributions and rebate
        If Taxyear > 2014 Then
        
            ![ERConts] = GetConts([Taxyear], DataTable, ![Tables Used], ![Category], _
                                  ![Period], ST, 0, UAP, UST, UEL, ![Gross Pay], cEmployer)
                                          
            If Category = "I" Or Category = "K" Then ' Functionally it should be x2 3.4% at present it will only do it once.
               lowerST = GetNIRebate11([Taxyear], ![Tables Used], ![Period], _
                                          ![Category], ![Gross Pay], LEL, ST, cEmployer)
                                          
               upperST = GetNIRebate11([Taxyear], ![Tables Used], ![Period], _
                                          ![Category], ![Gross Pay], ST, UAP, cEmployer)
                                          
                ![ERNIRebate] = lowerST + upperST
            Else
               ![ERNIRebate] = GetNIRebate11([Taxyear], ![Tables Used], ![Period], _
                                          ![Category], ![Gross Pay], LEL, ST, cEmployer)
            End If
        ElseIf Taxyear > 2010 Then
            ![ERConts] = GetConts([Taxyear], DataTable, ![Tables Used], ![Category], _
                                  ![Period], ST, ET_PT, UAP, UST, UEL, ![Gross Pay], cEmployer)
        
            ![ERNIRebate] = GetNIRebate11([Taxyear], ![Tables Used], ![Period], _
                                          ![Category], ![Gross Pay], LEL, ST, cEmployer)
                                          
        Else
            ![ERConts] = GetConts([Taxyear], DataTable, ![Tables Used], ![Category], _
                                  ![Period], 0, ET_PT, UAP, UST, UEL, ![Gross Pay], cEmployer)
        
            ![ERNIRebate] = GetNIRebate11([Taxyear], ![Tables Used], ![Period], _
                                          ![Category], ![Gross Pay], LEL, ET_PT, cEmployer)
        End If
        
        ' Get the eomplyee's rebate
        ![EENIRebate] = GetNIRebate11([Taxyear], ![Tables Used], ![Period], _
                                      ![Category], ![Gross Pay], LEL, ET_PT, cEmployee)
                                            
        ![TotalConts] = IIf(IsNull(![ERConts]), 0, CCur(![ERConts])) + _
                        IIf(IsNull(![EEConts]), 0, CCur(![EEConts]))

        If ![EEConts] < ![EENIRebate] Then
            Balance = ![EENIRebate] - ![EEConts]
            ![EENIRebate] = ![EENIRebate] - Balance
            ![ERNIRebate] = ![ERNIRebate] + Balance
        End If
        
        If Taxyear > 2002 And Taxyear < 2009 Then
            ![EEConts2003] = ![EEConts] - ![EENIRebate]
            ![ERConts2003] = ![ERConts] - ![ERNIRebate]
            ![TotalConts2003] = IIf(IsNull(![ERConts2003]), 0, CCur(![ERConts2003])) + _
                                IIf(IsNull(![EEConts2003]), 0, CCur(![EEConts2003]))
        
        ElseIf Taxyear > 2008 Then
            ![EEConts2009] = ![EEConts] - ![EENIRebate]
            ![ERConts2009] = ![ERConts] - ![ERNIRebate]
            ![TotalConts2009] = IIf(IsNull(![ERConts2009]), 0, CCur(![ERConts2009])) + _
                                IIf(IsNull(![EEConts2009]), 0, CCur(![EEConts2009]))
        End If
        
            .Update
            .MovePrevious
        Next
        .MoveNext
    End With
    
    ' Insert 4W to replace the 4 'W's
    With DataTableClone
        .AddNew
        ![Period] = "4W"
        ![Period Number] = (DataTable![Period Number] - 1) / 4 + 1
        ![Category] = DataTable![Category]
        ![Tables Used] = DataTable![Tables Used]
    
        ![Gross Pay] = 0
        ![UpToLEL] = 0
        ![LELtoET] = 0
    
        If Taxyear > 2010 Then
            'If ST > ET_PT Then
            '![PTToST] = 0
            '![LELToPT] = 0
            'Else
            ![STToPT] = 0
            ![LELToST] = 0
            'End If
        End If
    
        If Taxyear > 2008 Then ' CSNE 23/02/2009
            'If ST > ET_PT Then
            '![STToUAP] = 0
            '![UAPToUEL] = 0
            'Else
            ![ETtoUAP] = 0
            ![UAPToUEL] = 0
            'End If
            If Taxyear > 2014 Then ' CSNE 12/01/2015
            ![UAPToUST] = 0
            End If
        Else
            ![ETtoUEL] = 0
        End If
        
        ![EEConts] = 0
        ![ERConts] = 0
        ![TotalConts] = 0
        ![EENIRebate] = 0
        ![ERNIRebate] = 0
        If Taxyear > 2002 And Taxyear < 2009 Then
            ![EEConts2003] = 0
            ![ERConts2003] = 0
            ![TotalConts2003] = 0
            ![Refund] = Null
        ElseIf Taxyear > 2008 Then
            ![EEConts2009] = 0
            ![ERConts2009] = 0
            ![TotalConts2009] = 0
            ![Refund] = Null
        End If
    
        ' Update 4W and delete its 4 'W's
        For i = 1 To 4
            ![Gross Pay] = ![Gross Pay] + DataTable![Gross Pay]
            ![UpToLEL] = ![UpToLEL] + DataTable![UpToLEL]
            ![LELtoET] = ![LELtoET] + DataTable![LELtoET]
            
            
            If Taxyear > 2008 Then
                'If ST > ET_PT Then
                '![STToUAP] = ![STToUAP] + DataTable![STToUAP]
                'Else
                ![ETtoUAP] = ![ETtoUAP] + DataTable![ETtoUAP]
                'End If
                ![UAPToUEL] = ![UAPToUEL] + DataTable![UAPToUEL]
                If Taxyear > 2014 Then
                ![UAPToUST] = ![UAPToUST] + DataTable![UAPToUST]
                End If
                'addition to conform with CCA10290 legisation
                wkResult = ((NIRateBandTable![AnnUEL] - NIRateBandTable![AnnUAP]) / 13)
                If ![UAPToUEL] > wkResult Then
                    ![UAPToUEL] = wkResult
                End If
            Else
                ![ETtoUEL] = ![ETtoUEL] + DataTable![ETtoUEL]
            End If
            
            ![EEConts] = ![EEConts] + DataTable![EEConts]
            ![ERConts] = ![ERConts] + DataTable![ERConts]
            ![TotalConts] = ![TotalConts] + DataTable![TotalConts]
            ![EENIRebate] = ![EENIRebate] + DataTable![EENIRebate]
            ![ERNIRebate] = ![ERNIRebate] + DataTable![ERNIRebate]
            
            If Taxyear > 2002 And Taxyear < 2009 Then
                ![EEConts2003] = ![EEConts2003] + DataTable![EEConts2003]
                ![ERConts2003] = ![ERConts2003] + DataTable![ERConts2003]
                ![TotalConts2003] = ![TotalConts2003] + DataTable![TotalConts2003]
                If i = 4 Then
                    If ![TotalConts2003] < 0 Then
                        ![Refund] = "R"
                    End If
                End If
                
            ElseIf Taxyear > 2008 Then
                ![EEConts2009] = ![EEConts2009] + DataTable![EEConts2009]
                ![ERConts2009] = ![ERConts2009] + DataTable![ERConts2009]
                ![TotalConts2009] = ![TotalConts2009] + DataTable![TotalConts2009]
                If i = 4 Then
                    If ![TotalConts2009] < 0 Then
                        ![Refund] = "R"
                    End If
                End If
            End If
            DataTable.Delete
            DataTable.MoveNext
        Next
        .Update
    End With
    ' Set the current record to the previouly saved bookmark
    If Not strNextRecord = cstrAll_RECORDS_PROCESSED Then
        DataTable.Bookmark = strNextRecord
    End If

Exit_FourWeekTableCalc:
    DoCmd.Hourglass False
    Exit Function

Err_FourWeekTableCalc:
    MsgBox Error$ & " in function FourWeekTableCalc"
    Resume Exit_FourWeekTableCalc

End Function

Private Function FourWeekTableCalc16(ByRef DataTable, _
                                   ByRef DataTableClone, _
                                   ByRef LEL, _
                                   ByRef ST, _
                                   ByRef ET_PT, _
                                   ByRef AUST, _
                                   ByRef UST, _
                                   ByRef UEL, _
                                   ByRef Taxyear As Integer)
                                   
'  Author   :   Chris Sneddon
'  Date     :   12/10/2015
'  Desc     :   Calc a 4 weekly period

    Dim strNextRecord As String
    Dim wkResult
    Dim lowerST
    Dim upperST
    Dim valuetest
    Dim Category
    Dim Balance     ' Difference between EEconts and EENIRebate when primary conts are less than primary rebate
    Dim countTest As String

    ' Assume calc went O.K.
    FourWeekTableCalc16 = True

    ' Insert duplicate Ws ( 4xNo4Ws ), at bottom of the table
    With DataTableClone
        .AddNew
        ![Period] = "W"
        ![Period Number] = (DataTable![Period Number] - 1) * 4 + 1
        countTest = (DataTable![Period Number] - 1) * 4 + 1
        ![Gross Pay] = Int(DataTable![Gross Pay] * 100 / 4) / 100
        ![Category] = DataTable![Category]
        ![Tables Used] = DataTable![Tables Used]
        .Update
    End With
    ' Add another 3 W rows at the bottom of the table
    Dim i  As Integer
    For i = 1 To 3
        If bRepeatButton(Taxyear) = False Then
            ' Unable to add, so delete inserted 4W
            FourWeekTableCalc16 = False
            DataTableClone.MoveLast
            DataTableClone.Delete
            Forms!frmClass1_01.Recalc
            GoTo Exit_FourWeekTableCalc16
        End If
    Next
    
    DoCmd.Hourglass True
    ' delete the original '4W' and go up to previous W record
    DataTable.Delete
    DataTable.MovePrevious
    
    ' Set a bookmark to this new current record
    If Not DataTable.BOF Then
        strNextRecord = DataTable.Bookmark
    Else
        ' Bookmark cannot be set, as has reached the BOF
        strNextRecord = cstrAll_RECORDS_PROCESSED
    End If
    
    ' Update the 4 newly created 'W's, which will be at the bottom of the table
    With DataTable
        .MoveLast
    
        For i = 1 To 4
            .Edit
        ![UpToLEL] = GetUpToLEL([Taxyear], ![Tables Used], ![Period], ![Category], ![Gross Pay], LEL)
        ![LELtoET] = GetEarningsBetweenThresholds([Taxyear], ![Tables Used], ![Period], ![Gross Pay], LEL, ET_PT)
        ![ETtoUEL] = GetEarningsBetweenThresholds([Taxyear], ![Tables Used], ![Period], ![Gross Pay], ET_PT, UEL)
        ![ETToUST] = GetEarningsBetweenThresholds([Taxyear], ![Tables Used], ![Period], ![Gross Pay], ET_PT, UST)
        ![ETToAUST] = GetEarningsBetweenThresholds([Taxyear], ![Tables Used], ![Period], ![Gross Pay], ET_PT, AUST)
        ![ETtoUEL] = GetEarningsBetweenThresholds([Taxyear], ![Tables Used], ![Period], ![Gross Pay], ET_PT, UEL)
 
        ' Get the employee's contributions
        ![EEConts] = GetConts16([Taxyear], DataTable, ![Tables Used], ![Category], ![Period], 0, ET_PT, 0, 0, UEL, ![Gross Pay], cEmployee)
        ' Get the employer's contributions and rebate
        ![ERConts] = GetConts16([Taxyear], DataTable, ![Tables Used], ![Category], ![Period], ST, 0, AUST, UST, UEL, ![Gross Pay], cEmployer)
        ' Get the eomplyee's rebate
        ![EENIRebate] = GetNIRebate11([Taxyear], ![Tables Used], ![Period], ![Category], ![Gross Pay], LEL, ET_PT, cEmployee)
        ' Get the Employer rebate
        ![ERNIRebate] = GetNIRebate11([Taxyear], ![Tables Used], ![Period], ![Category], ![Gross Pay], LEL, ST, cEmployer)

                                            
        ![TotalConts] = IIf(IsNull(![ERConts]), 0, CCur(![ERConts])) + IIf(IsNull(![EEConts]), 0, CCur(![EEConts]))

        If ![EEConts] < ![EENIRebate] Then
            Balance = ![EENIRebate] - ![EEConts]
            ![EENIRebate] = ![EENIRebate] - Balance
            ![ERNIRebate] = ![ERNIRebate] + Balance
        End If
        
            ![EEConts2009] = ![EEConts] - ![EENIRebate]
            ![ERConts2009] = ![ERConts] - ![ERNIRebate]
            ![TotalConts2009] = IIf(IsNull(![ERConts2009]), 0, CCur(![ERConts2009])) + _
                                IIf(IsNull(![EEConts2009]), 0, CCur(![EEConts2009]))
        
            .Update
            .MovePrevious
        Next
        .MoveNext
    End With
    
    ' Insert 4W to replace the 4 'W's
    With DataTableClone
        .AddNew
        ![Period] = "4W"
        ![Period Number] = (DataTable![Period Number] - 1) / 4 + 1
        ![Category] = DataTable![Category]
        ![Tables Used] = DataTable![Tables Used]
    
        ![Gross Pay] = 0
        ![UpToLEL] = 0
        ![LELtoET] = 0
        ![ETtoUEL] = 0
        ![ETToUST] = 0
        ![ETToAUST] = 0
        ![EEConts] = 0
        ![ERConts] = 0
        ![TotalConts] = 0
        ![EENIRebate] = 0
        ![ERNIRebate] = 0
        ![EEConts2009] = 0
        ![ERConts2009] = 0
        ![TotalConts2009] = 0
    
        ' Update 4W and delete its 4 'W's
        For i = 1 To 4
            ![Gross Pay] = ![Gross Pay] + DataTable![Gross Pay]
            ![UpToLEL] = ![UpToLEL] + DataTable![UpToLEL]
            ![LELtoET] = ![LELtoET] + DataTable![LELtoET]
            ![ETToAUST] = ![ETToAUST] + DataTable![ETToAUST]
            ![ETToUST] = ![ETToUST] + DataTable![ETToUST]
            ![ETtoUEL] = ![ETtoUEL] + DataTable![ETtoUEL]
            'addition to conform with CCA10290 legisation
            wkResult = ((NIRateBandTable![AnnUEL] - NIRateBandTable![AnnPT]) / 13)
                If ![ETtoUEL] > wkResult Then
                    ![ETtoUEL] = wkResult
                End If
            ![EEConts] = ![EEConts] + DataTable![EEConts]
            ![ERConts] = ![ERConts] + DataTable![ERConts]
            ![TotalConts] = ![TotalConts] + DataTable![TotalConts]
            ![EENIRebate] = ![EENIRebate] + DataTable![EENIRebate]
            ![ERNIRebate] = ![ERNIRebate] + DataTable![ERNIRebate]
            ![EEConts2009] = ![EEConts2009] + DataTable![EEConts2009]
            ![ERConts2009] = ![ERConts2009] + DataTable![ERConts2009]
            ![TotalConts2009] = ![TotalConts2009] + DataTable![TotalConts2009]

            DataTable.Delete
            DataTable.MoveNext
        Next
        .Update
    End With
    ' Set the current record to the previouly saved bookmark
    If Not strNextRecord = cstrAll_RECORDS_PROCESSED Then
        DataTable.Bookmark = strNextRecord
    End If

Exit_FourWeekTableCalc16:
    DoCmd.Hourglass False
    Exit Function

Err_FourWeekTableCalc16:
    MsgBox Error$ & " in function FourWeekTableCalc16"
    Resume Exit_FourWeekTableCalc16

End Function



Function bSteppedValue(ByVal Earnings, ByVal LEL) As Integer
' Author            : Mustaq Hussain
' Date              : 6 March 1996
' Name              : bSteppedValue
' Purpose           : Returns whether Earnings falls on a step (4.00)


    Dim ndiff

    On Error GoTo Err_bSteppedValue

    ' Difference from start of step
    ndiff = Earnings - LEL

    bSteppedValue = IIf(Int(ndiff / 4) = ndiff / 4, True, False)
    

Exit_bSteppedValue:
    Exit Function

Err_bSteppedValue:
    MsgBox Error$
    Resume Exit_bSteppedValue

End Function

Sub calcTotals()

            '''''''''''''''''''''''''''''''''''''''''
            ' AUTHOR : JASON CORDEY - I.T.S.A. 1995 '
            '''''''''''''''''''''''''''''''''''''''''

' Modified History  :
' Author            : Mustaq Hussain
' Date              : 16 June 1995
' Reason            : DCF 273 : Total contribution does not show correct under/over payment
'                   : The check that assigns the total under/over payments to zero commented out
'                   :
' Author            : Mustaq Hussain
' Date              : 20 December
' Reason            : LEL 68 : Total Cont incorrect, when EE has O/P and ER has U/P and where any computed totals zero

On Error GoTo Err_calcTotals
Dim Rebate As Double
Dim Employerspayment As Double
Dim Employeespayment As Double
Dim Totalpayment As Double
Dim MyDynaTot As DAO.Recordset

'cater for user deleting these entires
If IsNull(Forms![PCGForm]![txtNITotalInput]) Then
    Forms![PCGForm]![txtNITotalInput] = 0
End If
If IsNull(Forms![PCGForm]![txtEENITotalInput]) Then
    Forms![PCGForm]![txtEENITotalInput] = 0
End If

With Forms!PCGForm
    !TotalPay = !Contributions.Form!GrossPayTotal
    !TotalEarnings = !Contributions.Form!EarningsTotal
    !TotalEmployeeNI = !Contributions.Form!EmployeeTotal
    !TotalEmployerNI = !Contributions.Form!EmployerTotal

    If !Contributions.SourceObject = "fsubClass1" Then
        !txtTotalRebate1 = !Contributions.Form!txtRebateTotal
    End If

    If !Contributions.SourceObject = "fsubClass1_2000" Or !Contributions.SourceObject = "fsubClass1_2001" Then
        !txtTotalRebate1 = !Contributions.Form!txtRebate1Total
        !txtTotalRebate2 = !Contributions.Form!txtRebate2Total
    End If

    If !Contributions.SourceObject = "fsubClass1_2001" Then
        !txtRebateTotal = !Contributions.Form!RebateTotal
        !txtRebate2Paid = .txtTotalRebatePaid - .txtRebate1Paid
    End If

EmployerTotal:
'_______________________________________________________________________________________

' This section calculates the Employers Over/Under payment
'_______________________________________________________________________________________

    Employerspayment = ![TotalEmployerNI] - ![txtERNITotal]

    If Employerspayment < 0 Then
        ![txtERUnderpayment] = 0
        ![txtEROverpayment] = -(Employerspayment)
    Else
        ![txtERUnderpayment] = Employerspayment
        ![txtEROverpayment] = 0
    End If

    


EmployeeTotal:
'_______________________________________________________________________________________

' This section calculates the Employees Over/Under payment
'_______________________________________________________________________________________

    Employeespayment = ![TotalEmployeeNI] - ![txtEENITotalInput]
    
    If Employeespayment < 0 Then
        ![txtEEUnderpayment] = 0
        ![txtEEOverpayment] = -(Employeespayment)
    Else
        ![txtEEUnderpayment] = Employeespayment
        ![txtEEOverpayment] = 0
    End If

EmployerRebate:
'_______________________________________________________________________________________

' This section calculates the NIC Rebate Over/Under payment
'_______________________________________________________________________________________

    Rebate = ![txtTotalRebate1] - ![txtRebate1Paid]
    
    If Rebate < 0 Then
        ![txtRebate1UnderPaid] = -(Rebate)
        ![txtRebate1OverPaid] = 0
    Else
        ![txtRebate1UnderPaid] = 0
        ![txtRebate1OverPaid] = Rebate
    End If

    If !Contributions.SourceObject = "fsubClass1_2000" Or !Contributions.SourceObject = "fsubClass1_2001" Then
        Rebate = ![txtTotalRebate2] - ![txtRebate2Paid]
    
        If Rebate < 0 Then
            ![txtRebate2UnderPaid] = -(Rebate)
            ![txtRebate2OverPaid] = 0
        Else
            ![txtRebate2UnderPaid] = 0
            ![txtRebate2OverPaid] = Rebate
        End If
    End If

    If !Contributions.SourceObject = "fsubClass1_2001" Then
        Rebate = ![txtRebateTotal] - ![txtTotalRebatePaid]
    
        If Rebate < 0 Then
            ![txtTotalRebateUnderPaid] = -(Rebate)
            ![txtTotalRebateOverPaid] = 0
        Else
            ![txtTotalRebateUnderPaid] = 0
            ![txtTotalRebateOverPaid] = Rebate
        End If
    End If

Overalltotal:
'_______________________________________________________________________________________

' This section calculates the Total Over/Under payment
'_______________________________________________________________________________________
    
    Totalpayment = (![TotalNI] - (![txtERNITotal] + ![txtEENITotalInput]))

    If Totalpayment < 0 Then
        ![txtTotalUnderpayment] = 0
        ![txtTotalOverpayment] = -(Totalpayment)
    Else
        ![txtTotalUnderpayment] = Totalpayment
        ![txtTotalOverpayment] = 0
    End If


validatetotals:
'_______________________________________________________________________________________

' This section validates the Total Over/Under payments
'_______________________________________________________________________________________
    
' Total Conts U/P and O/P zero if EE has O/P and ER has U/P
    If (Employerspayment > 0) And (Employeespayment < 0) Then
        ![txtTotalUnderpayment] = 0
        ![txtTotalOverpayment] = 0
    End If

End With

Exit_calcTotals:
    Exit Sub

Err_calcTotals:
    MsgBox Error$
    Resume Exit_calcTotals

End Sub


Sub calcTotals_01()

' Author            : Christopher Schuler
' Date              : 20 February 2001
' Reason            : New main form for 2001


On Error GoTo Err_calcTotals_01
Dim Rebate As Double
Dim Employerspayment As Double
Dim Employeespayment As Double
Dim Totalpayment As Double
Dim MyDynaTot As DAO.Recordset
Dim Diff As Double
Dim OverallTotalPayment As Double

With Forms![frmClass1_01]
'cater for user deleting these entires
    If IsNull(![txtNITotalInput]) Then
        ![txtNITotalInput] = 0
    End If
    If IsNull(![txtEENITotalInput]) Then
        ![txtEENITotalInput] = 0
    End If
    
    
    !TotalPay = !Contributions.Form!GrossPayTotal
    
    !TotalEmployeeNI = !Contributions.Form!EmployeeTotal
    !TotalEmployerNI = !Contributions.Form!EmployerTotal
    


    !txtTotalRebate1 = !Contributions.Form!txtRebate1Total
    !txtTotalRebate2 = !Contributions.Form!txtRebate2Total
    

'_______________________________________________________________________________________

' This section calculates the Employers Over/Under payment
'_______________________________________________________________________________________

    Employerspayment = ![TotalEmployerNI] - ![txtERNITotal]
    
    If Employerspayment < 0 Then
        ![txtERUnderpayment] = 0
        ![txtEROverpayment] = -(Employerspayment)
    Else
        ![txtERUnderpayment] = Employerspayment
        ![txtEROverpayment] = 0
    End If

    
'_______________________________________________________________________________________

' This section calculates the Employees Over/Under payment
'_______________________________________________________________________________________

    Employeespayment = ![TotalEmployeeNI] - ![txtEENITotalInput]
    
    If Employeespayment < 0 Then
        ![txtEEUnderpayment] = 0
        ![txtEEOverpayment] = -(Employeespayment)
    Else
        ![txtEEUnderpayment] = Employeespayment
        ![txtEEOverpayment] = 0
    End If


'_______________________________________________________________________________________

' This section calculates the NIC Rebate Over/Under payment
'_______________________________________________________________________________________

    Rebate = ![txtTotalRebate1] - ![txtRebate1Paid]
    
    If Rebate < 0 Then
        ![txtRebate1UnderPaid] = -(Rebate)
        ![txtRebate1OverPaid] = 0
    Else
        ![txtRebate1UnderPaid] = 0
        ![txtRebate1OverPaid] = Rebate
    End If


    Rebate = ![txtTotalRebate2] - ![txtRebate2Paid]
    
    If Rebate < 0 Then
        ![txtRebate2UnderPaid] = -(Rebate)
        ![txtRebate2OverPaid] = 0
    Else
        ![txtRebate2UnderPaid] = 0
        ![txtRebate2OverPaid] = Rebate
    End If



'_______________________________________________________________________________________

' This section calculates the Total Over/Under payment
'_______________________________________________________________________________________
    
    Totalpayment = (![TotalNI] - (![txtERNITotal] + ![txtEENITotalInput]))
    
    If Totalpayment < 0 Then
        ![txtTotalUnderpayment] = 0
        ![txtTotalOverpayment] = -(Totalpayment)
    Else
        ![txtTotalUnderpayment] = Totalpayment
        ![txtTotalOverpayment] = 0
    End If



'_______________________________________________________________________________________

' This section validates the Total Over/Under payments
'_______________________________________________________________________________________
    
' Total Conts U/P and O/P zero if EE has O/P and ER has U/P
    If (Employerspayment > 0) And (Employeespayment < 0) Then
        ![txtTotalUnderpayment] = 0
        ![txtTotalOverpayment] = 0
    End If

'Column - EECont, Rows - TotalUnderpayment & TotalOverpayment

'Calculate the difference (assigned 'Diff' in the code) between the EEContsDue - NIRebate1 and the 'EEContsPaid + NIRebate1Claimed.
'If it is <  0 (negative or no difference) then there is an overpayment .
'If this is >= 0 (positive) then there is an underpayment or no difference.

    Diff = ![TotalEmployeeNI] - ![txtEENITotalInput] - ![txtTotalRebate1] + ![txtRebate1Paid]
    If Diff < 0 Then  'overpayment
        !EEContTotalOverpayment = -(Diff)  'diff is negative so convert to positive
        !EEContTotalUnderpayment = 0
    Else
        !EEContTotalOverpayment = 0
        !EEContTotalUnderpayment = Diff
    End If

'Column - ERCont, Rows - TotalUnderpayment & TotalOverpayment

' Similar to above but for ER

    Diff = ![TotalEmployerNI] - ![txtERNITotal] - ![txtTotalRebate2] + ![txtRebate2Paid]
    If Diff < 0 Then  'overpayment
        !ERContTotalOverpayment = -(Diff)  'diff is negative so convert to positive
        !ERContTotalUnderpayment = 0
    Else
        !ERContTotalOverpayment = 0
        !ERContTotalUnderpayment = Diff
    End If


'Column -Total Cont, Rows - TotalUnderpayment & TotalOverpayment

    OverallTotalPayment = ![TotalNI] - (![txtERNITotal] + ![txtEENITotalInput]) - (!txtTotalRebate1 + !txtTotalRebate2) + (!txtRebate1Paid + !txtRebate2Paid)
    
    
    If OverallTotalPayment < 0 Then
        !TotalContTotalUnderpayment = 0
        !TotalContTotalOverpayment = -(OverallTotalPayment)
    Else
        !TotalContTotalUnderpayment = OverallTotalPayment
        !TotalContTotalOverpayment = 0
    End If


'If there is an EE overpayment and an ER underpayment then there is no offset allowed of an EE 'refund against an ER debt.  In this case the totals are set to 0.
'However, an EE underpayment can be offset against an ER overpayment.

    If !EEContTotalOverpayment > 0 And !ERContTotalUnderpayment > 0 Then
        !TotalContTotalUnderpayment = 0
        !TotalContTotalOverpayment = 0
    End If
End With

Exit_calcTotals_01:
    Exit Sub

Err_calcTotals_01:
    MsgBox Error$
    Resume Exit_calcTotals_01


End Sub
Sub calcTotals_03()

' Author            : Christopher Schuler
' Date              : 22 January 2003
' Reason            : New main form for 2003
' Author            : Christopher Sneddon
' Date              : 23 February 2009
' Reason            : New main form for 2009


On Error GoTo Err_calcTotals_03
Dim Rebate As Double
Dim Employerspayment As Double
Dim Employeespayment As Double
Dim Totalpayment As Double
Dim MyDynaTot As DAO.Recordset
Dim Diff As Double
Dim OverallTotalPayment As Double

'If !frmContributions2009!taxyear > 2008 Then
'With Forms![frmClass1_09]
'Else
With Forms![frmClass1_03]
'End If
'cater for user deleting these entires
    If IsNull(![txtNITotalInput]) Then
        ![txtNITotalInput] = 0
    End If
    If IsNull(![txtEENITotalInput]) Then
        ![txtEENITotalInput] = 0
    End If


    !TotalPay = !Contributions.Form!GrossPayTotal
    
    !TotalEmployeeNI = !Contributions.Form!EmployeeTotal
    !TotalEmployerNI = !Contributions.Form!EmployerTotal

'_______________________________________________________________________________________

' This section calculates the Employers Over/Under payment
'_______________________________________________________________________________________

    Employerspayment = ![TotalEmployerNI] - ![txtERNITotal]
    
    If Employerspayment < 0 Then
        ![ERContUnderPayment] = 0
        ![ERContOverPayment] = -(Employerspayment)
    Else
        ![ERContUnderPayment] = Employerspayment
        ![ERContOverPayment] = 0
    End If

    
'_______________________________________________________________________________________

' This section calculates the Employees Over/Under payment
'_______________________________________________________________________________________

    Employeespayment = ![TotalEmployeeNI] - ![txtEENITotalInput]
    
    If Employeespayment < 0 Then
        ![EEContUnderPayment] = 0
        ![EEContOverPayment] = -(Employeespayment)
    Else
        ![EEContUnderPayment] = Employeespayment
        ![EEContOverPayment] = 0
    End If



'_______________________________________________________________________________________

' This section calculates the Total Over/Under payment
'_______________________________________________________________________________________
    
    Totalpayment = (![TotalNI] - (![txtERNITotal] + ![txtEENITotalInput]))
    
    If Totalpayment < 0 Then
        ![TotalUnderPayment] = 0
        ![TotalOverPayment] = -(Totalpayment)
    Else
        ![TotalUnderPayment] = Totalpayment
        ![TotalOverPayment] = 0
    End If


'If there is an EE overpayment and an ER underpayment then there is no offset allowed of an EE 'refund against an ER debt.  In this case the totals are set to 0.
'However, an EE underpayment can be offset against an ER overpayment.

    If !EEContOverPayment > 0 And !ERContUnderPayment > 0 Then
        !TotalUnderPayment = 0
        !TotalOverPayment = 0
    End If

End With

Exit_calcTotals_03:
    Exit Sub

Err_calcTotals_03:
    MsgBox Error$
    Resume Exit_calcTotals_03


End Sub


Sub calcTotals_09()

' Author            : Christopher Sneddon
' Date              : 23 February 2009
' Reason            : New main form for 2009


On Error GoTo Err_calcTotals_09
Dim Rebate As Double
Dim Employerspayment As Double
Dim Employeespayment As Double
Dim Totalpayment As Double
Dim MyDynaTot As DAO.Recordset
Dim Diff As Double
Dim OverallTotalPayment As Double

'If !frmContributions2009!taxyear > 2008 Then
'With Forms![frmClass1_09]
'Else
With Forms![frmClass1_09]
'End If
'cater for user deleting these entires
    If IsNull(![txtNITotalInput]) Then
        ![txtNITotalInput] = 0
    End If
    If IsNull(![txtEENITotalInput]) Then
        ![txtEENITotalInput] = 0
    End If


    !TotalPay = !Contributions.Form!GrossPayTotal
    
    !TotalEmployeeNI = !Contributions.Form!EmployeeTotal
    !TotalEmployerNI = !Contributions.Form!EmployerTotal

'_______________________________________________________________________________________

' This section calculates the Employers Over/Under payment
'_______________________________________________________________________________________

    Employerspayment = ![TotalEmployerNI] - ![txtERNITotal]
    
    If Employerspayment < 0 Then
        ![ERContUnderPayment] = 0
        ![ERContOverPayment] = -(Employerspayment)
    Else
        ![ERContUnderPayment] = Employerspayment
        ![ERContOverPayment] = 0
    End If

    
'_______________________________________________________________________________________

' This section calculates the Employees Over/Under payment
'_______________________________________________________________________________________

    Employeespayment = ![TotalEmployeeNI] - ![txtEENITotalInput]
    
    If Employeespayment < 0 Then
        ![EEContUnderPayment] = 0
        ![EEContOverPayment] = -(Employeespayment)
    Else
        ![EEContUnderPayment] = Employeespayment
        ![EEContOverPayment] = 0
    End If



'_______________________________________________________________________________________

' This section calculates the Total Over/Under payment
'_______________________________________________________________________________________
    
    Totalpayment = (![TotalNI] - (![txtERNITotal] + ![txtEENITotalInput]))
    
    If Totalpayment < 0 Then
        ![TotalUnderPayment] = 0
        ![TotalOverPayment] = -(Totalpayment)
    Else
        ![TotalUnderPayment] = Totalpayment
        ![TotalOverPayment] = 0
    End If


'If there is an EE overpayment and an ER underpayment then there is no offset allowed of an EE 'refund against an ER debt.  In this case the totals are set to 0.
'However, an EE underpayment can be offset against an ER overpayment.

    If !EEContOverPayment > 0 And !ERContUnderPayment > 0 Then
        !TotalUnderPayment = 0
        !TotalOverPayment = 0
    End If

End With

Exit_calcTotals_09:
    Exit Sub

Err_calcTotals_09:
    MsgBox Error$
    Resume Exit_calcTotals_09


End Sub

Sub calcTotals_16()

' Author            : Christopher Sneddon
' Date              : 15 October 2015
' Reason            : New main form for 2016


On Error GoTo Err_calcTotals_16
Dim Rebate As Double
Dim Employerspayment As Double
Dim Employeespayment As Double
Dim Totalpayment As Double
Dim MyDynaTot As DAO.Recordset
Dim Diff As Double
Dim OverallTotalPayment As Double


With Forms![frmClass1_16]
'cater for user deleting these entires
    If IsNull(![txtNITotalInput]) Then
        ![txtNITotalInput] = 0
    End If
    If IsNull(![txtEENITotalInput]) Then
        ![txtEENITotalInput] = 0
    End If


    !TotalPay = !Contributions.Form!GrossPayTotal
    
    !TotalEmployeeNI = !Contributions.Form!EmployeeTotal
    !TotalEmployerNI = !Contributions.Form!EmployerTotal

'_______________________________________________________________________________________

' This section calculates the Employers Over/Under payment
'_______________________________________________________________________________________

    Employerspayment = ![TotalEmployerNI] - ![txtERNITotal]
    
    If Employerspayment < 0 Then
        ![ERContUnderPayment] = 0
        ![ERContOverPayment] = -(Employerspayment)
    Else
        ![ERContUnderPayment] = Employerspayment
        ![ERContOverPayment] = 0
    End If

    
'_______________________________________________________________________________________

' This section calculates the Employees Over/Under payment
'_______________________________________________________________________________________

    Employeespayment = ![TotalEmployeeNI] - ![txtEENITotalInput]
    
    If Employeespayment < 0 Then
        ![EEContUnderPayment] = 0
        ![EEContOverPayment] = -(Employeespayment)
    Else
        ![EEContUnderPayment] = Employeespayment
        ![EEContOverPayment] = 0
    End If



'_______________________________________________________________________________________

' This section calculates the Total Over/Under payment
'_______________________________________________________________________________________
    
    Totalpayment = (![TotalNI] - (![txtERNITotal] + ![txtEENITotalInput]))
    
    If Totalpayment < 0 Then
        ![TotalUnderPayment] = 0
        ![TotalOverPayment] = -(Totalpayment)
    Else
        ![TotalUnderPayment] = Totalpayment
        ![TotalOverPayment] = 0
    End If


'If there is an EE overpayment and an ER underpayment then there is no offset allowed of an EE 'refund against an ER debt.  In this case the totals are set to 0.
'However, an EE underpayment can be offset against an ER overpayment.

    If !EEContOverPayment > 0 And !ERContUnderPayment > 0 Then
        !TotalUnderPayment = 0
        !TotalOverPayment = 0
    End If

End With

Exit_calcTotals_16:
    Exit Sub

Err_calcTotals_16:
    MsgBox Error$
    Resume Exit_calcTotals_16


End Sub




Function GetContractedOutEarnings(Taxyear, TableUsed, Period, PeriodNumber, Category) As Double

            '''''''''''''''''''''''''''''''''''''''''
            ' AUTHOR : JASON CORDEY - I.T.S.A. 1995 '
            '''''''''''''''''''''''''''''''''''''''''
' History
' Author            : Mustaq Hussain
' Date              : 6 March 1996
' Purpose           : To take into account non-stepped Band changes, calling nMonthlyConversionvalue()
' History           : Jane Mullen
' Date              : 16 May 1997
' Purpose           : RFC 642B - Addition of F,G,S C/O categories
' History           : Chris Schuler
' Date              : 13 August 2004
' Purpose           : v1613864 - Incorrect result when gross pay falls in band 2

On Error GoTo Err_GetContractedOutEarnings

Dim ContractedOutIncome As Double
Dim conversionvalue As Double
Dim yearvalue As Integer
Dim LEL As Double
Dim UEL As Double
Dim LELEmployeeRate As Double
Dim EmployeeRate As Double
Dim Band2 As Double
Dim Band3 As Double
Dim Band4 As Double
Dim value As Double
Dim RoundedRate As Double
Dim strcat As String

' If calculation is not possible, exit the function.
If IsNull(Taxyear) Or IsNull(TableUsed) Or IsNull(Period) Or PeriodNumber = 0 Or IsNull(Category) Or IsNull(Earnings) Then
    GetContractedOutEarnings = 0
    Exit Function
End If

GetContractedOutEarnings = 0


' Convert the year into a number representation.
yearvalue = Val(Taxyear)

' Use the index to locate the year.
NIRateBandTable.Index = "PrimaryKey"
NIRateBandTable.Seek "=", yearvalue

' If the year is not found.
If NIRateBandTable.NoMatch Then

    GetContractedOutEarnings = 0
    Exit Function

Else
    With NIRateBandTable
    Select Case UCase$(Period)
    
    Case "W"
        
        ' Set the global bands.
        If IsNull(![Wk Band 1]) Then
            LEL = 0
        Else
            LEL = ![Wk Band 1]
        End If
        
        'If IsNull(![Wk Band 3]) Then   'v1613864
        If IsNull(![Wk Band 2]) Then
            Band2 = 0
        Else
            'Band2 = ![Wk Band 3]     'v1613864
            Band2 = ![Wk Band 2]
        End If
        
        If IsNull(![Wk Band 3]) Then
            Band3 = 0
        Else
            Band3 = ![Wk Band 3]
        End If
        
        If IsNull(![Wk Band 4]) Then
            Band4 = 0
        Else
            Band4 = ![Wk Band 4]
        End If
        
        If IsNull(![Wk Band 5]) Then
            UEL = 0
        Else
            UEL = ![Wk Band 5]
        End If
        
    Case "M"

        ' Set the global bands.
        If IsNull(![Mnth Band 1]) Then
            LEL = 0
        Else
            LEL = ![Mnth Band 1]
        End If
        
        'If IsNull(![Mnth Band 3]) Then    'v1613864
        If IsNull(![Mnth Band 2]) Then
            Band2 = 0
        Else
            'Band2 = ![Mnth Band 3]    'v1613864
            Band2 = ![Mnth Band 2]
        End If
        
        If IsNull(![Mnth Band 3]) Then
            Band3 = 0
        Else
            Band3 = ![Mnth Band 3]
        End If
        
        If IsNull(![Mnth Band 4]) Then
            Band4 = 0
        Else
            Band4 = ![Mnth Band 4]
        End If
        
        If IsNull(![Mnth Band 5]) Then
            UEL = 0
        Else
            UEL = ![Mnth Band 5]
        End If
        
    Case Else

        GetContractedOutEarnings = 0
        
        Exit Function
    
    End Select
    End With
End If

' Set increments for use with table calculations
If TableUsed = "Yes" Then
    
    Select Case Val(Taxyear)

    Case Is > 1986
        
        If Period = "W" Then
            conversionvalue = 0.5
        Else
            conversionvalue = nMonthlyConversionvalue(Earnings, LEL, Band2, Band3, Band4, UEL)
        End If

    Case Else
        
        If Period = "W" Then
            conversionvalue = 0.25
        Else
            conversionvalue = 1
        End If

    End Select

End If


    ' If no contribution is to be paid.
    If Earnings < LEL Then
        GetContractedOutEarnings = 0
        Exit Function
    End If
    


'_______________________________________________________________________________________

' This section will calculate the employees Contracted-out contribution
'_______________________________________________________________________________________

strcat = UCase$(Category)

If Not ((strcat = "D") Or (strcat = "E") Or (strcat = "F") Or (strcat = "G") Or (strcat = "S")) Then
   GetContractedOutEarnings = 0
    Exit Function
End If
'If (UCase$(Category) <> "E") And (UCase$(Category) <> "D") Then
'   GetContractedOutEarnings = 0
'    Exit Function
'End If
'This statement has changed to support F,G and S

If (Taxyear < 1978) Or ((Taxyear < 1991) And (UCase$(Category) = "E")) Then
    GetContractedOutEarnings = 0
    Exit Function
End If

'Determine which portion of the Gross Pay is to be used

ContractedOutIncome = Earnings

If ContractedOutIncome >= UEL Then
    ContractedOutIncome = UEL
    conversionvalue = 0
End If

ContractedOutIncome = (ContractedOutIncome - LEL)

GetContractedOutEarnings = ContractedOutIncome

Exit_GetContractedOutEarnings:
    Exit Function

Err_GetContractedOutEarnings:
    MsgBox Error$
    Resume Exit_GetContractedOutEarnings

End Function

Function GetContractedOutNI(Taxyear, TableUsed, Period, PeriodNumber, Category) As Double

            '''''''''''''''''''''''''''''''''''''''''
            ' AUTHOR : JASON CORDEY - I.T.S.A. 1995 '
            '''''''''''''''''''''''''''''''''''''''''
' History
' Author            : Mustaq Hussain
' Date              : 6 March 1996
' Purpose           : To take into account non-stepped Band changes, calling nMonthlyConversionvalue()

' History           : Jane Mullen
' Date              : 16 May 1997
' Purpose           : RFC 642B - Addition of F,G and S C/O categories
' History           : Chris Schuler
' Date              : 13 August 2004
' Purpose           : v1613864 - Incorrect result when gross pay falls in band 2
' History           : Chris Schuler
' Date              : 25 January 2005
' Purpose           : v1838323 - ERROR 'ITEM NOT FOUND IN THE COLLECTION'
' History           : Chris Schuler
' Date              : 4 May 2005
' Purpose           : v1930772 - Rounding correction to match actual tables


On Error GoTo Err_GetContractedOutNI

GetContractedOutNI = 0
Dim ContractedOutIncome As Double
Dim conversionvalue As Double
Dim yearvalue As Integer
Dim LEL As Double
Dim UEL As Double
Dim LELEmployeeRate As Double
Dim EmployeeRate As Double
Dim Band2 As Double
Dim Band3 As Double
Dim Band4 As Double
Dim value As Double
Dim RoundedRate As Double
Dim strcat As String

' If calculation is not possible, exit the function.
If IsNull(Taxyear) Or IsNull(TableUsed) Or _
   IsNull(Period) Or PeriodNumber = 0 Or _
   IsNull(Category) Or IsNull(Earnings) Then
   
    GetContractedOutNI = 0
    Exit Function
End If


GetContractedOutNI = 0


' Convert the year into a number representation.
yearvalue = Val(Taxyear)

' Use the index to locate the year.
NIRateBandTable.Index = "PrimaryKey"
NIRateBandTable.Seek "=", yearvalue

' If the year is not found.
If NIRateBandTable.NoMatch Then

    GetContractedOutNI = 0
    Exit Function

Else
    With NIRateBandTable
        Select Case UCase$(Period)
    
        Case "W"
            
            ' Set the global bands.
            If IsNull(![Wk Band 1]) Then
                LEL = 0
            Else
                LEL = ![Wk Band 1]
            End If
            
            If IsNull(![Wk Band 2]) Then 'v1613864
                Band2 = 0
            Else
                Band2 = ![Wk Band 2] 'v1613864
            End If
            
            If IsNull(![Wk Band 3]) Then
                Band3 = 0
            Else
                Band3 = ![Wk Band 3]
            End If
            
            If IsNull(![Wk Band 4]) Then
                Band4 = 0
            Else
                Band4 = ![Wk Band 4]
            End If
            
            If IsNull(![Wk Band 5]) Then
                UEL = 0
            Else
                UEL = ![Wk Band 5]
            End If
            
        Case "M"
    
            ' Set the global bands.
            If IsNull(![Mnth Band 1]) Then
                LEL = 0
            Else
                LEL = ![Mnth Band 1]
            End If
            
            If IsNull(![Mnth Band 2]) Then  'v1613864
                Band2 = 0
            Else
                Band2 = ![Mnth Band 2]  'v1613864
            End If
            
            If IsNull(![Mnth Band 3]) Then
                Band3 = 0
            Else
                Band3 = ![Mnth Band 3]
            End If
            
            If IsNull(![Mnth Band 4]) Then
                Band4 = 0
            Else
                Band4 = ![Mnth Band 4]
            End If
            
            If IsNull(![Mnth Band 5]) Then
                UEL = 0
            Else
                UEL = ![Mnth Band 5]
            End If
            
        Case Else
    
            GetContractedOutNI = 0
            Exit Function
            
        End Select
    End With
End If

' Set increments for use with table calculations
If TableUsed = "Yes" Then
    
    Select Case Val(Taxyear)

    Case Is > 1986
        
        If Period = "W" Then
            conversionvalue = 0.5
        Else
            conversionvalue = nMonthlyConversionvalue(Earnings, LEL, Band2, Band3, Band4, UEL)
        End If

    Case Else
        
        If Period = "W" Then
            conversionvalue = 0.25
        Else
            conversionvalue = 1
        End If

    End Select

End If

' Use the correct index to locate the year.
Select Case UCase$(Period)
Case "M"
    Class1RateTable.Index = "MonthIndex"
Case "W"
    Class1RateTable.Index = "WeekIndex"
End Select
Class1RateTable.Seek "<=", yearvalue, Category, PeriodNumber

' If the year is not found.
If Class1RateTable.NoMatch Then

    GetContractedOutNI = 0
    Exit Function

Else

    ' If no contribution is to be paid.
    If Earnings < LEL Then
        GetContractedOutNI = 0
        Exit Function
    End If

    If (Taxyear < 1985) Or ((Taxyear = 1985) And (Class1RateTable![start week] < 27)) Then
    
        Select Case Category
    
        Case "C"
    
            GetContractedOutNI = 0
            Exit Function
            
        Case "A", "B", "D", "E"
        
            LELEmployeeRate = Class1RateTable![Up to LEL1 (employee)]
            EmployeeRate = Class1RateTable![Employee Rte 1]
            GoTo CalcCOcont
        
        End Select
    
    End If

    If (Taxyear < 1989) Or ((Taxyear = 1989) And (Class1RateTable![start week] < 27)) Then
    
        Select Case Category
    
        Case "A", "C", "D"
        
            
            If Earnings >= LEL And Earnings < Band2 Then

                LELEmployeeRate = Class1RateTable![Up to LEL1 (employee)] 'v1838323 amended LEL to LEL1
                EmployeeRate = Class1RateTable![Employee Rte 1]
            
            End If
            
            If (Earnings >= Band2) And (Earnings < Band3) Then
                
                LELEmployeeRate = Class1RateTable![Up to LEL2 (employee)]
                EmployeeRate = Class1RateTable![employee rte 2]

            End If
        
            If (Earnings >= Band3) And (Earnings < Band4) Then

                LELEmployeeRate = Class1RateTable![Up to LEL3 (employee)]
                EmployeeRate = Class1RateTable![employee rte 3]

            End If
        
            If (Earnings >= Band4) Then

                LELEmployeeRate = Class1RateTable![Up to LEL4 (employee)]
                EmployeeRate = Class1RateTable![Employee Rte 4]
            End If
            
        Case "B", "E"
        
            LELEmployeeRate = Class1RateTable![Up to LEL1 (employee)]
            EmployeeRate = Class1RateTable![Employee Rte 1]
    
        End Select
    
    End If

    If (Taxyear > 1989) Or ((Taxyear = 1989) And (Class1RateTable![start week] > 26)) Then
    
        Select Case Category
    
        Case "C"
    
            GetContractedOutNI = 0
            Exit Function
    
        Case Else
    
            LELEmployeeRate = Class1RateTable![Up to LEL1 (employee)]
            EmployeeRate = Class1RateTable![Employee Rte 1]
    
        End Select
    
    End If
    
End If


CalcCOcont:

'_______________________________________________________________________________________

' This section will calculate the employees Contracted-out contribution
'_______________________________________________________________________________________

strcat = UCase$(Category)
If Not ((strcat = "D") Or (strcat = "E") Or (strcat = "F") Or (strcat = "G") Or (strcat = "S")) Then
    GetContractedOutNI = 0
    Exit Function
End If

'If (UCase$(Category) <> "E") And (UCase$(Category) <> "D") Then
'    GetContractedOutNI = 0
'    Exit Function
'End If
'This statement has been changed to support F, G and S

If (Taxyear < 1978) Or ((Taxyear < 1991) And (UCase$(Category) = "E")) Then
    GetContractedOutNI = 0
    Exit Function
End If

'Determine which portion of the Gross Pay is to be used

If Earnings > LEL Then
    ContractedOutIncome = Earnings + conversionvalue
Else
    ContractedOutIncome = Earnings
End If

If ContractedOutIncome >= UEL Then
    ContractedOutIncome = UEL
    conversionvalue = 0
End If

ContractedOutIncome = (ContractedOutIncome - LEL)

value = curRound(ContractedOutIncome * EmployeeRate) 'v1930772
'value = ContractedOutIncome * EmployeeRate
'value = Int(value * 1000) / 1000

If UEL = -1 Or UEL = LEL Then

    If (value * 100) - Int(value * 100) >= 0.6 Then
        RoundedRate = CCur((CLng(value * 1000)) / 1000)
        ContractedOutIncome = CCur((CLng(RoundedRate * 100)) / 100)
    Else
        ContractedOutIncome = CCur((Int(value * 100)) / 100)
    End If

Else
    
    If ((value) * 100) - Int(((value) * 100)) >= 0.6 Then
        RoundedRate = CCur((CLng(value * 1000)) / 1000)
        ContractedOutIncome = CCur((CLng(RoundedRate * 100)) / 100)
    Else
        ContractedOutIncome = CCur((Int((value) * 100)) / 100)
    End If

End If


GetContractedOutNI = ContractedOutIncome


Exit_GetContractedOutNI:
    Exit Function

Err_GetContractedOutNI:
    MsgBox Error$
    Resume Exit_GetContractedOutNI


End Function

Function GetEarnings(Taxyear, TableUsed, Period, PeriodNumber, Category, GrossPay) As Double

            '''''''''''''''''''''''''''''''''''''''''
            ' AUTHOR : JASON CORDEY - I.T.S.A. 1995 '
            '''''''''''''''''''''''''''''''''''''''''
' History
' Author            : Mustaq Hussain
' Date              : 6 March 1996
' Purpose           : To take into account non-stepped Band changes, in WHILE LOOP

On Error GoTo Err_GetEarnings

Dim yearvalue As Integer
Dim stepvalue As Double
Dim LastGrossPay As Double
Dim LEL As Double
Dim UEL As Double
Dim stepincrement As Double
Dim conversionvalue As Double
Dim Initialvalue As Double

AdjustedMinimumFlag = 0
Earnings = 0

' If calculation is not possible, exit the function.
If IsNull(Taxyear) Or IsNull(TableUsed) Or IsNull(Period) Or PeriodNumber = 0 Or IsNull(Category) Or IsNull(GrossPay) Then
    GetEarnings = 0
    Exit Function
End If

' Convert the year into a number representation.
yearvalue = Val(Taxyear)

' Use the index to locate the year.
NIRateBandTable.Index = "PrimaryKey"
NIRateBandTable.Seek "=", yearvalue

' If the year is not found.
If NIRateBandTable.NoMatch Then

    GetEarnings = 0
    Exit Function

Else
    
        Select Case UCase$(Period)
    
        Case "W"
            
            ' Set the global bands.
            LEL = NIRateBandTable![Wk Band 1]
            UEL = NIRateBandTable![Wk Band 5]
            
            stepvalue = LEL
            Initialvalue = LEL
    
            ' Set incriments for use with table calculation.
            If Taxyear > 1986 Then
                stepincrement = 1
                conversionvalue = 0.5
            Else
                stepincrement = 0.5
                conversionvalue = 0.25
            End If
    
        Case "M"
    
            ' Set the global bands.
            LEL = NIRateBandTable![Mnth Band 1]
            UEL = NIRateBandTable![Mnth Band 5]
            
            stepvalue = Int(LEL)
            Initialvalue = Int(LEL)
    
            ' Set incriments for use with table calculation.
            If Taxyear > 1986 Then
                stepincrement = 4
                conversionvalue = 2
            Else
                stepincrement = 2
                conversionvalue = 1
            End If
    
        Case Else
    
            GetEarnings = 0
            Exit Function
            
        End Select
    
End If

' If no contribution is to be paid.
If GrossPay < LEL Then
    
    ' No payments required.
    GetEarnings = 0

Else

    ' If using the tables.
    If TableUsed = "Yes" Then
        
        ' Assign the first step from the minimum level.
        'StepValue = LEL
                                                
        Do While True
            
            ' Increase the value.
            stepvalue = stepvalue + stepincrement
            
            ' If the GrossPay is less than the first step.
            If (GrossPay < Initialvalue + stepincrement) Then
                If Taxyear < 1978 Then
                    Earnings = ((LEL + stepvalue) / 2)
                    AdjustedMinimumFlag = 1
                    Exit Do
                Else
                    If Taxyear < 1987 Then
                        If GrossPay = LEL Then
                            Earnings = LEL
                            Exit Do
                        Else
                            Earnings = ((LEL + stepvalue) / 2)
                            AdjustedMinimumFlag = 1
                            Exit Do
                        End If
                    Else
                        Earnings = LEL
                        Exit Do
                    End If
                End If
            
                ' Set earnings to minimum level.
                'Earnings = LEL
                
                ' Terminate out of the loop.
                'Exit Do
            End If

            If GrossPay >= UEL Then
                
                ' Calculate earnings based on the maximum level.
                Earnings = UEL
            
                ' Terminate out of the loop.
                Exit Do
            
            End If


' If at Band change, which handles non-step change of bands
If GrossPay = NIRateBandTable![Mnth Band 1] Or GrossPay = NIRateBandTable![Mnth Band 3] Or GrossPay = NIRateBandTable![Mnth Band 3] Or GrossPay = NIRateBandTable![Mnth Band 4] Or GrossPay = NIRateBandTable![Mnth Band 5] Then

    Earnings = GrossPay
    
    ' Terminate out of the loop.
    Exit Do

End If

            
            ' If this is the first value above the GrossPay on the table.
            If stepvalue > GrossPay Then
                
                ' Calculate earnings based on the step before, plus the increment.
                Earnings = LastGrossPay
            
                ' Terminate out of the loop.
                Exit Do

            End If


            ' Store the last GrossPay found.
            LastGrossPay = stepvalue
    
        Loop
    
    Else

        ' Restrict earnings to maximum level, otherwise leave as is.
        If GrossPay > UEL Then
            
            Earnings = UEL
        
        Else
            
            Earnings = GrossPay
        
        End If

    End If

End If

' Return the earnings.
If Category = "C" Then
    GetEarnings = 0
    Else
    GetEarnings = Earnings
End If

Exit_GetEarnings:
    Exit Function

Err_GetEarnings:
    MsgBox Error$
    Resume Exit_GetEarnings

End Function

Function GetEE_ETToER_ET(TableUsed, Period, GrossPay, EE_ET, ER_ET)

' Author            : Christopher Schuler
' Date              : 12 November 1999
' Purpose           : To return the amount of grosspay from EE.ET up to ER.ET

On Error GoTo Err_GetEE_ETToER_ET


Dim EE_ETToER_ET As Double     'Employee Earnings Threshold to Employer Earnings Threshold

Dim GrossPayStep As Double






    ' If using the tables.
If TableUsed = "Yes" Then
                                                
        'calculate the step value
        Select Case UCase$(Period)
    
        Case "W", "4w"
         GrossPayStep = Int(GrossPay)
        Case "M"
         GrossPayStep = (Int((GrossPay - 3) / 4) * 4) + 3
    
        End Select
         

        'Calculate EE_ETToER_ET

            If GrossPay >= ER_ET Then
                
                GrossPayStep = ER_ET
            
            End If
            
            If GrossPayStep < EE_ET And GrossPay > EE_ET Then
                
                GrossPayStep = EE_ET
            
            End If

            If GrossPayStep > EE_ET And GrossPayStep <= ER_ET Then
            
                EE_ETToER_ET = GrossPayStep - EE_ET
        
            End If
        
Else

        'Calculate EE_ETToER_ET
    
    If GrossPay <= EE_ET Then
            
            EE_ETToER_ET = 0

         ElseIf GrossPay > EE_ET And GrossPay <= ER_ET Then
    
            EE_ETToER_ET = GrossPay - EE_ET

        ElseIf GrossPay > ER_ET Then

            EE_ETToER_ET = ER_ET - EE_ET

    End If

End If

' Return the earnings.
GetEE_ETToER_ET = Int(EE_ETToER_ET)


Exit_GetEE_ETToER_ET:
    Exit Function

Err_GetEE_ETToER_ET:
    MsgBox Error$
    Resume Exit_GetEE_ETToER_ET




End Function

Function GetEEConts(Taxyear, TableUsed, Period, PeriodNumber, Category, GrossPay)

' Author            : Christopher Schuler
' Date              : 29 July 1999
' Purpose           : To return the amount of employee contributions (1999)

On Error GoTo Err_GetEEConts

Dim yearvalue As Integer
Dim stepvalue As Double
Dim LastGrossPay As Double
Dim LEL As Double    'Lower Earnings Limit
Dim ET_PT As Double  'Earnings Threshold
Dim ST As Double     'Secondary Threshold
Dim UEL As Double    'Upper Earnings Limit
Dim UpToLEL As Double       'To Lower Earnings limit
Dim LELtoET As Double     'Lower Earnings Limit to Earnings Threshold
Dim ETtoUEL As Double     'Earnings Threshold to Upper Earnings Limit
Dim RateEE                  'Employee rate of NI contributions
Dim EEConts As Double     'Employee's contributions
Dim GrossPayStep As Double     'Value of GrossPay which would be looked up in NIC tables
Dim stepincrement As Double    'Incremental step in NIC tables
Dim MidpointAdjustment           'Added to EEConts to replicate NIC tables


' If calculation is not possible, exit the function.
If IsNull(Taxyear) Or IsNull(TableUsed) Or IsNull(Period) Or _
   PeriodNumber = 0 Or IsNull(Category) Or IsNull(GrossPay) Then
   
    GetEEConts = 0
    Exit Function
End If

' Convert the year into a number representation.
yearvalue = Val(Forms!PCGForm.Taxyear)

' Use the index to locate the year.
NIRateBandTable.Index = "PrimaryKey"
NIRateBandTable.Seek "=", yearvalue

' If the year is not found.
If NIRateBandTable.NoMatch Then

    GetEEConts = 0
    Exit Function

Else

    Select Case UCase$(Period)

    Case "W"
        
        ' Set the global bands.
        LEL = NIRateBandTable![WkLEL]
        ET_PT = NIRateBandTable![WkER_ET]
        UEL = NIRateBandTable![WkUEL]
        
        stepincrement = 1
        
    Case "M"

        ' Set the global bands.
        LEL = NIRateBandTable![MnthLEL]
        ET_PT = NIRateBandTable![MnthER_ET]
        UEL = NIRateBandTable![MnthUEL]
        
        stepincrement = 4
        
    Case Else

        GetEEConts = 0
        Exit Function
        
    End Select

End If


Class1RateTable.Index = "PrimaryKey"

'Class1RateTable.Seek "<=", YearValue, Category, PeriodNumber
Class1RateTable.Seek "<=", yearvalue, Category

' If the year is not found.
If Class1RateTable.NoMatch Then

    GetEEConts = 0
    Exit Function

Else
    'EmployeeRate
    RateEE = Class1RateTable![EE_Rate]

    Select Case UCase$(Period)

    Case "W"
    MidpointAdjustment = RateEE / 2
    Case "M"
    MidpointAdjustment = RateEE * 2

    End Select
End If

If GrossPay < LEL Or GrossPay >= UEL Then
    GoTo NextPartEE
Else
    stepvalue = LEL - stepincrement
End If
            

    ' If using the tables.
If TableUsed = "Yes" Then
    If Category = "A" Or Category = "D" Or Category = "F" Then
                     
            'A minimum contribution must be paid.
        If GrossPay > LEL And GrossPay < LEL + stepincrement Then
                              
            EEConts = 0.01
                               
            GoTo LastPart
        
        End If
    
    End If

    LastGrossPay = stepvalue
                                                

  'Alternative method
    Select Case UCase$(Period)

    Case "W"
     GrossPayStep = Int(GrossPay)
    Case "M"
     GrossPayStep = (Int((GrossPay - 2) / 4) * 4) + 2

    End Select

    'Calculate EEConts
    
    'Employee Contributions
      If EEConts <> 0.01 Then
            If Period = "W" Then

                Select Case Category
                Case "E"
                    If (GrossPayStep + stepincrement) = ET_PT And GrossPay < ET_PT Then
                        MidpointAdjustment = 0.02
                    End If
                    
                End Select

            End If

            If Period = "M" Then
                Select Case Category
                Case "A"
                    If (GrossPayStep + stepincrement) > ET_PT And GrossPay < ET_PT Then
                        MidpointAdjustment = 0.15
                    End If
                    If GrossPayStep <= ET_PT And GrossPay >= ET_PT Then
                        MidpointAdjustment = 0.35
                    End If
                    If (GrossPayStep + stepincrement) > UEL And GrossPay < UEL Then
                        MidpointAdjustment = 0.05
                    End If
    
                Case "B", "E", "G"
                    If (GrossPayStep + stepincrement) > ET_PT And GrossPay < ET_PT Then
                        MidpointAdjustment = 0.06
                    End If
                    If GrossPayStep <= ET_PT And GrossPay >= ET_PT Then
                        MidpointAdjustment = 0.14
                    End If
                    If (GrossPayStep + stepincrement) > UEL And GrossPay < UEL Then
                        MidpointAdjustment = 0.02
                    End If
    
                Case "D", "F"
                    If (GrossPayStep + stepincrement) > ET_PT And GrossPay < ET_PT Then
                        MidpointAdjustment = 0.12
                    End If
                    If GrossPayStep <= ET_PT And GrossPay >= ET_PT Then
                        MidpointAdjustment = 0.29
                    End If
                    If (GrossPayStep + stepincrement) > UEL And GrossPay < UEL Then
                        MidpointAdjustment = 0.04
                    End If
    
                End Select

            End If

            If GrossPayStep <= LEL Then
            
                EEConts = 0
            
                ElseIf GrossPayStep > LEL And GrossPayStep < UEL Then
                      'Tables appear to take first 3 sig. figs. after decimal point
                    EEConts = Int(((GrossPayStep - LEL) * RateEE + MidpointAdjustment) * 1000) / 1000
            
                ElseIf GrossPayStep >= UEL Then
            
                    EEConts = (UEL - LEL) * RateEE
            
            End If
      End If
Else

NextPartEE:

        'Employee Contributions
        If GrossPay > LEL And GrossPay < (LEL + 0.05) Then
            If Category = "A" Or Category = "D" Or Category = "F" Then
                EEConts = 0.01
            Else
                EEConts = 0
            End If
        Else
            If GrossPay <= LEL Then
            
                EEConts = 0
            
                ElseIf GrossPay > LEL And GrossPay <= UEL Then
            
                    EEConts = (GrossPay - LEL) * RateEE
            
                ElseIf GrossPay > UEL Then
            
                    EEConts = (UEL - LEL) * RateEE
            
            End If
       End If
End If
LastPart:
' CA Rounding
GetEEConts = curRound(EEConts)



Exit_GetEEconts:
    Exit Function

Err_GetEEConts:
    MsgBox Error$
    Resume Exit_GetEEconts


End Function

Public Function GetConts(ByRef Taxyear As Integer, _
                            ByRef DataTable, _
                            ByRef TableUsed, _
                            ByRef Category, _
                            ByRef Period, _
                            ByRef ST, _
                            ByRef ET_PT, _
                            ByRef UAP, _
                            ByRef UST, _
                            ByRef UEL, _
                            ByRef GrossPay, _
                            ByRef calcType)
                              
'   Author  :   Ben Stephenson
'   Date    :   16/06/2011
'   Project :   CCA10512
'   Desc    :   Total the contributions between given thresholds for employee or employer
                              
                              
On Error GoTo Err_GetConts

Dim Rate As Double            ' Employee rate of NI contributions
Dim Rate_AboveUAP As Double   ' Employee rate of NI conts above UAP
Dim Rate_AboveUST As Double   ' Employee rate of NI conts above UST
Dim Rate_AboveUEL As Double   ' Employee rate of NI contributions above UEL
Dim Conts As Double           ' Total Contributions
Conts = 0

Dim MidpointAdjustment
Dim MidPointAdjustmentUAP
Dim MidPointAdjustmentUST

Dim GrossPayStep

' If calculation is not possible, exit the function.
If IsNull(Taxyear) Or IsNull(TableUsed) Or _
   IsNull(Category) Or IsNull(Period) Or IsNull(GrossPay) Then
    
    GetConts = 0
    Exit Function
End If

' Use the index to locate the year.
Class1RateTable.Index = "PrimaryKey"

Class1RateTable.Seek "<=", Taxyear, Category

' If the year is not found.
If Class1RateTable.NoMatch Then

    GetConts = 0
    Exit Function
Else

    If calcType = cEmployee Then
        'EmployeeRate
        Rate = Class1RateTable![EE_Rate]
        Rate_AboveUAP = Class1RateTable![EE_AboveUAP]
        Rate_AboveUEL = Class1RateTable![EE_AboveUEL]
        
    ElseIf calcType = cEmployer Then
        Rate = Class1RateTable![ER_Rate]
        Rate_AboveUAP = Class1RateTable![ER_AboveUAP]
        
        If Taxyear > 2014 And InStr("MIKZ", Category) Then
            Rate_AboveUST = Class1RateTable![ER_AboveUST]
            Rate_AboveUEL = Class1RateTable![ER_AboveUEL]
        Else
            Rate_AboveUEL = Class1RateTable![ER_AboveUEL]
        End If
    End If
    
    Select Case UCase$(Period)
    Case "W"
        MidpointAdjustment = Rate / 2
        MidPointAdjustmentUAP = Rate_AboveUAP / 2
    Case "M"
        MidpointAdjustment = Rate * 2
        MidPointAdjustmentUAP = Rate_AboveUAP * 2
    End Select
    
End If

' If we are using a Table calc and the earnings lie between the LEL And the UEL
' we need to compare to Earnings Steps to determine the amount of NICs owed.
' If not, then we can just use the direct percentage method
If TableUsed = "Yes" And _
   ((calcType = cEmployer And GrossPay >= ST) Or _
    (calcType = cEmployee And GrossPay >= ET_PT) Or _
    GrossPay < UEL) Then
   
   ' Determine the step value
    Select Case UCase$(Period)
    Case "W"
        GrossPayStep = Int(GrossPay)
        If GrossPayStep = ST Then
            MidpointAdjustment = 0
        End If
        If GrossPayStep = ET_PT Then
            MidpointAdjustment = 0
        End If
        If GrossPayStep = UAP Then
            MidPointAdjustmentUAP = 0
        End If
        
        If Taxyear > 2014 And InStr("MIKZ", Category) Then ' USTcsne
            If GrossPayStep = UST Then
                MidPointAdjustmentUST = 0
            End If
        End If
        
    Case "M"
    
        'If taxyear > 2014 And InStr("MIKZ", Category) Then
        '    GrossPayStep = UST
        If GrossPay = UEL Then
            GrossPayStep = UEL
        Else
            GrossPayStep = GrossPayStepMonthly(Taxyear, GrossPay)
        End If
        
        stepincrement = 4
        
        If GrossPayStep = ET_PT Or GrossPayStep = ST Then
            'GrossPayStep = UAP
            MidpointAdjustment = 0
        End If
        
        ' CCA10940 - ST PT SWITCH
        'If ET_PT > ST Then
            If GrossPayStep + stepincrement > ET_PT And GrossPayStep < ET_PT Then
                If GrossPay < ET_PT Then
                    MidpointAdjustment = MidpointAdjustment / 2
                End If
            End If
        'Else
            If GrossPayStep + stepincrement > ST And GrossPayStep < ST Then
                If GrossPay < ST Then
                    MidpointAdjustment = MidpointAdjustment / 2
                End If
            End If
        'End If
        
        If GrossPay >= UAP And GrossPayStep < UAP Then
            GrossPayStep = UAP
            MidPointAdjustmentUAP = 0
        End If
        
        If GrossPayStep < UAP And GrossPay >= UAP Then
            MidpointAdjustment = MidpointAdjustment * 3 / 2
            MidPointAdjustmentUAP = MidPointAdjustmentUAP * 3 / 2
        End If
        
        If (GrossPayStep) > UAP And GrossPay < UAP Then
            MidpointAdjustment = MidpointAdjustment / 2
        End If
                                  
        If Taxyear > 2010 Then
            If (GrossPayStep + stepincrement) > UAP And GrossPay < UAP Then
                MidpointAdjustment = MidpointAdjustment * 3 / 4
            End If

        Else
            If (GrossPayStep + stepincrement) > UAP And GrossPay < UAP Then
                MidpointAdjustment = MidpointAdjustment / 4
                MidPointAdjustmentUAP = MidPointAdjustmentUAP / 4
            End If
            If GrossPay >= UAP And GrossPay < (UAP + stepincrement) Then
                MidPointAdjustmentUAP = 0
            End If
        End If
        
        'If taxyear > 2014 And InStr("MIKZ", Category) And calcType = cEmployer Then
        
        If (GrossPayStep + stepincrement) > UST And GrossPay < UST And Taxyear > 2014 And InStr("MIKZ", Category) And calcType = cEmployer Then
            MidPointAdjustmentUAP = MidPointAdjustmentUAP * 3 / 4
            
            
            ' Test addition for the UST additions
            'If (GrossPayStep + stepincrement) > UST And GrossPay < UST Then
            'MidPointAdjustmentUAP = MidPointAdjustmentUAP * 3 / 4
            'End If
            
        
        ElseIf (GrossPayStep + stepincrement) > UEL And GrossPay < UEL Then
        
            MidPointAdjustmentUAP = MidPointAdjustmentUAP * 3 / 4

        End If
    End Select

    If Taxyear > 2010 And calcType = cEmployer Then

        ' For earnings below ST
        If GrossPayStep <= ST Then
            Conts = 0
        
        ' For earnings ST to PT
        ElseIf GrossPayStep > ST And GrossPayStep < ET_PT Then
            Conts = curRound((GrossPayStep - ST) * Rate + MidpointAdjustment)
        
        ' For earnings PT to UAP
        ElseIf GrossPayStep < UAP Then
            Conts = curRound((ET_PT - ST) * Rate) + _
                    curRound(((GrossPayStep - ET_PT) * Rate) + MidpointAdjustment)
        End If
       ' Split on UST for 2015
        If Taxyear > 2014 And InStr("MIKZ", Category) Then
            ' For earnings AboveUST
              If GrossPayStep >= UST Then
                    'Deal with the CCA10970 changes
                    'If ET_PT > ST Then
                        Conts = curRound((ET_PT - ST) * Rate) + _
                            curRound((UAP - ET_PT) * Rate) + _
                            curRound((UST - UAP) * Rate_AboveUAP) + _
                            curRound(Int((GrossPay - UST)) * Rate_AboveUST)
                    'Else
                     '   Conts = curRound((ST - ET_PT) * Rate) + _
                      '      curRound((UAP - ST) * Rate) + _
                       '     curRound((UST - UAP) * Rate_AboveUAP) + _
                        '    curRound(Int((GrossPay - UST)) * Rate_AboveUST)
                    'End If
                    
                    If GrossPayStep >= UEL Then
                       ' If ET_PT >= ST Then
                        Conts = curRound((ET_PT - ST) * Rate) + _
                            curRound((UAP - ET_PT) * Rate) + _
                            curRound((UEL - UAP) * Rate_AboveUAP) + _
                            curRound(Int((GrossPay - UEL)) * Rate_AboveUEL)
                        'Else
                        'Conts = curRound((ST - ET_PT) * Rate) + _
                         '   curRound((UAP - ST) * Rate) + _
                          '  curRound((UEL - UAP) * Rate_AboveUAP) + _
                           ' curRound(Int((GrossPay - UEL)) * Rate_AboveUEL)
                        'End If
                    End If
                    
               End If
        Else
            If GrossPayStep >= UAP And GrossPayStep < UEL Then
               ' If ET_PT >= ST Then
                    'Tables appear to take first 3 sig. figs. after decimal point
                    Conts = curRound((ET_PT - ST) * Rate) + _
                    curRound((UAP - ET_PT) * Rate) + _
                    curRound(((GrossPayStep - UAP) * Rate_AboveUAP) + MidPointAdjustmentUAP)
                'Else
                  '  Conts = curRound((ST - ET_PT) * Rate) + _
                 '   curRound((UAP - ST) * Rate) + _
                  '  curRound(((GrossPayStep - UAP) * Rate_AboveUAP) + MidPointAdjustmentUAP)
                'End If
                            
        ' For earnings AboveUEL
        ElseIf GrossPayStep >= UEL Then
               ' If ET_PT > ST Then
                    Conts = curRound((ET_PT - ST) * Rate) + _
                    curRound((UAP - ET_PT) * Rate) + _
                    curRound((UEL - UAP) * Rate_AboveUAP) + _
                    curRound(Int((GrossPay - UEL)) * Rate_AboveUEL)
                'Else
                 '   Conts = curRound((ST - ET_PT) * Rate) + _
                  '  curRound((UAP - ST) * Rate) + _
                   ' curRound((UEL - UAP) * Rate_AboveUAP) + _
                    'curRound(Int((GrossPay - UEL)) * Rate_AboveUEL)
                'End If
            End If
        End If
    
    Else
        ' For earnings below PT
        If GrossPayStep <= ET_PT Then
            Conts = 0
        
        ' For earnings PT to UAP
        ElseIf GrossPayStep < UAP Then
            Conts = curRound(((GrossPayStep - ET_PT) * Rate) + MidpointAdjustment)
            
        ' For earnings UAP-UEL
        
        ElseIf Taxyear > 2008 Then
        
            ' Additions for CCA10930
            If Taxyear > 2014 And InStr("MIKZ", Category) And calcType = cEmployer Then
            
                'If ET_PT >= ST Then
                
               '     If GrossPayStep >= UAP And GrossPayStep < UST Then
                    'Tables appear to take first 3 sig. figs. after decimal point
                '        Conts = curRound(((UAP - ET_PT) * Rate)) + _
                  '              curRound(((GrossPayStep - UAP) * Rate_AboveUAP)) + _
                 '               MidPointAdjustmentUAP
                  '  ElseIf GrossPayStep >= UST And GrossPayStep < UEL Then
                  '      Conts = curRound(((UAP - ET_PT) * Rate)) + _
                  '              curRound(((UST - UAP) * Rate_AboveUAP)) + _
                  '              (Int((GrossPay - UST)) * Rate_AboveUST)
                  '  ElseIf GrossPayStep >= UEL Then
                  '      Conts = curRound(((UAP - ET_PT) * Rate)) + _
                  '              curRound(((UEL - UAP) * Rate_AboveUAP)) + _
                   '             curRound(((UST - UAP) * Rate_AboveUST)) + _
                   '             (Int((GrossPay - UEL)) * Rate_AboveUEL)
                   ' End If
                'Else 'CCA10970
                    If GrossPayStep >= UAP And GrossPayStep < UST Then
                        'Tables appear to take first 3 sig. figs. after decimal point
                        Conts = curRound(((UAP - ST) * Rate)) + _
                                curRound(((GrossPayStep - UAP) * Rate_AboveUAP)) + _
                                MidPointAdjustmentUAP
                    ElseIf GrossPayStep >= UST And GrossPayStep < UEL Then
                        Conts = curRound(((UAP - ST) * Rate)) + _
                                curRound(((UST - UAP) * Rate_AboveUAP)) + _
                                (Int((GrossPay - UST)) * Rate_AboveUST)
                    ElseIf GrossPayStep >= UEL Then
                        Conts = curRound(((UAP - ST) * Rate)) + _
                                curRound(((UEL - UAP) * Rate_AboveUAP)) + _
                                curRound(((UST - UAP) * Rate_AboveUST)) + _
                                (Int((GrossPay - UEL)) * Rate_AboveUEL)
                    End If
                'End If
            Else
                If GrossPayStep >= UAP And GrossPayStep < UEL Then
                    If ET_PT >= ST Then
                        'Tables appear to take first 3 sig. figs. after decimal point
                        Conts = curRound(((UAP - ET_PT) * Rate)) + _
                        curRound(((GrossPayStep - UAP) * Rate_AboveUAP)) + _
                        MidPointAdjustmentUAP
                    Else
                        'Tables appear to take first 3 sig. figs. after decimal point
                        Conts = curRound(((UAP - ST) * Rate)) + _
                        curRound(((GrossPayStep - UAP) * Rate_AboveUAP)) + _
                        MidPointAdjustmentUAP
                    End If
                    
                ElseIf GrossPayStep >= UEL Then
                    'CCA10970
                    If ET_PT >= ST Then
                        Conts = curRound(((UAP - ET_PT) * Rate)) + _
                        curRound(((UEL - UAP) * Rate_AboveUAP)) + _
                        (Int((GrossPay - UEL)) * Rate_AboveUEL)
                    Else
                        Conts = curRound(((UAP - ST) * Rate)) + _
                        curRound(((UEL - UAP) * Rate_AboveUAP)) + _
                        (Int((GrossPay - UEL)) * Rate_AboveUEL)
                    End If
                End If
            End If
                     
        'CSNE_2012 Additional areas to deal with UAP/PT/UEL differences
        ElseIf Taxyear < 2009 Then
             If GrossPayStep > ET_PT And GrossPayStep < UEL Then
            'Tables appear to take first 3 sig. figs. after decimal point
                'Conts = curRound(((GrossPayStep - ET_PT) * Rate)) + _
                        MidpointAdjustment
                        
                Conts = Int(1000 * (((GrossPayStep - ET_PT) * Rate) + MidpointAdjustment)) / 1000
           
           ElseIf GrossPayStep >= UEL Then
                Conts = curRound(((UEL - ET_PT) * Rate)) + _
                        (Int((GrossPay - UEL)) * Rate_AboveUEL)
            End If

        ' For earnings AboveUEL
        ElseIf GrossPayStep >= UEL Then
            Conts = curRound(((UAP - ET_PT) * Rate)) + _
                    curRound(((UEL - UAP) * Rate_AboveUAP)) + _
                    (Int((GrossPay - UEL)) * Rate_AboveUEL)
        End If
    
    End If

Else
' Else, Use the Percentage method
    With DataTable
        If Taxyear > 2008 Then
            
            If GrossPay <= ST Then
                Conts = 0
            ElseIf calcType = cEmployee Then
                Conts = Conts + (![ETtoUAP] * Rate)
            'ElseIf GrossPay <= ST Then
            '    Conts = 0
            Else
                Conts = Conts + (![STToUAP] * Rate)
            End If
                If Taxyear > 2014 And InStr("MIKZ", Category) And calcType = cEmployer Then
                    Conts = Conts + (![UAPToUST] * Rate_AboveUST)
                Else
                    Conts = Conts + (![UAPToUEL] * Rate_AboveUAP)
                End If
            If GrossPay >= UEL Then
                Conts = Conts + ((GrossPay - UEL) * Rate_AboveUEL)
            End If
        If Taxyear > 2010 Then
                'If we are totalling the employer Cont, we need to include STtoPT
                If calcType = cEmployer Then
                    'If ST >= ET_PT Then
                     '   Conts = Conts + (![STToPT] * Rate)
                    'Else
                        
                        Conts = Conts - ((ST - ET_PT) * Rate)
                    'End If
                End If
        End If
        
        Else 'Pre 2008 Calc
            Conts = (GrossPay - ET_PT) * Rate
            If GrossPay >= UEL Then
                Conts = (UEL - ET_PT) * Rate
                Conts = Conts + ((GrossPay - UEL) * Rate_AboveUEL)
            ElseIf GrossPay <= ET_PT Then
                Conts = 0
            End If
        End If
    End With
End If



GetConts = curRound(Conts)
'GetConts = Conts

Exit_GetConts:
    Exit Function

Err_GetConts:
    MsgBox Error$
    Resume Exit_GetConts
    
End Function

Public Function GetConts16(ByRef Taxyear As Integer, _
                            ByRef DataTable, _
                            ByRef TableUsed, _
                            ByRef Category, _
                            ByRef Period, _
                            ByRef ST, _
                            ByRef ET_PT, _
                            ByRef AUST, _
                            ByRef UST, _
                            ByRef UEL, _
                            ByRef GrossPay, _
                            ByRef calcType)
                              
'   Author  :   Chris Sneddon
'   Date    :   12/10/2015
'   Desc    :   2016 code tidy up and removal of UAP/rebates
                              
                              
On Error GoTo Err_GetConts16

Dim Rate As Double            ' Employee rate of NI contributions
Dim Rate_AboveAUST As Double  ' Employee rate of NI conts above AUST
Dim Rate_AboveUST As Double   ' Employee rate of NI conts above UST
Dim Rate_AboveUEL As Double   ' Employee rate of NI contributions above UEL
Dim Conts As Double           ' Total Contributions
Dim ContsPTST
Dim ContsETUEL
Conts = 0

Dim MidpointAdjustment
Dim MidPointAdjustmentUST

Dim GrossPayStep

' If calculation is not possible, exit the function.
If IsNull(Taxyear) Or IsNull(TableUsed) Or _
   IsNull(Category) Or IsNull(Period) Or IsNull(GrossPay) Then
    
    GetConts16 = 0
    Exit Function
End If

' Use the index to locate the year.
Class1RateTable.Index = "PrimaryKey"

Class1RateTable.Seek "<=", Taxyear, Category

' If the year is not found.
If Class1RateTable.NoMatch Then

    GetConts16 = 0
    Exit Function
Else

    If calcType = cEmployee Then
        'EmployeeRate
        Rate = Class1RateTable![EE_Rate]
        Rate_AboveUEL = Class1RateTable![EE_AboveUEL]
        
    ElseIf calcType = cEmployer Then
        Rate = Class1RateTable![ER_Rate]
        
        If InStr("MZ", Category) Then
            Rate_AboveUST = Class1RateTable![ER_AboveUST]
            Rate_AboveUEL = Class1RateTable![ER_AboveUEL]
        ElseIf InStr("H", Category) Then
            Rate_AboveAUST = Class1RateTable![ER_AboveAUST]
        Else
            Rate_AboveUEL = Class1RateTable![ER_AboveUEL]
        End If
    End If
    
    Select Case UCase$(Period)
    Case "W"
        MidpointAdjustment = Rate / 2
    Case "M"
        MidpointAdjustment = Rate * 2
    End Select
    
End If

' If we are using a Table calc and the earnings lie between the LEL And the UEL
' we need to compare to Earnings Steps to determine the amount of NICs owed.
' If not, then we can just use the direct percentage method
If TableUsed = "Yes" And _
   ((calcType = cEmployer And GrossPay >= ST) Or _
    (calcType = cEmployee And GrossPay >= ET_PT) Or _
    GrossPay < UEL) Then
   
   ' Determine the step value
    Select Case UCase$(Period)
    Case "W"
        GrossPayStep = Int(GrossPay)
        If GrossPayStep = ST Then
            MidpointAdjustment = 0
        End If
        If GrossPayStep = ET_PT Then
            MidpointAdjustment = 0
        End If
        
    Case "M"
    
        'needs to deal with the UST/AUST, still pumping the figure into the ET-UEL
        If InStr("MZ", Category) And GrossPay = UST And calcType = cEmployer Then
            GrossPayStep = UST
        ElseIf InStr("H", Category) And GrossPay = AUST And calcType = cEmployer Then
            GrossPayStep = AUST
        ElseIf GrossPay = UEL Then
            GrossPayStep = UEL
        ElseIf GrossPay = UEL Then
            GrossPayStep = UEL
        Else
            GrossPayStep = GrossPayStepMonthly(Taxyear, GrossPay)
        End If
        
        stepincrement = 4
        
        If GrossPayStep = ET_PT Or GrossPayStep = ST Then
            MidpointAdjustment = 0
        End If
        
            If GrossPayStep + stepincrement > ET_PT And GrossPayStep < ET_PT Then
                If GrossPay < ET_PT Then
                    MidpointAdjustment = MidpointAdjustment / 2
                End If
            End If
            
            If GrossPayStep + stepincrement > ST And GrossPayStep < ST Then
                If GrossPay < ST Then
                    MidpointAdjustment = MidpointAdjustment / 2
                End If
            End If
                           
    End Select

    If calcType = cEmployer Then

        ' For earnings below ST
        If GrossPayStep <= ST Then
            Conts = 0
        
        ' For earnings ST to PT
        ElseIf GrossPayStep > ST And GrossPayStep < ET_PT Then
            Conts = curRound((GrossPayStep - ST) * Rate + MidpointAdjustment)
        
        ' For earnings PT to UEL (ET_PT)
        ElseIf GrossPayStep < UEL Then
            Conts = curRound((ET_PT - ST) * Rate) + _
                    curRound(((GrossPayStep - ET_PT) * Rate) + MidpointAdjustment)
        End If

        ' For earnings AboveUEL
        If GrossPayStep >= UST And InStr("MZ", Category) Then
                    Conts = curRound((ET_PT - ST) * Rate) + _
                            curRound((UST - ET_PT) * Rate) + _
                            curRound(Int((GrossPay - UST)) * Rate_AboveUST)
        ElseIf GrossPayStep >= AUST And InStr("H", Category) Then
                    Conts = curRound((ET_PT - ST) * Rate) + _
                            curRound((AUST - ET_PT) * Rate) + _
                            curRound(Int((GrossPay - AUST)) * Rate_AboveAUST)
        ElseIf GrossPayStep >= UEL Then
                    Conts = curRound((ET_PT - ST) * Rate) + _
                            curRound((UEL - ET_PT) * Rate) + _
                            curRound(Int((GrossPay - UEL)) * Rate_AboveUEL)
        End If
    
    Else ' Employees No need for Categories as it always uses UEL
        ' For earnings below PT
        If GrossPayStep <= ET_PT Then
            Conts = 0
        
        ' For earnings PT to UAP
        ElseIf GrossPayStep < UEL Then
            Conts = curRound(((GrossPayStep - ET_PT) * Rate) + MidpointAdjustment)
  
        ' For earnings AboveUEL
        ElseIf GrossPayStep >= UEL Then
            Conts = curRound(((UEL - ET_PT) * Rate)) + _
                    (Int((GrossPay - UEL)) * Rate_AboveUEL)
        End If
    
    End If

Else
' Else, Use the Percentage method
    With DataTable
            
            'Below the ST and up to the ET
            If GrossPay <= ST Then
                Conts = 0
            'employees are PT to UEL
            ElseIf calcType = cEmployee Then
                Conts = Conts + (![ETtoUEL] * Rate)
            ' between ET- UST/UEL/AUST
            ElseIf InStr("MZ", Category) And calcType = cEmployer Then
                ContsETUEL = Conts + (![ETToUST] * Rate)
                ContsPTST = Conts + (![PTToST] * Rate)
                Conts = ContsPTST + ContsETUEL
            ElseIf InStr("H", Category) And calcType = cEmployer Then
                ContsETUEL = Conts + (![ETToAUST] * Rate)
                ContsPTST = Conts + (![PTToST] * Rate)
                Conts = ContsPTST + ContsETUEL
            Else  ' Employers are ST to UEL/UST/AUST so you need to add the ST-PT to make up for it
                ContsPTST = Conts + (![PTToST] * Rate)
                ContsETUEL = Conts + (![ETtoUEL] * Rate)
                Conts = ContsPTST + ContsETUEL
            End If
            
            'Above UST/UEL/AUST
            If GrossPay >= UST And InStr("MZ", Category) And calcType = cEmployer Then
                Conts = Conts + ((GrossPay - UST) * Rate_AboveUST)
            ElseIf GrossPay >= AUST And InStr("H", Category) And calcType = cEmployer Then
                Conts = Conts + ((GrossPay - AUST) * Rate_AboveAUST)
            ElseIf GrossPay >= UEL Then
                Conts = Conts + ((GrossPay - UEL) * Rate_AboveUEL)
            End If
            
    End With
End If

GetConts16 = curRound(Conts)
'GetConts = Conts

Exit_GetConts16:
    Exit Function

Err_GetConts16:
    MsgBox Error$
    Resume Exit_GetConts16
    
End Function

Function GetEEConts01(Taxyear, TableUsed, Period, PeriodNumber, Category, GrossPay, ET_PT, UAP, UEL)

' Author            : Christopher Schuler
' Date              : 14 November 2000
' Purpose           : To return the amount of employee contributions (2001)
' Author            : Christopher Schuler
' Date              : 30 january 2002
' Purpose           : Amendment for tax year 2002
' Author            : Christopher Schuler
' Date              : 17 December 2002
' Purpose           : Amendment for tax year 2003
' Author            : Christopher Schuler
' Date              : 23 December 2003
' Purpose           : Amendment for tax year 2004
' Author            : Christopher Sneddon
' Date              : 4th March 2009
' Purpose           : Changes for UAP and 2009 tax year

On Error GoTo Err_GetEEConts01

Dim RateEE                      'Employee rate of NI contributions
Dim RateEE_AboveUEL             'Employee rate of NI contributions above UEL
Dim EEConts01 As Double         'Employee's contributions
Dim test As Double
Dim EE_AboveUAP As Double
Dim EEConts_AboveUEL As Double  'Employee's contributions above UEL
Dim EEConts_AboveUAP As Double  'Employee's contributions above UAP
Dim GrossPayStep As Double      'Value of GrossPay which would be looked up in NIC tables
Dim stepincrement As Double     'Incremental step in NIC tables
Dim MidpointAdjustment          'Added to EEConts01 to replicate NIC tables
Dim UAPETRate As Double
Dim GrossUAP As Double




' If calculation is not possible, exit the function.
If IsNull(Taxyear) Or IsNull(TableUsed) Or IsNull(Period) Or _
   PeriodNumber = 0 Or IsNull(Category) Or IsNull(GrossPay) Then
   
   GetEEConts01 = 0
   Exit Function
End If

' Use the index to locate the year.
Class1RateTable.Index = "PrimaryKey"

Class1RateTable.Seek "<=", Taxyear, Category

' If the year is not found.
If Class1RateTable.NoMatch Then

    GetEEConts01 = 0
    Exit Function

Else
    'EmployeeRate
    RateEE = Class1RateTable![EE_Rate]
    
    'new rate for above UEL introduced for 2003
    If Taxyear > 2008 Then
        RateEE_AboveUEL = Class1RateTable![EE_AboveUEL] ' this is tailored towards the 1% UEL
    
    ElseIf Taxyear > 2002 Then
        RateEE_AboveUEL = Class1RateTable![EE_AboveUEL] ' this is tailored towards the 1% UEL
    
    End If
    
    Select Case UCase$(Period)
    Case "W"
        MidpointAdjustment = RateEE / 2
    Case "M"
        MidpointAdjustment = RateEE * 2
    End Select
    
End If

If GrossPay < ET_PT Or GrossPay >= UEL Then
    GoTo NextPartEE01
End If

' If using the tables.
If TableUsed = "Yes" Then
                                                
    'calculate the step value
    Select Case UCase$(Period)
    Case "W"
        GrossPayStep = Int(GrossPay)
        
    Case "M"
        GrossPayStep = GrossPayStepMonthly(Taxyear, GrossPay)
        stepincrement = 4
        
    End Select
        
    'Calculate EEConts01
    'Employee Contributions
    If Period = "M" Then
        If GrossPayStep <= ET_PT And GrossPay >= ET_PT Then
            MidpointAdjustment = MidpointAdjustment * 3 / 2
        End If
                    
        If (GrossPayStep) > ET_PT And GrossPay < ET_PT Then
            MidpointAdjustment = MidpointAdjustment / 2
        End If
                    
        If Taxyear > 2002 Then
            If (GrossPayStep + stepincrement) > UEL And GrossPay < UEL Then
                MidpointAdjustment = MidpointAdjustment / 4
            End If
        End If
    End If

    If GrossPayStep <= ET_PT Then
        EEConts01 = 0
        
    ElseIf GrossPayStep > ET_PT And GrossPayStep < UEL Then
        'Tables appear to take first 3 sig. figs. after decimal point
        EEConts01 = Int((((GrossPayStep - ET_PT) * RateEE) + MidpointAdjustment) * 1000) / 1000
            
    ElseIf GrossPayStep >= UAP Then
        EEConts01 = (UEL - ET_PT) * RateEE
    End If
            
Else

NextPartEE01:

    'Employee Contributions
  
    If GrossPay <= ET_PT Then
        EEConts01 = 0
    ElseIf GrossPay > ET_PT And GrossPay <= UEL Then
        EEConts01 = (GrossPay - ET_PT) * RateEE
    ElseIf GrossPay > UEL Then
        EEConts01 = (UEL - ET_PT) * RateEE
        'new rate for above UEL introduced for 2003
        If Taxyear > 2002 Then
            EEConts_AboveUEL = (GrossPay - UEL) * RateEE_AboveUEL
            EEConts01 = curRound(EEConts01) + curRound(EEConts_AboveUEL)
        End If
    End If
End If ' If tables used = Yes


' CA Rounding
GetEEConts01 = curRound(EEConts01)



Exit_GetEEConts01:
    Exit Function

Err_GetEEConts01:
    MsgBox Error$
    Resume Exit_GetEEConts01



End Function

Function GetEEConts2000(Taxyear, TableUsed, Period, PeriodNumber, Category, GrossPay, LEL, EE_ET, ER_ET, UEL)

' Author            : Christopher Schuler
' Date              : 11 November 1999
' Purpose           : To return the amount of employee contributions (2000)

On Error GoTo Err_GetEEConts2000

Dim RateEE                  'Employee rate of NI contributions
Dim EEConts2000 As Double     'Employee's contributions
Dim GrossPayStep As Double     'Value of GrossPay which would be looked up in NIC tables
Dim stepincrement As Double   'Incremental step in NIC tables
Dim MidpointAdjustment           'Added to EEConts2000 to replicate NIC tables


' If calculation is not possible, exit the function.
If IsNull(Taxyear) Or IsNull(TableUsed) Or IsNull(Period) Or _
   PeriodNumber = 0 Or IsNull(Category) Or IsNull(GrossPay) Then
   
    GetEEConts2000 = 0
    Exit Function
End If

' Use the index to locate the year.
Class1RateTable.Index = "PrimaryKey"

Class1RateTable.Seek "<=", Taxyear, Category

' If the year is not found.
If Class1RateTable.NoMatch Then

    GetEEConts2000 = 0
    Exit Function

Else
    'EmployeeRate
    RateEE = Class1RateTable![EE_Rate]

    Select Case UCase$(Period)
    Case "W"
        MidpointAdjustment = RateEE / 2
    Case "M"
        MidpointAdjustment = RateEE * 2
    End Select
    
End If


If GrossPay < LEL Or GrossPay >= UEL Then
    GoTo NextPartEE2000
End If
            

    ' If using the tables.
If TableUsed = "Yes" Then
                                                
    'calculate the step value
    Select Case UCase$(Period)
    Case "W"
        GrossPayStep = Int(GrossPay)
    Case "M"
        GrossPayStep = (Int((GrossPay - 3) / 4) * 4) + 3
    End Select
    
    'Calculate EEConts2000
    
    'Employee Contributions
      
    If Period = "M" Then
        If GrossPayStep <= EE_ET And GrossPay >= EE_ET Then
            MidpointAdjustment = MidpointAdjustment * 3 / 2
        End If
                    
        If (GrossPayStep + stepincrement) > ER_ET And GrossPay < ER_ET Then
            MidpointAdjustment = MidpointAdjustment / 2
        End If
                    
        If GrossPayStep <= ER_ET And GrossPay >= ER_ET Then
            MidpointAdjustment = MidpointAdjustment * 3 / 2
        End If
    End If

    If GrossPayStep <= EE_ET Then
        EEConts2000 = 0
    ElseIf GrossPayStep > EE_ET And GrossPayStep < UEL Then
        'Tables appear to take first 3 sig. figs. after decimal point
        EEConts2000 = Int(((GrossPayStep - EE_ET) * RateEE + MidpointAdjustment) * 1000) / 1000
            
    ElseIf GrossPayStep >= UEL Then
        EEConts2000 = (UEL - EE_ET) * RateEE
    End If
      
Else

NextPartEE2000:

    'Employee Contributions
        If GrossPay <= EE_ET Then
            EEConts2000 = 0
        ElseIf GrossPay > EE_ET And GrossPay <= UEL Then
            EEConts2000 = (GrossPay - EE_ET) * RateEE
        ElseIf GrossPay > UEL Then
            EEConts2000 = (UEL - EE_ET) * RateEE
        End If
End If

'LastPart2000:
' CA Rounding
GetEEConts2000 = curRound(EEConts2000)

Exit_GetEEConts2000:
    Exit Function

Err_GetEEConts2000:
    MsgBox Error$
    Resume Exit_GetEEConts2000

End Function


Function GetEENIRebate(Taxyear, TableUsed, Period, PeriodNumber, Category, GrossPay, LEL, EE_ET)

' Author            : Christopher Schuler
' Date              : 11 November 1999
' Purpose           : To return the employee's NI Rebate if any

On Error GoTo Err_GetEENIRebate


Dim EENIRebate As Double
Dim EERebateRate             'Employee rate of NI rebate
Dim GrossPayStep As Double
Dim stepincrement As Double   'Incremental step in NIC tables
Dim MidpointAdjustment


' If calculation is not possible, exit the function.
If IsNull(Taxyear) Or IsNull(TableUsed) Or IsNull(Period) Or PeriodNumber = 0 Or _
   IsNull(Category) Or IsNull(GrossPay) Then
   
    GetEENIRebate = 0
    Exit Function
End If

' Use the index to locate the year.
Class1RateTable.Index = "PrimaryKey"

Class1RateTable.Seek "<=", Taxyear, Category

' If the year is not found.
If Class1RateTable.NoMatch Then

    GetEENIRebate = 0
    Exit Function

Else
    'EmployeeRate
    EERebateRate = Class1RateTable![EE NIC Rebate]
    Select Case UCase$(Period)

    Case "W"
    MidpointAdjustment = EERebateRate / 2
    Case "M"
    MidpointAdjustment = EERebateRate * 2

    End Select
    
End If
       
If GrossPay < LEL Or GrossPay > EE_ET Then
     GoTo NextPartEENIRebate
End If

    ' If using the tables.
If TableUsed = "Yes" Then
                                                
        'calculate the step value
    Select Case UCase$(Period)

    Case "W"
     GrossPayStep = Int(GrossPay)
    Case "M"
     GrossPayStep = (Int((GrossPay - 3) / 4) * 4) + 3

    End Select

    If Period = "M" Then
        If (GrossPayStep + stepincrement) > EE_ET And GrossPay < EE_ET Then
            MidpointAdjustment = MidpointAdjustment / 2
        End If
    End If
        
    'Employee NI Rebate
    If GrossPayStep > LEL And GrossPayStep < EE_ET Then
        EENIRebate = (GrossPayStep - LEL) * EERebateRate + MidpointAdjustment
    ElseIf GrossPayStep >= EE_ET Then
        EENIRebate = (EE_ET - LEL) * EERebateRate
    End If
    
Else
NextPartEENIRebate:
    'Employer NI Rebate
    
    If GrossPay <= LEL Then
        EENIRebate = 0
        
    ElseIf GrossPay > LEL And GrossPay <= EE_ET Then
        EENIRebate = (GrossPay - LEL) * EERebateRate
        
    ElseIf GrossPay > EE_ET Then
    EENIRebate = (EE_ET - LEL) * EERebateRate
            
    End If

End If

GetEENIRebate = curRound(EENIRebate)

Exit_GetEENIRebate:
    Exit Function

Err_GetEENIRebate:
    MsgBox Error$
    Resume Exit_GetEENIRebate


End Function


Function GetEmployeeNI(Taxyear, TableUsed, Period, PeriodNumber, Category) As Double

            '''''''''''''''''''''''''''''''''''''''''
            ' AUTHOR : JASON CORDEY - I.T.S.A. 1995 '
            '''''''''''''''''''''''''''''''''''''''''
' History
' Author            : Mustaq Hussain
' Date              : 6 March 1996
' Purpose           : To take into account non-stepped Band changes, calling nMonthlyConversionvalue()
' Author            : Lisa Scothern
' Date              : 11 September 1997
' Purpose           : RFC541: Values are to be rounded using curRound()
' Author            : Christopher Schuler
' Date              : 20 April 2004
' Purpose           : v1466105 - Employees NI calculated at 5% instead of 7%
' History           : Chris Schuler
' Date              : 13 August 2004
' Purpose           : v1613864 - Incorrect result when gross pay falls in band 2
' History           : Chris Schuler
' Date              : 9 February 2005
' Purpose           : v1838323 - Subtotals added then total is rounded

On Error GoTo Err_GetEmployeeNI

Dim LELCalculation As Integer
Dim LELAmount As Double
Dim yearvalue As Integer
Dim LEL As Double
Dim Band2 As Double
Dim Band3 As Double
Dim Band4 As Double
Dim UEL As Double
Dim LELEmployeeRate As Double
Dim EmployeeRate As Double
Dim EmployeeIncome As Double
Dim Amount As Double
Dim RoundedRate As Double
Dim conversionvalue As Double
Dim stepincrement As Double   'Incremental step in NIC tables
conversionvalue = 0

' If calculation is not possible, exit the function.
If IsNull(Taxyear) Or IsNull(TableUsed) Or IsNull(Period) Or PeriodNumber = 0 Or IsNull(Category) Then
    GetEmployeeNI = 0
    Exit Function
End If

' Convert the year into a number representation.
yearvalue = Val(Taxyear)

' Use the index to locate the year.
NIRateBandTable.Index = "PrimaryKey"
NIRateBandTable.Seek "=", yearvalue

' If the year is not found.
If NIRateBandTable.NoMatch Then

    GetEmployeeNI = 0
    Exit Function

Else
    With NIRateBandTable
      ' Set the global bands.
        Select Case UCase$(Period)
        Case "W"
            If IsNull(![Wk Band 1]) Then
                LEL = 0
            Else
                LEL = ![Wk Band 1]
            End If
            
            'If IsNull(![Wk Band 3]) Then     'v1613864
            If IsNull(![Wk Band 2]) Then
                Band2 = 0
            Else
                'Band2 = ![Wk Band 3]         'v1613864
                Band2 = ![Wk Band 2]
            End If
            
            If IsNull(![Wk Band 3]) Then
                Band3 = 0
            Else
                Band3 = ![Wk Band 3]
            End If
            
            If IsNull(![Wk Band 4]) Then
                Band4 = 0
            Else
                Band4 = ![Wk Band 4]
            End If
            
            If IsNull(![Wk Band 5]) Then
                UEL = 0
            Else
                UEL = ![Wk Band 5]
            End If
            
        Case "M"
            If IsNull(![Mnth Band 1]) Then
                LEL = 0
            Else
                LEL = ![Mnth Band 1]
            End If
            
            If IsNull(![Mnth Band 2]) Then
                Band2 = 0
            Else
                Band2 = ![Mnth Band 2]
            End If
            
            'v1466105If IsNull(![Mnth Band 3]) Then
                'v1466105 Band2 = 0
            'v1466105 Else
                'v1466105 Band2 = ![Mnth Band 3]
            'v1466105 End If
            
            If IsNull(![Mnth Band 3]) Then 'v1466105
                Band3 = 0                  'v1466105
            Else                           'v1466105
                Band3 = ![Mnth Band 3]     'v1466105
            End If                         'v1466105
            
            If IsNull(![Mnth Band 4]) Then
                Band4 = 0
            Else
                Band4 = ![Mnth Band 4]
            End If
            
            If IsNull(![Mnth Band 5]) Then
                UEL = 0
            Else
                UEL = ![Mnth Band 5]
            End If
               
        Case Else
            GetEmployeeNI = 0
            Exit Function
            
        End Select
    End With
End If

' This section determines the correct Amount to use for earnings
' at or above the maximum level.

EmployeeIncome = Earnings

If TableUsed = "Yes" Then
    
    Select Case Val(Taxyear)

    Case Is > 1986
        If Period = "W" Then
            conversionvalue = 0.5
        Else
            conversionvalue = nMonthlyConversionvalue(Earnings, LEL, Band2, Band3, Band4, UEL)
        End If

    Case Else
        If Period = "W" Then
            conversionvalue = 0.25
        Else
            conversionvalue = 1
        End If

    End Select

    If (UEL - Earnings) < stepincrement Then
        EmployeeIncome = ((Earnings + UEL) / 2)
    Else
        If Earnings > LEL Then
            If AdjustedMinimumFlag = 1 Then
                EmployeeIncome = Earnings
            Else
                EmployeeIncome = Earnings + conversionvalue
            End If
        Else
            EmployeeIncome = Earnings
        End If
    End If
End If

' Use the correct index to locate the year.
Select Case UCase$(Period)
Case "M"
    Class1RateTable.Index = "MonthIndex"
Case "W"
    Class1RateTable.Index = "WeekIndex"
End Select
Class1RateTable.Seek "<=", yearvalue, Category, PeriodNumber

' If the year is not found.
If Class1RateTable.NoMatch Then
    GetEmployeeNI = 0
    Exit Function

Else
    ' If no contribution is to be paid.
    If Earnings < LEL Then
        GetEmployeeNI = 0
        Exit Function
    End If
    If (Taxyear < 1985) Or ((Taxyear = 1985) And (Class1RateTable![start week] < 27)) Then
        Select Case Category
    
        Case "C"
            GetEmployeeNI = 0
            Exit Function
            
        Case "A", "B", "D", "E"
            LELEmployeeRate = Class1RateTable![Up to LEL1 (employee)]
            EmployeeRate = Class1RateTable![Employee Rte 1]
            GoTo Calcemployeecont
        End Select
    End If

    If (Taxyear < 1989) Or ((Taxyear = 1989) And (Class1RateTable![start week] < 27)) Then
        Select Case Category
        Case "A", "C", "D"
            If Earnings >= LEL And Earnings < Band2 Then
                LELEmployeeRate = Class1RateTable![Up to LEL1 (employee)]
                EmployeeRate = Class1RateTable![Employee Rte 1]
            End If
            
            If (Earnings >= Band2) And (Earnings < Band3) Then
                LELEmployeeRate = Class1RateTable![Up to LEL2 (employee)]
                EmployeeRate = Class1RateTable![employee rte 2]

            End If
        
            If (Earnings >= Band3) And (Earnings < Band4) Then
                LELEmployeeRate = Class1RateTable![Up to LEL3 (employee)]
                EmployeeRate = Class1RateTable![employee rte 3]

            End If
        
            If (Earnings >= Band4) Then
                LELEmployeeRate = Class1RateTable![Up to LEL4 (employee)]
                EmployeeRate = Class1RateTable![Employee Rte 4]
            End If
            
        Case "B", "E"
            LELEmployeeRate = Class1RateTable![Up to LEL1 (employee)]
            EmployeeRate = Class1RateTable![Employee Rte 1]
        End Select
    End If

    If (Taxyear > 1989) Or ((Taxyear = 1989) And (Class1RateTable![start week] > 26)) Then
        Select Case Category
        Case "C"
            GetEmployeeNI = 0
            Exit Function
    
        Case Else
            LELEmployeeRate = Class1RateTable![Up to LEL1 (employee)]
            EmployeeRate = Class1RateTable![Employee Rte 1]
        End Select
    End If
End If

Calcemployeecont:

' This section will calculate the employees LEL contribution.
''LELAmount = LEL * LELEmployeeRate
LELAmount = curRound(LEL * LELEmployeeRate) 'v1930772
'LELAmount = Int(LELAmount * 1000) / 1000                   no longer needed, RFC541

' This section will calculate the employees contribution.
Amount = EmployeeIncome - LEL
''Amount = Amount * EmployeeRate
Amount = curRound(Amount * EmployeeRate) 'v1930772
'Amount = Int(Amount * 1000) / 1000   no longer needed, RFC541
'Amount = curRound(Amount) + curRound(LELAmount)    ' RFC541
'Amount = curRound(Amount + LELAmount) 'v1838323
Amount = Amount + LELAmount 'v1930772


' Round to take into account the manual method!
'If CCur((Amount * 100) - Int(Amount * 100)) >= .6 Then       no longer needed, RFC541
'    RoundedRate = CCur(CLng(Amount * 1000) / 1000)
'    Amount = CCur((CLng(RoundedRate * 100)) / 100)
'Else
'    Amount = CCur(Int(Amount * 100) / 100)
'End If

' Return the total contribution.

GetEmployeeNI = Amount

Exit_GetEmployeeNI:
    Exit Function

Err_GetEmployeeNI:
    MsgBox Error$
    Resume Exit_GetEmployeeNI


End Function

Function GetEmployerNI(Taxyear, TableUsed, Period, PeriodNumber, Category, ByVal GrossPay) As Double

            '''''''''''''''''''''''''''''''''''''''''
            ' AUTHOR : JASON CORDEY - I.T.S.A. 1995 '
            '''''''''''''''''''''''''''''''''''''''''
' History
' Author            : Mustaq Hussain
' Date              : 6 March 1996
' Purpose           : To take into account non-stepped Band changes, calling nMonthlyConversionvalue()
' History           : Jane Mullen
' Date              : 16 May 1997
' Purpose           : RFC 642B - Addition of F,G and S C/O categories
' Author            : Lisa Scothern
' Date              : 11 September 1997
' Purpose           : RFC541: Values to be rounded using curRound
' Author            : Chris Schuler
' Date              : 25 January 2005
' Purpose           : v1838323 - correction to fix y2k bug

On Error GoTo Err_GetEmployerNI

Dim yearvalue As Integer
Dim LEL As Double
Dim Band2 As Double
Dim Band3 As Double
Dim Band4 As Double
Dim UEL As Double
Dim conversionvalue As Double
Dim LELEmployerRate As Double
Dim EmployerRate As Double
Dim UELEmployerRate As Double
Dim EmployerLELAmount As Double
Dim EmployerAmount As Double
Dim EmployerUELAmount As Double
Dim value As Double
Dim EmployerIncome As Double
Dim stepincrement As Double   'Incremental step in NIC tables
conversionvalue = 0

' If calculation is not possible, exit the function.
If IsNull(Taxyear) Or IsNull(TableUsed) Or IsNull(Period) Or PeriodNumber = 0 Or IsNull(Category) Or IsNull(GrossPay) Then
    GetEmployerNI = 0
    Exit Function
End If

' Convert the year into a number representation.
yearvalue = Val(Taxyear)

' Use the index to locate the year.
NIRateBandTable.Index = "PrimaryKey"
NIRateBandTable.Seek "=", yearvalue

' If the year is not found.
If NIRateBandTable.NoMatch Then

    GetEmployerNI = 0
    Exit Function

Else
    With NIRateBandTable
        Select Case UCase$(Period)
    
        Case "W"
            
            ' Set the global bands.
            If IsNull(![Wk Band 1]) Then
                LEL = 0
            Else
                LEL = ![Wk Band 1]
            End If
            
            If IsNull(![Wk Band 2]) Then
                Band2 = 0
            Else
                Band2 = ![Wk Band 2]
            End If
            
            If IsNull(![Wk Band 3]) Then
                Band3 = 0
            Else
                Band3 = ![Wk Band 3]
            End If
            
            If IsNull(![Wk Band 4]) Then
                Band4 = 0
            Else
                Band4 = ![Wk Band 4]
            End If
            
            If IsNull(![Wk Band 5]) Then
                UEL = 0
            Else
                UEL = ![Wk Band 5]
            End If
            
            ' Set incriments for use with table calculation.
            'If Taxyear > 86 Then
            If Taxyear > 1986 Then 'v1838323
                stepincrement = 1
                conversionvalue = 0.5
            Else
                stepincrement = 0.5
                conversionvalue = 0.25
            End If
    
        Case "M"
    
            ' Set the global bands.
            If IsNull(![Mnth Band 1]) Then
                LEL = 0
            Else
                LEL = ![Mnth Band 1]
            End If
            
            If IsNull(![Mnth Band 2]) Then
                Band2 = 0
            Else
                Band2 = ![Mnth Band 2]
            End If
            
            If IsNull(![Mnth Band 3]) Then
                Band3 = 0
            Else
                Band3 = ![Mnth Band 3]
            End If
            
            If IsNull(![Mnth Band 4]) Then
                Band4 = 0
            Else
                Band4 = ![Mnth Band 4]
            End If
            
            If IsNull(![Mnth Band 5]) Then
                UEL = 0
            Else
                UEL = ![Mnth Band 5]
            End If
            
            ' Set incriments for use with table calculation.
            If Taxyear > 1986 Then
                stepincrement = 4
                conversionvalue = nMonthlyConversionvalue(Earnings, LEL, Band2, Band3, Band4, UEL)
            Else
                stepincrement = 2
                conversionvalue = 1
            End If
    
        Case Else
    
            GetEmployerNI = 0
            Exit Function
            
        End Select
    End With
End If

' This section determines the correct EmployerLELAmount to use for earnings at or above the maximum level

EmployerIncome = GrossPay

If TableUsed = "Yes" Then

    If GrossPay >= UEL + 1 Then
        
        EmployerIncome = Int(GrossPay)
    
    Else
        
        If GrossPay < UEL Then
            
            If (UEL - Earnings) < stepincrement Then
                EmployerIncome = ((Earnings + UEL) / 2)
            Else
                If Earnings = LEL Then
                    EmployerIncome = LEL
                Else
                    If AdjustedMinimumFlag = 1 Then
                        EmployerIncome = Earnings
                    Else
                        EmployerIncome = Earnings + conversionvalue
                    End If
                End If
            End If
        Else
            EmployerIncome = UEL
        End If
    
    End If

End If

' This section will determine the employers contribution rate.
' Use the correct index to locate the year.
Select Case UCase$(Period)
Case "M"
    Class1RateTable.Index = "MonthIndex"
Case "W"
    Class1RateTable.Index = "WeekIndex"
End Select
Class1RateTable.Seek "<=", yearvalue, Category, PeriodNumber

' If the year is not found.
If Class1RateTable.NoMatch Then

    GetEmployerNI = 0
    Exit Function

Else

    ' If no contribution is to be paid.
    If GrossPay < LEL Then
        GetEmployerNI = 0
        Exit Function
    End If

    If (Taxyear < 1985) Or (Taxyear = 1985 And Class1RateTable![start week] < 27) Then
        
        Select Case Category
    
        Case "A", "B", "C", "D", "E"
    
            LELEmployerRate = Class1RateTable![Up to LEL1 (employer)]
            EmployerRate = Class1RateTable![employer rte 4]
    
        End Select
    
    Else

        If (Taxyear > 1985) Or (Taxyear = 1985 And Class1RateTable![start week] > 26) Then
            
            Select Case Category
        
            Case "A", "B", "C"
        
                If (GrossPay >= LEL) And (GrossPay < Band2) Then
                    LELEmployerRate = Class1RateTable![Up to LEL1 (employer)]
                    EmployerRate = Class1RateTable![employer rte 1]
                End If
                
                If (GrossPay >= Band2) And (GrossPay < Band3) Then
                    LELEmployerRate = Class1RateTable![Up to LEL2 (employer)]
                    EmployerRate = Class1RateTable![employer rte 2]
                End If
            
                If (GrossPay >= Band3) And (GrossPay < Band4) Then
                    LELEmployerRate = Class1RateTable![Up to LEL3 (employer)]
                    EmployerRate = Class1RateTable![employer rte 3]
                End If
            
                If (GrossPay >= Band4) And (GrossPay <= UEL) Then
                    LELEmployerRate = Class1RateTable![Up to LEL4 (employer)]
                    EmployerRate = Class1RateTable![employer rte 4]
                End If
                
                If (GrossPay > UEL) Then
                    LELEmployerRate = Class1RateTable![Up to LEL4 (employer)]
                    EmployerRate = Class1RateTable![employer rte 4]
                    UELEmployerRate = Class1RateTable![Above UEL (employer)]
                End If
                
            Case "D", "E", "F", "G", "S"
'This line has changed to support F,G and S C/O categories
                If (GrossPay >= LEL) And (GrossPay < Band2) Then
                    LELEmployerRate = Class1RateTable![Up to LEL1 (employer)]
                    EmployerRate = Class1RateTable![employer rte 1]
                End If
                
                If (GrossPay >= Band2) And (GrossPay < Band3) Then
                    LELEmployerRate = Class1RateTable![Up to LEL2 (employer)]
                    EmployerRate = Class1RateTable![employer rte 2]
                End If
            
                If (GrossPay >= Band3) And (GrossPay < Band4) Then
                    LELEmployerRate = Class1RateTable![Up to LEL3 (employer)]
                    EmployerRate = Class1RateTable![employer rte 3]
                End If
            
                If (GrossPay >= Band4) And (GrossPay <= UEL) Then
                    LELEmployerRate = Class1RateTable![Up to LEL4 (employer)]
                    EmployerRate = Class1RateTable![employer rte 4]
                End If
            
                If (GrossPay > UEL) Then
                    LELEmployerRate = Class1RateTable![Up to LEL4 (employer)]
                    EmployerRate = Class1RateTable![employer rte 4]
                    UELEmployerRate = Class1RateTable![Above UEL (employer)]
                End If
            
            End Select
        
        End If
    
    End If
    
End If


Calcemployercont:

' This section will calculate the employers LEL contribution
EmployerLELAmount = LEL * LELEmployerRate
'EmployerLELAmount = Int(EmployerLELAmount * 1000) / 1000         no longer needed, RFC541
EmployerAmount = 0
EmployerUELAmount = 0
    
' This section will calculate the employers contribution under UEL.
If EmployerIncome > LEL And EmployerIncome <= UEL Then

    EmployerAmount = (EmployerIncome - LEL) * EmployerRate
  '  EmployerAmount = Int(EmployerAmount * 1000) / 1000            no longer needed, RFC541

End If

' This section will calculate the employers contribution over UEL.
If EmployerIncome > UEL Then

    EmployerUELAmount = (EmployerIncome - UEL) * UELEmployerRate
 '   EmployerUELAmount = Int(EmployerUELAmount * 1000) / 1000    no longer needed, RFC541
    EmployerAmount = (UEL - LEL) * EmployerRate
 '   EmployerAmount = Int(EmployerAmount * 1000) / 1000          no longer needed, RFC541

End If

' Calculate total contribution.
value = curRound(EmployerLELAmount) + curRound(EmployerAmount) + curRound(EmployerUELAmount)  'RFC541


GetEmployerNI = value

Exit_GetEmployerNI:
    Exit Function

Err_GetEmployerNI:
    MsgBox Error$
    Resume Exit_GetEmployerNI


End Function

Function GetER_ETToUEL(TableUsed, Period, GrossPay, ER_ET, UEL)

' Author            : Christopher Schuler
' Date              : 11 November 1999
' Purpose           : To return the amount of grosspay between employer earnings threshold
'                       and upper earnings limit

On Error GoTo Err_GetER_ETToUEL


Dim ER_ETToUEL As Double     'Employer Earnings Threshold to UEL

Dim GrossPayStep As Double


    ' If using the tables.
If TableUsed = "Yes" Then
                                                
        'calculate the step value
        Select Case UCase$(Period)
    
        Case "W", "4w"
         GrossPayStep = Int(GrossPay)
        Case "M"
         GrossPayStep = (Int((GrossPay - 3) / 4) * 4) + 3
    
        End Select
         

        'Calculate ER_ETToUEL

            If GrossPay >= UEL Then
                
                GrossPayStep = UEL
            
            End If
            
            If GrossPayStep < ER_ET And GrossPay > UEL Then
                
                GrossPayStep = ER_ET
            
            End If

            If GrossPayStep > ER_ET And GrossPayStep <= UEL Then
            
                ER_ETToUEL = GrossPayStep - ER_ET
        
            End If
        
Else

        'Calculate ER_ETToUEL
    
    If GrossPay <= ER_ET Then
            
            ER_ETToUEL = 0

         ElseIf GrossPay > ER_ET And GrossPay <= UEL Then
    
            ER_ETToUEL = GrossPay - ER_ET

        ElseIf GrossPay > ER_ET Then

            ER_ETToUEL = UEL - ER_ET

    End If

End If

' Return the earnings.
GetER_ETToUEL = Int(ER_ETToUEL)


Exit_GetER_ETToUEL:
    Exit Function

Err_GetER_ETToUEL:
    MsgBox Error$
    Resume Exit_GetER_ETToUEL




End Function

Function GetERConts(Taxyear, TableUsed, Period, PeriodNumber, Category, GrossPay)

' Author            : Christopher Schuler
' Date              : 29 July 1999
' Purpose           : To return the amount of employer contributions

On Error GoTo Err_GetERConts

Dim yearvalue As Integer
Dim stepvalue As Double
Dim LastGrossPay As Double
Dim LEL As Double    'Lower Earnings Limit
Dim ET_PT As Double     'Earnings Threshold
Dim UEL As Double    'Upper Earnings Limit
Dim UpToLEL As Double       'To Lower Earnings limit
Dim LELtoET As Double     'Lower Earnings Limit to Earnings Threshold
Dim ETtoUEL As Double     'Earnings Threshold to Upper Earnings Limit
Dim ERConts As Double     'Employer's contributions
Dim RateER                  'Employer rate of NI contributions
Dim UpperRateER             'Employer higher rate of NI contributions
Dim GrossPayStep As Double     'Value of GrossPay which would be looked up in NIC tables
Dim stepincrement As Double   'Incremental step in NIC tables
Dim MidpointAdjustment          'Added to ERConts to replicate NIC tables

' If calculation is not possible, exit the function.
If IsNull(Taxyear) Or IsNull(TableUsed) Or IsNull(Period) Or PeriodNumber = 0 Or IsNull(Category) Or IsNull(GrossPay) Then
    GetERConts = 0
    Exit Function
End If


' Convert the year into a number representation.
yearvalue = Val(Forms!PCGForm.Taxyear)

' Use the index to locate the year.
NIRateBandTable.Index = "PrimaryKey"
NIRateBandTable.Seek "=", yearvalue

' If the year is not found.
If NIRateBandTable.NoMatch Then

    GetERConts = 0
    Exit Function

Else

    Select Case UCase$(Period)

    Case "W"
        
        ' Set the global bands.
        LEL = NIRateBandTable![WkLEL]
        ET_PT = NIRateBandTable![WkER_ET]
        UEL = NIRateBandTable![WkUEL]
        
            stepincrement = 1
       

    Case "M"

        ' Set the global bands.
        LEL = NIRateBandTable![MnthLEL]
         ET_PT = NIRateBandTable![MnthER_ET]
       UEL = NIRateBandTable![MnthUEL]
        
            stepincrement = 4
           

    Case Else

        GetERConts = 0
        Exit Function
        
    End Select

    If GrossPay < LEL Then
        GoTo NextPartER
    Else
        stepvalue = LEL - stepincrement
    End If
       
End If


Class1RateTable.Index = "PrimaryKey"

Class1RateTable.Seek "<=", yearvalue, Category

' If the year is not found.
If Class1RateTable.NoMatch Then

    GetERConts = 0
    Exit Function

Else
    'EmployeeRate
    RateER = Class1RateTable![ER_Rate]
    UpperRateER = Class1RateTable![ER_AboveUEL]

    Select Case UCase$(Period)

    Case "W"
    MidpointAdjustment = RateER / 2
    Case "M"
    MidpointAdjustment = RateER * 2

    End Select

End If

    ' If using the tables.
If TableUsed = "Yes" Then

        LastGrossPay = stepvalue
                                                

    Select Case UCase$(Period)

    Case "W"
     GrossPayStep = Int(GrossPay)
    Case "M"
     GrossPayStep = (Int((GrossPay - 2) / 4) * 4) + 2

    End Select

        
        If GrossPay >= UEL Then
            GrossPayStep = Int(GrossPay)
        End If
        
        'Calculate ERConts
    
            'Employer Contributions
            If Period = "M" Then

            Select Case Category

            Case "A", "B", "C", "F", "G", "S"
                If (GrossPayStep + stepincrement) > UEL Then
                    MidpointAdjustment = 0.06
                End If

            Case "D", "E"
                If (GrossPayStep + stepincrement) > UEL Then
                    MidpointAdjustment = 0.05
                End If

            End Select

            End If

            If GrossPayStep <= ET_PT Then
            
                ERConts = 0
            
                ElseIf GrossPayStep > ET_PT And GrossPayStep < UEL Then
            
                    ERConts = ((GrossPayStep - ET_PT) * RateER) + MidpointAdjustment
            
                ElseIf GrossPayStep >= UEL Then
            
                    ERConts = curRound((UEL - ET_PT) * RateER) + curRound((Int(GrossPay) - UEL) * UpperRateER)
            
            End If
    
Else
NextPartER:
        'Employer Contributions
        
        If GrossPay <= ET_PT Then
        
            ERConts = 0
        
            ElseIf GrossPay > ET_PT And GrossPay <= UEL Then
        
                ERConts = (GrossPay - ET_PT) * RateER
        
            ElseIf GrossPay > UEL Then
        
                ERConts = curRound((UEL - ET_PT) * RateER) + curRound((GrossPay - UEL) * UpperRateER)
        
        End If

End If

' Return the earnings using CA Rounding
GetERConts = curRound(ERConts)


Exit_GetERconts:
    Exit Function

Err_GetERConts:
    MsgBox Error$
    Resume Exit_GetERconts



End Function

Function GetERConts01(Taxyear, TableUsed, Period, PeriodNumber, Category, GrossPay, ET_PT, UAP, UEL)

' Author            : Christopher Schuler
' Date              : 14 November 2000
' Purpose           : To return the amount of employer contributions(2001)
' Author            : Christopher Schuler
' Date              : 30 january 2002
' Purpose           : Amendment for tax year 2002
' Author            : Christopher Schuler
' Date              : 23 December 2003
' Purpose           : Amendment for tax year 2004

On Error GoTo Err_GetERConts01


Dim ERConts01 As Double     'Employer's contributions
Dim RateER                  'Employer rate of NI contributions
Dim UpperRateER             'Employer higher rate of NI contributions
Dim GrossPayStep As Double     'Value of GrossPay which would be looked up in NIC tables
Dim MidpointAdjustment          'Added to ERConts to replicate NIC tables


' If calculation is not possible, exit the function.
If IsNull(Taxyear) Or IsNull(TableUsed) Or IsNull(Period) Or PeriodNumber = 0 Or IsNull(Category) Or IsNull(GrossPay) Then
    GetERConts01 = 0
    Exit Function
End If


' Use the index to locate the year.
Class1RateTable.Index = "PrimaryKey"

Class1RateTable.Seek "<=", Taxyear, Category

' If the year is not found.
If Class1RateTable.NoMatch Then

    GetERConts01 = 0
    Exit Function

Else
    'EmployerRate
    RateER = Class1RateTable![ER_Rate]
    UpperRateER = Class1RateTable![ER_AboveUEL]
    Select Case UCase$(Period)

    Case "W"
    MidpointAdjustment = RateER / 2
    Case "M"
    MidpointAdjustment = RateER * 2

    End Select

End If

    ' If using the tables.
    If TableUsed = "Yes" Then
                                                
        'calculate the step value
        Select Case UCase$(Period)
    
        Case "W"
            
            GrossPayStep = Int(GrossPay)
            
        Case "M"
        
            GrossPayStep = GrossPayStepMonthly(Taxyear, GrossPay)
            
            stepincrement = 4
            
        End Select
        
        If GrossPay >= UEL Then
            GrossPayStep = Int(GrossPay)
        End If
        
        'Calculate ERConts
    
       'Employer Contributions
       If Period = "M" Then
           If GrossPayStep <= ET_PT And GrossPay >= ET_PT Then
               MidpointAdjustment = MidpointAdjustment * 3 / 2
           End If
            
           If Taxyear > 2002 Then
               If (GrossPayStep + stepincrement) > UEL And GrossPay < UEL Then
                   MidpointAdjustment = MidpointAdjustment / 4
               End If
           End If
       End If
    
       If GrossPayStep <= ET_PT Then
           ERConts01 = 0
       
       ElseIf GrossPayStep > ET_PT And GrossPayStep < UEL Then
           'Tables appear to take first 3 sig. figs. after decimal point
           ERConts01 = Int(1000 * (((GrossPayStep - ET_PT) * RateER) + MidpointAdjustment)) / 1000
       
       ElseIf GrossPayStep >= UEL Then
           ERConts01 = curRound((UEL - ET_PT) * RateER) + curRound((Int(GrossPay) - UEL) * UpperRateER)
       End If
    Else
'NextPartER01:
        'Employer Contributions

        If GrossPay <= ET_PT Then
        
            ERConts01 = 0
        
            ElseIf GrossPay > ET_PT And GrossPay <= UEL Then
        
                ERConts01 = (GrossPay - ET_PT) * RateER
        
            ElseIf GrossPay > UEL Then

                               
                ERConts01 = curRound((UEL - ET_PT) * RateER) + curRound((GrossPay - UEL) * UpperRateER)
        
        End If
End If

' Return the earnings using CA Rounding
GetERConts01 = curRound(ERConts01)


Exit_GetERconts01:
    Exit Function

Err_GetERConts01:
    MsgBox Error$
    Resume Exit_GetERconts01

End Function


Function GetERConts2000(Taxyear, TableUsed, Period, PeriodNumber, Category, GrossPay, LEL, ER_ET, UEL)

' Author            : Christopher Schuler
' Date              : 11 November 1999
' Purpose           : To return the amount of employer contributions(2000)

On Error GoTo Err_GetERConts2000


Dim ERConts2000 As Double     'Employer's contributions
Dim RateER                  'Employer rate of NI contributions
Dim UpperRateER             'Employer higher rate of NI contributions
Dim GrossPayStep As Double     'Value of GrossPay which would be looked up in NIC tables
Dim MidpointAdjustment          'Added to ERConts to replicate NIC tables

' If calculation is not possible, exit the function.
If IsNull(Taxyear) Or IsNull(TableUsed) Or IsNull(Period) Or PeriodNumber = 0 Or IsNull(Category) Or IsNull(GrossPay) Then
    GetERConts2000 = 0
    Exit Function
End If


' Use the index to locate the year.
Class1RateTable.Index = "PrimaryKey"

Class1RateTable.Seek "<=", Taxyear, Category

' If the year is not found.
If Class1RateTable.NoMatch Then

    GetERConts2000 = 0
    Exit Function

Else
    'EmployeeRate
    RateER = Class1RateTable![ER_Rate]
    UpperRateER = Class1RateTable![ER_AboveUEL]

    Select Case UCase$(Period)

    Case "W"
    MidpointAdjustment = RateER / 2
    Case "M"
    MidpointAdjustment = RateER * 2

    End Select

End If

    ' If using the tables.
    If TableUsed = "Yes" Then
                                                
        'calculate the step value
        Select Case UCase$(Period)
    
        Case "W"
         GrossPayStep = Int(GrossPay)
        Case "M"
         GrossPayStep = (Int((GrossPay - 3) / 4) * 4) + 3
    
        End Select
        
        If GrossPay >= UEL Then
            GrossPayStep = Int(GrossPay)
        End If
        
        'Calculate ERConts
    
            'Employer Contributions
            If Period = "M" Then

                    If GrossPayStep <= ER_ET And GrossPay >= ER_ET Then
                        MidpointAdjustment = MidpointAdjustment * 3 / 2
                    End If

            End If

            If GrossPayStep <= ER_ET Then
            
                    ERConts2000 = 0
            
                ElseIf GrossPayStep > ER_ET And GrossPayStep < UEL Then
            
                    ERConts2000 = ((GrossPayStep - ER_ET) * RateER) + MidpointAdjustment
            
                ElseIf GrossPayStep >= UEL Then
                    
                    ERConts2000 = curRound((UEL - ER_ET) * RateER) + curRound((Int(GrossPay) - UEL) * UpperRateER)
            
            End If

    
    Else
NextPartER2000:
        'Employer Contributions
        
        If GrossPay <= ER_ET Then
        
            ERConts2000 = 0
        
            ElseIf GrossPay > ER_ET And GrossPay <= UEL Then
        
                ERConts2000 = (GrossPay - ER_ET) * RateER
        
            ElseIf GrossPay > UEL Then
        
                ERConts2000 = curRound((UEL - ER_ET) * RateER) + curRound((GrossPay - UEL) * UpperRateER)
        
        End If

End If

' Return the earnings using CA Rounding
GetERConts2000 = curRound(ERConts2000)


Exit_GetERconts2000:
    Exit Function

Err_GetERConts2000:
    MsgBox Error$
    Resume Exit_GetERconts2000



End Function

Function GetERNIRebate(Taxyear, TableUsed, Period, PeriodNumber, Category, GrossPay, LEL, EE_ET, ER_ET)

' Author            : Christopher Schuler
' Date              : 11 November 1999
' Purpose           : To return the employer's NI Rebate if any

On Error GoTo Err_GetERNIRebate

Dim ERNIRebate As Double
Dim ERRebateRate             'Employer rate of NI rebate
Dim GrossPayStep As Double
Dim stepincrement As Double   'Incremental step in NIC tables
Dim MidpointAdjustment


' If calculation is not possible, exit the function.
If IsNull(Taxyear) Or IsNull(TableUsed) Or IsNull(Period) Or PeriodNumber = 0 Or _
   IsNull(Category) Or IsNull(GrossPay) Then
   
    GetERNIRebate = 0
    Exit Function
End If


' Use the index to locate the year.
Class1RateTable.Index = "PrimaryKey"

Class1RateTable.Seek "<=", Taxyear, Category

' If the year is not found.
If Class1RateTable.NoMatch Then

    GetERNIRebate = 0
    Exit Function

Else
    'EmployeeRate
    ERRebateRate = Class1RateTable![ER NIC Rebate]
    
    Select Case UCase$(Period)

    Case "W"
    MidpointAdjustment = ERRebateRate / 2
    Case "M"
    MidpointAdjustment = ERRebateRate * 2

    End Select
    
End If
       
If GrossPay < LEL Or GrossPay > ER_ET Then
     GoTo NextPartERNIRebate
End If

    ' If using the tables.
If TableUsed = "Yes" Then
    
    'calculate the step value
    Select Case UCase$(Period)
    
    Case "W"
     GrossPayStep = Int(GrossPay)
    
    Case "M"
    If Taxyear = 2000 Then
        GrossPayStep = (Int((GrossPay - 3) / 4) * 4) + 3
    Else
        GrossPayStep = Int(GrossPay / 4) * 4
    End If
    
    
    End Select
    
        If Period = "M" Then
            If (GrossPayStep + stepincrement) > EE_ET And GrossPay < EE_ET Then
                MidpointAdjustment = MidpointAdjustment / 2
            End If
            
            If GrossPayStep <= EE_ET And GrossPay >= EE_ET Then
                MidpointAdjustment = MidpointAdjustment * 3 / 2
            End If
            
            If (GrossPayStep + stepincrement) > ER_ET And GrossPay < ER_ET Then
                MidpointAdjustment = MidpointAdjustment / 2
            End If
            
            If GrossPayStep <= ER_ET And GrossPay >= ER_ET Then
                MidpointAdjustment = MidpointAdjustment * 3 / 2
            End If
        End If
    
        'Employer NI Rebate
        If GrossPayStep > LEL And GrossPay < ER_ET Then
            ERNIRebate = (GrossPayStep - LEL) * ERRebateRate + MidpointAdjustment
       
        ElseIf GrossPay >= ER_ET Then
            ERNIRebate = (ER_ET - LEL) * ERRebateRate
            
        End If
    
Else
NextPartERNIRebate:
    'Employer NI Rebate
    
    If GrossPay <= LEL Then
    
        ERNIRebate = 0
    
    ElseIf GrossPay > LEL And GrossPay <= ER_ET Then
    
        ERNIRebate = (GrossPay - LEL) * ERRebateRate
    
    ElseIf GrossPay > ER_ET Then
    
        ERNIRebate = (ER_ET - LEL) * ERRebateRate
    
    End If

End If

GetERNIRebate = curRound(ERNIRebate)

Exit_GetERNIRebate:
    Exit Function

Err_GetERNIRebate:
    MsgBox Error$
    Resume Exit_GetERNIRebate


End Function

Function GetERNIRebate01(Taxyear, TableUsed, Period, PeriodNumber, Category, GrossPay, LEL, ET_PT)

' Author            : Christopher Schuler
' Date              : 11 November 2000
' Purpose           : To return the employer's NI Rebate if any from 2001
' Author            : Christopher Schuler
' Date              : 30 january 2002
' Purpose           : Amendment for tax year 2002

On Error GoTo Err_GetERNIRebate01

Dim ERNIRebate As Double
Dim ERRebateRate             'Employer rate of NI rebate
Dim GrossPayStep As Double
Dim stepincrement As Double   'Incremental step in NIC tables
Dim MidpointAdjustment


' If calculation is not possible, exit the function.
If IsNull(Taxyear) Or IsNull(TableUsed) Or IsNull(Period) Or PeriodNumber = 0 Or IsNull(Category) Or IsNull(GrossPay) Then
    GetERNIRebate01 = 0
    Exit Function
End If


' Use the index to locate the year.
Class1RateTable.Index = "PrimaryKey"

Class1RateTable.Seek "<=", Taxyear, Category

' If the year is not found.
If Class1RateTable.NoMatch Then

    GetERNIRebate01 = 0
    Exit Function

Else
    'EmployeeRate
    ERRebateRate = Class1RateTable![ER NIC Rebate]
    
    Select Case UCase$(Period)

        Case "W"
            MidpointAdjustment = ERRebateRate / 2
        Case "M"
            MidpointAdjustment = ERRebateRate * 2
            stepincrement = 4
    End Select
    
End If
       
If GrossPay < LEL Or GrossPay > ET_PT Then
     GoTo NextPartERNIRebate01
End If

    ' If using the tables.
If TableUsed = "Yes" Then
    
    ' Calculate the step value
    Select Case UCase$(Period)
    Case "W"
        GrossPayStep = Int(GrossPay)

    Case "M"
        GrossPayStep = GrossPayStepMonthly(Taxyear, GrossPay)
    End Select
    
    If Period = "M" Then
        If (GrossPayStep) > ET_PT And GrossPay < ET_PT Then
            MidpointAdjustment = MidpointAdjustment / 2
        End If
        
        If GrossPayStep <= ET_PT And GrossPay >= ET_PT Then
            MidpointAdjustment = MidpointAdjustment * 3 / 2
        End If
        
        If Taxyear = 2007 Then
            If (GrossPayStep + stepincrement) > ET_PT And GrossPay < ET_PT Then
                MidpointAdjustment = MidpointAdjustment / 2
            End If
        ElseIf Taxyear > 2002 Then
            If (GrossPayStep + stepincrement) > ET_PT And GrossPay < ET_PT Then
                MidpointAdjustment = MidpointAdjustment * 3 / 4
            End If
            If GrossPayStep < ET_PT And GrossPay >= ET_PT Then
                MidpointAdjustment = MidpointAdjustment * 3 / 2
            End If
        End If
    End If

    'Employer NI Rebate
    
    
    If GrossPayStep > LEL And GrossPay < ET_PT Then
    
        ERNIRebate = (GrossPayStep - LEL) * ERRebateRate + MidpointAdjustment
   
    ElseIf GrossPay >= ET_PT Then
    
        ERNIRebate = (ET_PT - LEL) * ERRebateRate
    
    End If
    
Else
NextPartERNIRebate01:
    'Employer NI Rebate
    
    If GrossPay <= LEL Then
    
        ERNIRebate = 0
    
    ElseIf GrossPay > LEL And GrossPay <= ET_PT Then
    
        ERNIRebate = (GrossPay - LEL) * ERRebateRate
    
    ElseIf GrossPay > ET_PT Then
    
        ERNIRebate = (ET_PT - LEL) * ERRebateRate
    
    End If

End If

GetERNIRebate01 = curRound(ERNIRebate)

Exit_GetERNIRebate01:
    Exit Function

Err_GetERNIRebate01:
    MsgBox Error$
    Resume Exit_GetERNIRebate01



End Function

Public Function GetNIRebate11(ByRef Taxyear As Integer, _
                                ByRef TableUsed, _
                                ByRef Period, _
                                ByRef Category, _
                                ByRef GrossPay, _
                                ByRef startThreshold, _
                                ByRef endThreshold, _
                                ByRef calcType)

'   Author  :   Ben Stephenson
'   Date    :   16/05/2011
'   Project :   CCA10512
'   Desc    :   Determine the NIC rebate applicable between two threshold values for the emploeyee
'               or the employer

Dim Rebate As Double
Dim RebateRate As Double
Dim GrossPayStep As Double
Dim MidpointAdjustment As Double
Dim ST_range As Double

' Assume calc went O.K.
GetNIRebate11 = True

' If calculation is not possible, exit the function.
If IsNull(Taxyear) Or IsNull(TableUsed) Or IsNull(Period) Or _
   IsNull(Category) Or IsNull(GrossPay) Then
   
    GetNIRebate11 = 0
    Exit Function
End If


' Use the index to locate the year.
Class1RateTable.Index = "PrimaryKey"
Class1RateTable.Seek "<=", Taxyear, Category

' If the year is not found.
If Class1RateTable.NoMatch Then
    GetNIRebate11 = 0
    Exit Function
Else
    If calcType = cEmployee Then
        RebateRate = Class1RateTable![EE NIC Rebate]
    Else
        ' Post 2010 uses a different rebate field in the dataset
        If Taxyear > 2010 Then
            RebateRate = Class1RateTable![ER_RebateToST]
        Else
            RebateRate = Class1RateTable![ER NIC Rebate]
        End If
    End If
    
    Select Case UCase$(Period)
        Case "W"
            MidpointAdjustment = RebateRate / 2
        Case "M"
            MidpointAdjustment = RebateRate * 2
    End Select
End If

' Determine any Midpoint Adjustment if neccessary
If TableUsed = "Yes" Then

    Select Case UCase$(Period)
    Case "W"
        GrossPayStep = Int(GrossPay)
        
    Case "M"
        GrossPayStep = GrossPayStepMonthly(Taxyear, GrossPay)
    End Select
    
    If Period = "M" Then
        
        
  
        
        If (GrossPayStep) > endThreshold And _
            GrossPay < endThreshold Then
            
            MidpointAdjustment = MidpointAdjustment / 2
        End If
        
        'If GrossPayStep = GrossPay Then
        '    MidpointAdjustment = 0
        'End If
        
        If GrossPayStep < endThreshold And _
           GrossPay > endThreshold Then
           
            MidpointAdjustment = MidpointAdjustment * 3 / 2
        End If
        
        If (GrossPayStep + stepincrement) > endThreshold And _
            GrossPay < endThreshold Then
            
            MidpointAdjustment = MidpointAdjustment * 3 / 4
        End If
        
        If GrossPayStep < endThreshold And _
           GrossPay >= endThreshold Then
           
            MidpointAdjustment = MidpointAdjustment * 3 / 2
        End If
    End If
    

   
    ST_range = NIRateBandTable![MnthST] 'CQ10651
    
    'If GrossPayStep = ST_range Then
    If calcType = cEmployee Then
        If GrossPay = ST_range Then
            Rebate = (GrossPayStep - startThreshold) * RebateRate
        Else
    
            If GrossPayStep > startThreshold And GrossPay < endThreshold Then
    
                Rebate = (GrossPayStep - startThreshold) * RebateRate + MidpointAdjustment
   
            ElseIf GrossPay >= endThreshold Then
    
                Rebate = (endThreshold - startThreshold) * RebateRate
    
            End If
        End If
   Else
    'If GrossPay = ST_range Then
    '   Rebate = 0
    'Else
    
        If GrossPay = ST_range Then
            Rebate = (GrossPayStep - startThreshold) * RebateRate
        Else
    
            If GrossPayStep > startThreshold And GrossPay < endThreshold Then
    
                Rebate = (GrossPayStep - startThreshold) * RebateRate + MidpointAdjustment
   
            ElseIf GrossPay >= endThreshold Then
    
                Rebate = (endThreshold - startThreshold) * RebateRate
    
            End If
        End If
    'End If
  End If
Else
' Just use the normal percentage calc
    If GrossPay <= startThreshold Then
        Rebate = 0
        
    ElseIf GrossPay > startThreshold And _
           GrossPay <= endThreshold Then
           
        Rebate = (GrossPay - startThreshold) * RebateRate
        
    ElseIf GrossPay > endThreshold Then
        Rebate = (endThreshold - startThreshold) * RebateRate
    End If

End If

GetNIRebate11 = curRound(Rebate)

Exit_GetNIRebate11:
    Exit Function
    
ERR_GetNIRebate11:
    MsgBox Error$
    Resume Exit_GetNIRebate11
    
End Function

Function GetETToUEL(Taxyear, TableUsed, Period, PeriodNumber, Category, GrossPay)

' Author            : Christopher Schuler
' Date              : 29 July 1999
' Purpose           : To return the amount of grosspay between earnings threshold
'                       and upper earnings limit
' Author            : Christopher Sneddon
' Date              : 9th March 2009
' Purpose           : Updates to calculations for UAP and 2009

On Error GoTo Err_GetETToUEL

Dim yearvalue As Integer
Dim stepvalue As Double
Dim LastGrossPay As Double
Dim LEL As Double    'Lower Earnings Limit
Dim ET_PT As Double     'Earnings Threshold
Dim UAP As Double    'Upper Accrual Limit
Dim UEL As Double    'Upper Earnings Limit
Dim UpToLEL As Double       'To Lower Earnings limit
Dim LELtoET As Double     'Lower Earnings Limit to Earnings Threshold
Dim ETtoUEL As Double     'Earnings Threshold to Upper Earnings Limit
Dim GrossPayStep As Double
Dim stepincrement As Double


' If calculation is not possible, exit the function.
If IsNull(Taxyear) Or IsNull(TableUsed) Or IsNull(Period) Or PeriodNumber = 0 Or IsNull(Category) Or IsNull(GrossPay) Then
    GetETToUEL = 0
    Exit Function
End If

' Convert the year into a number representation.
yearvalue = Val(Forms!PCGForm.Taxyear)

' Use the index to locate the year.
NIRateBandTable.Index = "PrimaryKey"
NIRateBandTable.Seek "=", yearvalue

' If the year is not found.
If NIRateBandTable.NoMatch Then

    GetETToUEL = 0
    Exit Function

Else

    Select Case UCase$(Period)

    Case "W"
        
        ' Set the global bands.
        LEL = NIRateBandTable![WkLEL]
        ET_PT = NIRateBandTable![WkER_ET]
        If Taxyear > 2008 Then
        UAP = NIRateBandTable![wkUAP]
        End If
        UEL = NIRateBandTable![WkUEL]
        

            stepincrement = 1
            
    Case "M"

        ' Set the global bands.
        LEL = NIRateBandTable![MnthLEL]
        ET_PT = NIRateBandTable![MnthER_ET]
        If Taxyear > 2008 Then
        UAP = NIRateBandTable![MnthUAP]
        End If
        UEL = NIRateBandTable![MnthUEL]
        
            stepincrement = 4
            

    Case Else

        GetETToUEL = 0
        Exit Function
        
    End Select
        
    'csne
    If GrossPay < ET_PT Or GrossPay >= UEL Then
        GoTo NextPartETToUEL
    Else
        stepvalue = LEL
    End If
  
        
End If

   
    ' If using the tables.
    If TableUsed = "Yes" Then
        LastGrossPay = stepvalue
                                                



  'Alternative method
    Select Case UCase$(Period)

    Case "W"
     GrossPayStep = Int(GrossPay)
    Case "M"
     GrossPayStep = (Int((GrossPay - 2) / 4) * 4) + 2

    End Select



        
        'Calculate ETToLEL
    
    
    
        If GrossPayStep > ET_PT And GrossPayStep < UEL Then
    
            ETtoUEL = GrossPayStep - ET_PT
    
        End If
    
Else
NextPartETToUEL:
        'Calculate ETToUEL
    
    If GrossPay <= LEL Then
            
            ETtoUEL = 0

        ElseIf GrossPay > LEL And GrossPay <= ET_PT Then
    
            ETtoUEL = 0

        ElseIf GrossPay > ET_PT And GrossPay <= UEL Then

            ETtoUEL = GrossPay - ET_PT

        ElseIf GrossPay > UEL Then

            ETtoUEL = UEL - ET_PT

    End If

End If

GetETToUEL = Int(ETtoUEL)


Exit_GetETTOUEL:
    Exit Function

Err_GetETToUEL:
    MsgBox Error$
    Resume Exit_GetETTOUEL



End Function

Function GetETToUEL01(Taxyear, TableUsed, Period, GrossPay, ET_PT, UEL)

' Author            : Christopher Schuler
' Date              : 14 November 2000
' Purpose           : To return the amount of grosspay between earnings threshold
'                       and upper earnings limit
' Author            : Christopher Schuler
' Date              : 30 january 2002
' Purpose           : Amendment for tax year 2002
' Author            : Christopher Schuler
' Date              : 23 December 2003
' Purpose           : Amendment for tax year 2004

On Error GoTo Err_GetETToUEL01


Dim ETtoUEL As Double     'Earnings Threshold to Upper Earnings Threshold

Dim GrossPayStep As Double


    ' If using the tables.
If TableUsed = "Yes" Then
                                                
        'calculate the step value
        Select Case UCase$(Period)
    
        Case "W", "4w"
            
            GrossPayStep = Int(GrossPay)
        
        Case "M"
            
            GrossPayStep = GrossPayStepMonthly(Taxyear, GrossPay)
    
        End Select
         

        'Calculate ETToUEL

            If GrossPay >= UEL Then
                
                GrossPayStep = UEL
            
            End If
            
            If GrossPayStep < ET_PT And GrossPay > UEL Then
                
                GrossPayStep = ET_PT
            
            End If
            
            If Taxyear = 2003 Or Taxyear = 2007 Then
                'If Grosspaystep < ET_PT And GrossPay > ET_PT Then
                If GrossPayStep < ET_PT And GrossPay >= ET_PT Then

                
                    ETtoUEL = GrossPay - ET_PT
                End If
            End If
            

            If GrossPayStep > ET_PT And GrossPayStep <= UEL Then
            
                ETtoUEL = GrossPayStep - ET_PT
        
            End If
        
Else

        'Calculate ETToUEL
    
    If GrossPay <= ET_PT Then
            
            ETtoUEL = 0

         ElseIf GrossPay > ET_PT And GrossPay <= UEL Then
    
            ETtoUEL = GrossPay - ET_PT

        ElseIf GrossPay > ET_PT Then

            ETtoUEL = UEL - ET_PT

    End If

End If

' Return the earnings.
GetETToUEL01 = Int(ETtoUEL)


Exit_GetETToUEL01:
    Exit Function

Err_GetETToUEL01:
    MsgBox Error$
    Resume Exit_GetETToUEL01




End Function


Function GetLELToEE_ET(TableUsed, Period, GrossPay, LEL, EE_ET)

' Author            : Christopher Schuler
' Date              : 2 November 1999
' Purpose           : To return the amount of gross pay between lower earnings limit
'                      and employee earnings threshold


On Error GoTo Err_GetLELToEE_ET


Dim LELToEE_ET As Double     'Employee Earnings Threshold to Employer Earnings Threshold

Dim GrossPayStep As Double


    ' If using the tables.
If TableUsed = "Yes" Then
                                                
        'calculate the step value
        Select Case UCase$(Period)
    
        Case "W", "4w"
         GrossPayStep = Int(GrossPay)
        Case "M"
         GrossPayStep = (Int((GrossPay - 3) / 4) * 4) + 3
    
        End Select
         

        'Calculate LELToEE_ET

            If GrossPay >= EE_ET Then
                
                GrossPayStep = EE_ET
            
            End If
            
            If GrossPayStep < LEL And GrossPay > EE_ET Then
                
                GrossPayStep = LEL
            
            End If

            If GrossPayStep > LEL And GrossPayStep <= EE_ET Then
            
                LELToEE_ET = GrossPayStep - LEL
        
            End If
        
Else

        'Calculate LELToEE_ET
    
    If GrossPay <= LEL Then
            
            LELToEE_ET = 0

         ElseIf GrossPay > LEL And GrossPay <= EE_ET Then
    
            LELToEE_ET = GrossPay - LEL

        ElseIf GrossPay > LEL Then

            LELToEE_ET = EE_ET - LEL

    End If

End If

' Return the earnings.
GetLELToEE_ET = Int(LELToEE_ET)


Exit_GetLELToEE_ET:
    Exit Function

Err_GetLELToEE_ET:
    MsgBox Error$
    Resume Exit_GetLELToEE_ET

End Function

Function GetLELToET(Taxyear, TableUsed, Period, PeriodNumber, Category, GrossPay)

' Author            : Christopher Schuler
' Date              : 29 July 1999
' Purpose           : To return the amount of gross pay between lower earnings limit
'                      and earnings threshold


On Error GoTo Err_GetLELToET

Dim yearvalue As Integer
Dim stepvalue As Double
Dim LastGrossPay As Double
Dim LEL As Double    'Lower Earnings Limit
Dim ET_PT As Double     'Earnings Threshold


Dim LELtoET As Double     'Lower Earnings Limit to Earnings Threshold

Dim GrossPayStep As Double
Dim stepincrement As Double



' If calculation is not possible, exit the function.
If IsNull(Taxyear) Or IsNull(TableUsed) Or IsNull(Period) Or _
   PeriodNumber = 0 Or IsNull(Category) Or IsNull(GrossPay) Then
   
    GetLELToET = 0
    Exit Function
End If

' Convert the year into a number representation.
yearvalue = Val(Forms!PCGForm.Taxyear)

' Use the index to locate the year.
NIRateBandTable.Index = "PrimaryKey"
NIRateBandTable.Seek "=", yearvalue

' If the year is not found.
If NIRateBandTable.NoMatch Then
    GetLELToET = 0
    Exit Function

Else
    Select Case UCase$(Period)
    Case "W"
        ' Set the global bands.
        LEL = NIRateBandTable![WkLEL]
        ET_PT = NIRateBandTable![WkER_ET]
        stepincrement = 1

    Case "M"
        ' Set the global bands.
        LEL = NIRateBandTable![MnthLEL]
        ET_PT = NIRateBandTable![MnthER_ET]
        stepincrement = 4
            
    Case Else
        GetLELToET = 0
        Exit Function
        
    End Select
        
    If GrossPay < LEL Or GrossPay > ET_PT Then
        GoTo NextPartLELToET
    Else
        stepvalue = LEL
    End If
End If

' If using the tables.
If TableUsed = "Yes" Then
    LastGrossPay = LEL

    Select Case UCase$(Period)
    Case "W"
     GrossPayStep = Int(GrossPay)
     
    Case "M"
     GrossPayStep = (Int((GrossPay - 2) / 4) * 4) + 2
    End Select


    'Calculate ETToLEL

    If GrossPay = ET_PT Then
        
        GrossPayStep = ET_PT
    
    End If
    
    If GrossPayStep > LEL And GrossPayStep <= ET_PT Then
    
        LELtoET = GrossPayStep - LEL

    End If
        
Else
NextPartLELToET:
    'Calculate ETToLEL
    If GrossPay <= LEL Then
            
        LELtoET = 0

    ElseIf GrossPay > LEL And GrossPay <= ET_PT Then
    
        LELtoET = GrossPay - LEL

    ElseIf GrossPay > ET_PT Then

        LELtoET = ET_PT - LEL

    End If
End If

' Return the earnings.
GetLELToET = Int(LELtoET)


Exit_GetLELToET:
    Exit Function

Err_GetLELToET:
    MsgBox Error$
    Resume Exit_GetLELToET


End Function

Function GetLELToET01(Taxyear, TableUsed, Period, GrossPay, LEL, ET_PT)

' Author            : Christopher Schuler
' Date              : 14 November 2000
' Purpose           : To return the amount of gross pay between lower earnings limit
'                     and employee earnings threshold  (2001)
' Author            : Christopher Schuler
' Date              : 30 january 2002
' Purpose           : Amendment for tax year 2002
' Author            : Christopher Schuler
' Date              : 23 December 2003
' Purpose           : Amendment for tax year 2004
' Author            : Ben Stephenson
' Date              : 13/06/2011
' Purpose           : For post 2010 calcs this function may be used to determine the LELtoPT and the LELtoST


On Error GoTo Err_GetLELToET01


Dim LELtoET As Double     'Employee Earnings Threshold to Employer Earnings Threshold
Dim GrossPayStep As Double   'The value which would be looked up in the employers tables


    ' If using the tables.
If TableUsed = "Yes" Then
                                                
    'calculate the step value
    Select Case UCase$(Period)
    Case "W", "4w"
        GrossPayStep = Int(GrossPay)
        
    Case "M"
        GrossPayStep = GrossPayStepMonthly(Taxyear, GrossPay)
  
    End Select
         

    'Calculate LELToET

    If GrossPay >= ET_PT Then
        GrossPayStep = ET_PT
    End If
            
    If GrossPayStep < LEL And GrossPay > ET_PT Then
        GrossPayStep = LEL
    End If

    If GrossPayStep > LEL And GrossPayStep <= ET_PT Then
        LELtoET = GrossPayStep - LEL
    End If
        
Else
    'Calculate LELToET
    
    If GrossPay <= LEL Then
        LELtoET = 0
    ElseIf GrossPay > LEL And GrossPay <= ET_PT Then
        LELtoET = GrossPay - LEL
    ElseIf GrossPay > LEL Then
        LELtoET = ET_PT - LEL
    End If
End If

' Return the earnings.
GetLELToET01 = Int(LELtoET)


Exit_GetLELToET01:
    Exit Function

Err_GetLELToET01:
    MsgBox Error$
    Resume Exit_GetLELToET01

End Function

Function GetNIRebate(Taxyear, TableUsed, Period, Category, GrossPay)

' Author            : Christopher Schuler
' Date              : 29 July 1999
' Purpose           : To return the employer's NI Rebate if any

On Error GoTo Err_GetNIRebate

Dim yearvalue As Integer
Dim stepvalue As Double
Dim LastGrossPay As Double
Dim LEL As Double    'Lower Earnings Limit
Dim ET_PT As Double     'Earnings Threshold
Dim UEL As Double    'Upper Earnings Limit
Dim UpToLEL As Double       'To Lower Earnings limit
Dim LELtoET As Double     'Lower Earnings Limit to Earnings Threshold
Dim ETtoUEL As Double     'Earnings Threshold to Upper Earnings Limit
Dim NIRebate As Double
Dim RebateRate             'Employer rate of NI rebate
Dim GrossPayStep As Double
Dim stepincrement As Double
Dim MidpointAdjustment


' If calculation is not possible, exit the function.
If IsNull(Taxyear) Or IsNull(TableUsed) Or IsNull(Period) Or _
   IsNull(Category) Or IsNull(GrossPay) Then
    GetNIRebate = 0
    Exit Function
End If

' Convert the year into a number representation.
yearvalue = Val(Forms!PCGForm.Taxyear)

' Use the index to locate the year.
NIRateBandTable.Index = "PrimaryKey"
NIRateBandTable.Seek "=", yearvalue

' If the year is not found.
If NIRateBandTable.NoMatch Then
    GetNIRebate = 0
    Exit Function

Else
    Select Case UCase$(Period)
    Case "W"
        ' Set the global bands.
        LEL = NIRateBandTable![WkLEL]
        ET_PT = NIRateBandTable![WkER_ET]
     
        stepincrement = 1

    Case "M"
        ' Set the global bands.
        LEL = NIRateBandTable![MnthLEL]
        ET_PT = NIRateBandTable![MnthER_ET]
    
        stepincrement = 4
            
    Case Else
        GetNIRebate = 0
        Exit Function
    End Select
End If

Class1RateTable.Index = "PrimaryKey"

Class1RateTable.Seek "<=", yearvalue, Category

' If the year is not found.
If Class1RateTable.NoMatch Then

    GetNIRebate = 0
    Exit Function

Else
    'EmployeeRate
    RebateRate = Class1RateTable![ER NIC Rebate]
    Select Case UCase$(Period)

    Case "W"
    MidpointAdjustment = RebateRate / 2
    Case "M"
    MidpointAdjustment = RebateRate * 2

    End Select
    
End If
       
If GrossPay < LEL Or GrossPay > ET_PT Then
     GoTo NextPartNIRebate
Else
     stepvalue = LEL - stepincrement
End If

    ' If using the tables.
If TableUsed = "Yes" Then
    
    LastGrossPay = LEL
                                                
    Select Case UCase$(Period)
    Case "W"
        GrossPayStep = Int(GrossPay)
    Case "M"
        GrossPayStep = (Int((GrossPay - 2) / 4) * 4) + 2
    End Select
    
    'Employer NI Rebate
    If Period = "M" Then
        Select Case Category
        Case "D", "E"
            If GrossPayStep + stepincrement > ET_PT And GrossPay < ET_PT Then
                  MidpointAdjustment = 0.04
            End If
            If GrossPayStep < ET_PT And GrossPay >= ET_PT Then
                  MidpointAdjustment = 0.09
            End If
    
        Case "F", "G", "S"
            If GrossPayStep + stepincrement > ET_PT And GrossPay < ET_PT Then
                  MidpointAdjustment = 0.01
            End If
            If GrossPayStep < ET_PT And GrossPay >= ET_PT Then
                  MidpointAdjustment = 0.02
            End If
        End Select
    End If
                
    If GrossPayStep > LEL And GrossPayStep < ET_PT Then
    
            NIRebate = (GrossPayStep - LEL) * RebateRate + MidpointAdjustment
    
        ElseIf GrossPayStep >= ET_PT Then
    
            NIRebate = (ET_PT - LEL) * RebateRate
    
    End If
Else
NextPartNIRebate:
    'Employer NI Rebate
    
    If GrossPay <= LEL Then
    
        NIRebate = 0
    
    ElseIf GrossPay > LEL And GrossPay <= ET_PT Then
    
        NIRebate = (GrossPay - LEL) * RebateRate
    
    ElseIf GrossPay > ET_PT Then
    
        NIRebate = (ET_PT - LEL) * RebateRate
    End If
End If

GetNIRebate = curRound(NIRebate)

Exit_GetNIRebate:
    Exit Function

Err_GetNIRebate:
    MsgBox Error$
    Resume Exit_GetNIRebate

End Function

Public Function GetEarningsBetweenThresholds(ByRef Taxyear As Integer, _
                                             ByRef TableUsed, _
                                             ByRef Period, _
                                             ByRef GrossPay, _
                                             ByVal lowerThreshold, _
                                             ByVal upperThreshold)

'   Author  :   Ben Stephenson
'   Date    :   15/06/2011
'   Project :   CCA10512
'   Desc    :   Determine the earnings between the ST and PT.  Only used post 2010

On Err GoTo Err_GetEarningsBetweenThresholds
Dim GrossPayStep
Dim Earnings

' If calculation is not possible, exit the function.
If IsNull(Taxyear) Or IsNull(TableUsed) Or _
   IsNull(Period) Or IsNull(GrossPay) Or _
   IsNull(lowerThreshold) Or IsNull(upperThreshold) Then
   
    GetEarningsBetweenThresholds = 0
    GoTo Exit_GetEarningsBetweenThresholds
End If

' Use the index to locate the year.
NIRateBandTable.Index = "PrimaryKey"
NIRateBandTable.Seek "=", Val(Taxyear)

' If the year is not found.
If NIRateBandTable.NoMatch Then
    GetEarningsBetweenThresholds = 0
    GoTo Exit_GetEarningsBetweenThresholds
End If

If TableUsed = "Yes" Then
    'calculate the step value
    Select Case UCase$(Period)
    Case "W", "4w"
        GrossPayStep = Int(GrossPay)
        
    Case "M"
        GrossPayStep = GrossPayStepMonthly(Taxyear, GrossPay)
    End Select
    
'    If GrossPay <= lowerThreshold Then
'        Earnings = 0
'    End If
    
    If GrossPayStep >= lowerThreshold Then
        Earnings = GrossPayStep - lowerThreshold
    Else
        Earnings = 0
    End If
    
    If GrossPay >= upperThreshold Then
        GrossPayStep = upperThreshold
    End If
            
    If GrossPayStep < lowerThreshold And GrossPay > upperThreshold Then
        GrossPayStep = lowerThreshold
    End If

    If GrossPayStep >= lowerThreshold And GrossPayStep <= upperThreshold Then
        Earnings = GrossPayStep - lowerThreshold
    End If
    
Else
    If GrossPay <= lowerThreshold Then
        Earnings = 0
        
    ElseIf GrossPay > lowerThreshold And GrossPay <= upperThreshold Then
        Earnings = GrossPay - lowerThreshold
        
    ElseIf GrossPay > lowerThreshold And GrossPay > upperThreshold Then
        Earnings = upperThreshold - lowerThreshold
    End If
End If

'CSNE_2012
'GetEarningsBetweenThresholds = Int(Earnings)
GetEarningsBetweenThresholds = Earnings

Exit_GetEarningsBetweenThresholds:
    Exit Function

Err_GetEarningsBetweenThresholds:
    MsgBox Error$
    Resume Exit_GetEarningsBetweenThresholds
    
End Function

Function GetUpToLEL(ByRef Taxyear, _
                    ByRef TableUsed, _
                    ByRef Period, _
                    ByRef Category, _
                    ByRef GrossPay, _
                    ByRef LEL)

' Author            : Christopher Schuler
' Date              : 29 July 1999
' Purpose           : To return the amount of gross pay equal to the lower earnings limit

' Author            : Ben Stephenson
' Date              : 17/06/1988
' Purpose           : By the time we call this function we are already aware of the appropriate LEL value so
'                     there is no need to recalculate it - included LEL as argument

' Author            : Christopher Sneddon
' Date              : 15 December 2011
' Purpose           : Alas not all years are aware of the LEL etc before this point EARS**********
'                     Code has been amended for earlier years to detect LEL etc




On Error GoTo Err_GetUpToLEL

Dim yearvalue As Integer

Dim LastGrossPay As Double
Dim UpToLEL As Double       'To Lower Earnings limit



' If calculation is not possible, exit the function.
If IsNull(Taxyear) Or IsNull(TableUsed) Or IsNull(Category) Or _
   IsNull(Period) Or IsNull(GrossPay) Then
    GetUpToLEL = 0
    Exit Function
End If

' Convert the year into a number representation.
yearvalue = Val(Taxyear)

' Use the index to locate the year.
NIRateBandTable.Index = "PrimaryKey"
NIRateBandTable.Seek "=", yearvalue

' If the year is not found.
If NIRateBandTable.NoMatch Then

    GetUpToLEL = 0
    Exit Function
End If

    If GrossPay >= LEL Then
        UpToLEL = LEL
    Else
        UpToLEL = 0
    End If

GetUpToLEL = Int(UpToLEL)

Exit_GetUpToLEL:
    Exit Function

Err_GetUpToLEL:
    MsgBox Error$
    Resume Exit_GetUpToLEL


End Function

Function nMonthlyConversionvalue(ByVal Earnings, ByVal LEL, ByVal Band2, ByVal Band3, ByVal Band4, ByVal UEL)
' Author            : Mustaq Hussain
' Date              : 6 March 1996
' Name              : nMonthlyConversionvalue
' Purpose           : Returns conversion value, which takes into account non-stepped band changes


    Dim Nextvalue

    On Error GoTo Err_nMonthlyConversionvalue

    ' NSBand(Earnings) --------> SteppedEarnings+4
    If bSteppedValue(Earnings, LEL) = False Then
        Dim nSteppedEarnings

        nSteppedEarnings = Int((Earnings - LEL) / 4) * 4 + LEL

        Nextvalue = nSteppedEarnings + 4
        GoTo Carry_Out_Average

    End If

    If bSteppedValue(Earnings, LEL) = True And bSteppedValue(Earnings + 4, LEL) = True Then

        Dim Band
        Dim Count As Integer
        
        For Count = 1 To 5 Step 1
            Select Case Count
                Case 5
                    Band = LEL
                Case 4
                    Band = Band2
                Case 3
                    Band = Band3
                Case 2
                    Band = Band4
                Case 1
                    Band = UEL
            End Select

            ' SBand at one end or the other
            ' Earnings(SBand) ------> Earnings+4(SBand)
            If bSteppedValue(Band, LEL) = True And (Earnings = Band Or Earnings + 4 = Band) Then
                Nextvalue = Earnings + 4
                GoTo Carry_Out_Average
            End If
            
            ' NSBand is next earnings step
            ' SEarnings(Earnings) ---------> NSBand
            If (Earnings < Band) And (Earnings + 4 > Band) Then
                Nextvalue = Band
                GoTo Carry_Out_Average
            End If


        Next
        ' Default
        ' Earnings -------> Earnings+4
        Nextvalue = Earnings + 4
        GoTo Carry_Out_Average

    End If

Carry_Out_Average:
    
    nMonthlyConversionvalue = (Nextvalue - Earnings) / 2

Exit_nMonthlyConversionvalue:
    Exit Function

Err_nMonthlyConversionvalue:
    MsgBox Error$
    Resume Exit_nMonthlyConversionvalue

End Function

Function GrossPayStepMonthly(Taxyear, GrossPay)
' Author            : Christopher Schuler
' Date              : 23 December 2003
' Purpose           : To return the step value that corresponds to the monthly NI look up tables
' Author            : Christopher Schuler
' Date              : 4 May 2005
' Purpose           : Amended for 2005 (v1937560)

On Error GoTo Err_GrosspaystepMonthly

    If Taxyear = 2001 Or Taxyear = 2005 Or Taxyear = 2006 Or Taxyear = 2009 Or Taxyear = 2012 Then
        
        GrossPayStepMonthly = (Int(GrossPay / 4) * 4)

    ElseIf Taxyear = 2003 Or Taxyear = 2008 Or Taxyear = 2011 Or Taxyear = 2017 Then
    
        GrossPayStepMonthly = (Int((GrossPay - 2) / 4) * 4) + 2
        
    ElseIf Taxyear = 2004 Then
        
        GrossPayStepMonthly = (Int((GrossPay - 3) / 4) * 4) + 3
        
    ElseIf Taxyear = 2015 Or Taxyear = 2016 Then
        GrossPayStepMonthly = (Int((GrossPay - 3) / 4) * 4) + 4
        'GrossPayStepMonthly = (Int((GrossPay - 3) / 4) * 4) + 3
        'GrossPayStepMonthly = (Int((GrossPay - 2) / 4) * 4) + 2
        'GrossPayStepMonthly = (Int(GrossPay / 4) * 4)
    Else
        
        GrossPayStepMonthly = (Int((GrossPay - 1) / 4) * 4) + 1
    
    End If

Exit_GrosspaystepMonthly:
    Exit Function

Err_GrosspaystepMonthly:
    MsgBox Error$
    Resume Exit_GrosspaystepMonthly
    
End Function

Public Function b2000NICalc(Taxyear As Integer)

' Author            : Christopher schuler
' Date              : 2 November 1999
' Purpose           : To calculate NI contributions from 2000
' Author            : Christopher schuler
' Date              : 4 May 2005
' Purpose           : V1876922 - correction to NIC rebate calc when EE conts are less than EE NIC rebate

    Dim strNextRecord As String
    Const cstrAll_RECORDS_PROCESSED = "All the records processed"
    
    On Error GoTo Err_b2000NICalc
    
    Dim PrevControl As Control
    Set PrevControl = Screen.PreviousControl
    
    DoCmd.Hourglass True
    

    Dim DB As Database
    Dim DataTable As DAO.Recordset
    Dim DataTableClone As DAO.Recordset
    Dim LEL     'Lower Earnings Limit
    Dim EE_ET   'Employee's Earnings Threshold
    Dim ER_ET   'Employer's Earnings Threshold
    Dim UEL     'Upper Earnings Limit
    Dim stepincrement As Double   'Incremental step in NIC tables
    ' Assume correct
    b2000NICalc = True
    
    Set DB = CurrentDb()
    
    Set DataTable = DB.OpenRecordset("tblContributions2000")
   
    Set DataTableClone = DataTable.Clone()
    
    
    ' Check year set
    'If IsNull(Forms!PCGForm.Taxyear) Or Forms!PCGForm.Taxyear = "" Then
        
            'MsgBox "Tax Year not set.", 48, "Information"
            ' Close both references.
            'DataTableClone.Close
            'DataTable.Close
            'DB.Close

            'b2000NICalc = False
            'GoTo Exit_b2000NICalc
    
    'End If

    
    ' If no records at all, then quit.
    ' Carry out the calculations
    If DataTable.BOF And DataTable.EOF Then
        
            MsgBox "No entries in table.", 48, "Information"
            ' Close both references.
            DataTableClone.Close
            DataTable.Close
            DB.Close

            b2000NICalc = False
            GoTo Exit_b2000NICalc
    
    End If
    
    DataTable.MoveFirst
    Do Until DataTable.EOF
        If ((DataTable![Period] = "M") And (DataTable![Period Number] > 12)) Or ((DataTable![Period] = "W") And (DataTable![Period Number] > 53)) Or ((DataTable![Period] = "4W") And (DataTable![Period Number] > 13)) Then
            MsgBox IIf(DataTable![Period] = "M", "Month", IIf(DataTable![Period] = "4W", "4 Weekly", "Week")) & " number out of range", 48, "Information"
            DataTableClone.Close
            DataTable.Close
            DB.Close

            b2000NICalc = False
            GoTo Exit_b2000NICalc
        End If
        If IsNull(DataTable![Category]) Or DataTable![Category] = "" Then
            MsgBox "Category not set", 48, "Information"
            DataTableClone.Close
            DataTable.Close
            DB.Close

            b2000NICalc = False
            GoTo Exit_b2000NICalc
        End If
        DataTable.MoveNext
    Loop

    DataTable.MoveLast
    Do Until DataTable.EOF Or DataTable.BOF

        ' Use the index to locate the year.
        NIRateBandTable.Index = "PrimaryKey"
        NIRateBandTable.Seek "=", Taxyear
        
        With NIRateBandTable
        ' If the year is not found.
            If .NoMatch Then
            
                
                Exit Function
            
            Else
            
                Select Case UCase$(DataTable![Period])
            
                Case "W"
                    
                    ' Set the global bands.
                    LEL = ![WkLEL]
                    EE_ET = ![WkEE_ET]
                    ER_ET = ![WkER_ET]
                    UEL = ![WkUEL]
    
                        stepincrement = 1
            
                Case "M"
            
                    ' Set the global bands.
    
                     LEL = ![MnthLEL]
                     EE_ET = ![MnthEE_ET]
                     ER_ET = ![MnthER_ET]
                     UEL = ![MnthUEL]
            
                        stepincrement = 4
            
                Case "4W"
                    If DataTable![Tables Used] = "no" Then
                        
                        ' Set the global bands.
                        LEL = ![AnnLEL] / 13
                        EE_ET = ![AnnEE_ET] / 13
                        ER_ET = ![AnnER_ET] / 13
                        UEL = ![AnnUEL] / 13
    
                          'No stepincrement as weekly rate is used in "tables" method
                        'Round up ER_ET
                         If ER_ET > Int(ER_ET) Then
                            ER_ET = Int(ER_ET) + 1
                         End If
                    
                    Else
    
                        LEL = ![WkLEL]
                        EE_ET = ![WkEE_ET]
                        ER_ET = ![WkER_ET]
                        UEL = ![WkUEL]
    
                    End If
            
                Case Else
            
                    
                    Exit Function
                    
                End Select
                    
            End If
        End With

        ' If '4W' then process AS 4 'W's (for Tables = Yes only)
        If DataTable![Period] = "4W" And DataTable![Tables Used] = "Yes" Then


            ' Insert duplicate Ws ( 4xNo4Ws ), at bottom of the table
            With DataTableClone
                .AddNew
                ![Period] = "W"
                ![Period Number] = (DataTable![Period Number] - 1) * 4 + 1
                ![Gross Pay] = Int(DataTable![Gross Pay] * 100 / 4) / 100
                ![Category] = DataTable![Category]
                ![Tables Used] = DataTable![Tables Used]
                .Update
            End With
            ' Add another 3 at the bottom of the file
            Dim i  As Integer
            For i = 1 To 3
                If bRepeatButton(Taxyear) = False Then
                    ' Unable to add, so delete inserted 4W
                    b2000NICalc = False
                    DataTableClone.MoveLast
                    DataTableClone.Delete
                    Forms!PCGForm.Recalc
                    GoTo Exit_b2000NICalc
                End If
            
            Next
            DoCmd.Hourglass True
    

            ' delete the original '4W' and go up to previous record
            DataTable.Delete
            DataTable.MovePrevious
    
            ' Set a bookmark to this new current record
            If Not DataTable.BOF Then
                strNextRecord = DataTable.Bookmark
            Else
                ' Bookmark cannot be set, as has reached the BOF
                strNextRecord = cstrAll_RECORDS_PROCESSED
            End If
    
    
            ' Update the 4 newly created 'W's, which will be at the bottom of the table
            With DataTable
                DataTable.MoveLast
                
                For i = 1 To 4
                    .Edit
                    ![UpToLEL] = GetUpToLEL([Taxyear], ![Tables Used], ![Period], ![Category], ![Gross Pay], LEL)
                    ![LELToEE_ET] = GetLELToEE_ET(![Tables Used], ![Period], ![Gross Pay], LEL, EE_ET)
                    ![EE_ETToER_ET] = GetEE_ETToER_ET(![Tables Used], ![Period], ![Gross Pay], EE_ET, ER_ET)
                    ![ER_ETToUEL] = GetER_ETToUEL(![Tables Used], ![Period], ![Gross Pay], ER_ET, UEL)
                    ![EEConts2000] = GetEEConts2000([Taxyear], ![Tables Used], ![Period], ![Period Number], ![Category], ![Gross Pay], LEL, EE_ET, ER_ET, UEL)
                    ![ERConts2000] = GetERConts2000([Taxyear], ![Tables Used], ![Period], ![Period Number], ![Category], ![Gross Pay], LEL, ER_ET, UEL)
                    ![TotalConts2000] = IIf(IsNull(![ERConts2000]), 0, (![ERConts2000])) + IIf(IsNull(![EEConts2000]), 0, (![EEConts2000]))
                    ![EENIRebate] = GetEENIRebate([Taxyear], ![Tables Used], ![Period], ![Period Number], ![Category], ![Gross Pay], LEL, EE_ET)
                    ![ERNIRebate] = GetERNIRebate([Taxyear], ![Tables Used], ![Period], ![Period Number], ![Category], ![Gross Pay], LEL, EE_ET, ER_ET)
                    If ![EEConts2000] <= ![EENIRebate] Then
                        ![ERNIRebate] = ![ERNIRebate] + ![EENIRebate] - ![EEConts2000]
                        ![EENIRebate] = ![EEConts2000]
                    End If
                    If ![EEConts2000] = 0 Then
                        ![ERNIRebate] = ![ERNIRebate] + ![EENIRebate]
                    End If
                    .Update
                    .MovePrevious
                Next
                .MoveNext
            End With
            ' Insert 4W to replace the 4 'W's
            With DataTableClone
                .AddNew
                ![Period] = "4W"
                ![Period Number] = (DataTable![Period Number] - 1) / 4 + 1
                ![Category] = DataTable![Category]
                ![Tables Used] = DataTable![Tables Used]
                
                ![Gross Pay] = 0
                ![UpToLEL] = 0
                ![LELToEE_ET] = 0
                ![EE_ETToER_ET] = 0
                ![ER_ETToUEL] = 0
                ![EEConts2000] = 0
                ![ERConts2000] = 0
                ![TotalConts2000] = 0
                ![EENIRebate] = 0
                ![ERNIRebate] = 0
                ' Update 4W and delete its 4 'W's
                For i = 1 To 4
                    ![Gross Pay] = ![Gross Pay] + DataTable![Gross Pay]
                    ![UpToLEL] = ![UpToLEL] + DataTable![UpToLEL]
                    ![LELToEE_ET] = ![LELToEE_ET] + DataTable![LELToEE_ET]
                    ![EE_ETToER_ET] = ![EE_ETToER_ET] + DataTable![EE_ETToER_ET]
                    ![ER_ETToUEL] = ![ER_ETToUEL] + DataTable![ER_ETToUEL]
                    ![EEConts2000] = ![EEConts2000] + DataTable![EEConts2000]
                    ![ERConts2000] = ![ERConts2000] + DataTable![ERConts2000]
                    ![TotalConts2000] = ![TotalConts2000] + DataTable![TotalConts2000]
                    ![EENIRebate] = ![EENIRebate] + DataTable![EENIRebate]
                    ![ERNIRebate] = ![ERNIRebate] + DataTable![ERNIRebate]
                    DataTable.Delete
                    DataTable.MoveNext
                Next
                .Update
            End With
            ' Set the current record to the previouly saved bookmark
            If Not strNextRecord = cstrAll_RECORDS_PROCESSED Then
                DataTable.Bookmark = strNextRecord
            End If
       
        Else

            ' W or M period and 4w "no" tables
            ' Update table entries
            With DataTable
                .Edit
                    ![UpToLEL] = GetUpToLEL([Taxyear], ![Tables Used], ![Period], ![Category], ![Gross Pay], LEL)
                    ![LELToEE_ET] = GetLELToEE_ET(![Tables Used], ![Period], ![Gross Pay], LEL, EE_ET)
                    ![EE_ETToER_ET] = GetEE_ETToER_ET(![Tables Used], ![Period], ![Gross Pay], EE_ET, ER_ET)
                    ![ER_ETToUEL] = GetER_ETToUEL(![Tables Used], ![Period], ![Gross Pay], ER_ET, UEL)
                    ![EEConts2000] = GetEEConts2000([Taxyear], ![Tables Used], ![Period], ![Period Number], ![Category], ![Gross Pay], LEL, EE_ET, ER_ET, UEL)
                    ![ERConts2000] = GetERConts2000([Taxyear], ![Tables Used], ![Period], ![Period Number], ![Category], ![Gross Pay], LEL, ER_ET, UEL)
                    ![TotalConts2000] = IIf(IsNull(![ERConts2000]), 0, CCur(![ERConts2000])) + IIf(IsNull(![EEConts2000]), 0, CCur(![EEConts2000]))
                    ![EENIRebate] = GetEENIRebate([Taxyear], ![Tables Used], ![Period], ![Period Number], ![Category], ![Gross Pay], LEL, EE_ET)
                    ![ERNIRebate] = GetERNIRebate([Taxyear], ![Tables Used], ![Period], ![Period Number], ![Category], ![Gross Pay], LEL, EE_ET, ER_ET)
                    If ![EEConts2000] <= ![EENIRebate] Then
                        ![ERNIRebate] = ![ERNIRebate] + ![EENIRebate] - ![EEConts2000]
                        ![EENIRebate] = ![EEConts2000]
                    End If
                    If ![EEConts2000] = 0 Then
                        ![ERNIRebate] = ![ERNIRebate] + ![EENIRebate]
                    End If
                    .Update
            End With
            
            ' Copy to record at the bottom of the table
            With DataTableClone
                .AddNew
                
                ![Period] = DataTable![Period]
                ![Period Number] = DataTable![Period Number]
                ![Category] = DataTable![Category]
                ![Gross Pay] = DataTable![Gross Pay]
                ![Tables Used] = DataTable![Tables Used]
                
                ![UpToLEL] = DataTable![UpToLEL]
                ![LELToEE_ET] = DataTable![LELToEE_ET]
                ![EE_ETToER_ET] = DataTable![EE_ETToER_ET]
                ![ER_ETToUEL] = DataTable![ER_ETToUEL]
                ![EEConts2000] = DataTable![EEConts2000]
                ![ERConts2000] = DataTable![ERConts2000]
                ![TotalConts2000] = DataTable![TotalConts2000]
                ![EENIRebate] = DataTable![EENIRebate]
                ![ERNIRebate] = DataTable![ERNIRebate]
                
                .Update
            End With
            ' Remove the original record W or M
            DataTable.Delete
            DataTable.MovePrevious
        End If

    Loop


    ' Put back records in correct order
    DataTable.MoveLast
    Do Until DataTable.BOF
        With DataTableClone
            .AddNew
            
            ![Period] = DataTable![Period]
            ![Period Number] = DataTable![Period Number]
            ![Category] = DataTable![Category]
            ![Gross Pay] = DataTable![Gross Pay]
            ![Tables Used] = DataTable![Tables Used]
            
            ![UpToLEL] = DataTable![UpToLEL]
            ![LELToEE_ET] = DataTable![LELToEE_ET]
            ![EE_ETToER_ET] = DataTable![EE_ETToER_ET]
            ![ER_ETToUEL] = DataTable![ER_ETToUEL]
            ![EEConts2000] = DataTable![EEConts2000]
            ![ERConts2000] = DataTable![ERConts2000]
            ![TotalConts2000] = DataTable![TotalConts2000]
            ![EENIRebate] = DataTable![EENIRebate]
            ![ERNIRebate] = DataTable![ERNIRebate]
            
            .Update
        End With
        DataTable.Delete
        DataTable.MovePrevious
    Loop



    ' Close both references.
    DataTableClone.Close
    DataTable.Close
    DB.Close
    
    
    ' Update subform
    'Forms!PCGForm.Recalc
    
    calcTotals_01
 
Exit_b2000NICalc:
    DoCmd.Hourglass False
    PrevControl.SetFocus
    Exit Function

Err_b2000NICalc:
    DoCmd.Hourglass False
    MsgBox Error$
    Resume Exit_b2000NICalc



End Function




